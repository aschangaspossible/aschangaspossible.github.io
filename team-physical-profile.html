<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥•æ™‰ç¶²çƒå­¸é™¢ï½œå…¨éšŠé«”èƒ½å„€è¡¨æ¿ï¼ˆåŒ¿å/å»æ¯”è¼ƒåŒ–ï¼‰</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#071024;
      --card:#0b1226;
      --card2:#0b1a2f;
      --line:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --sub:#94a3b8;
      --muted:#64748b;
      --good:#22c55e;
      --warn:#facc15;
      --bad:#f87171;
      --blue:#38bdf8;
      --radius:18px;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(34,197,94,.18) 0, transparent 55%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 62%);
      min-height:100vh;
    }
    .wrap{
      max-width: 1180px;
      margin: 22px auto 60px;
      padding: 0 14px;
    }
    .topbar{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(10,18,38,.92), rgba(6,10,20,.92));
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 15% 0, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 85% 0, rgba(34,197,94,.22), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .topbar-inner{
      position:relative;
      padding: 16px 16px 14px;
    }
    .brand{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin-bottom: 12px;
    }
    .brand-left{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:38px; height:38px; border-radius:999px;
      border:2px solid rgba(34,197,94,.85);
      box-shadow: 0 0 24px rgba(34,197,94,.5);
      object-fit:cover;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }
    .brand-title{display:flex; flex-direction:column; gap:2px;}
    .brand-title b{font-size: 16px; letter-spacing:.12em;}
    .brand-title span{font-size: 12px; color: var(--sub); line-height:1.55;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.55);
      color: var(--sub);
      font-size: 12px;
      white-space: nowrap;
      height: fit-content;
    }
    .pill .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 12px var(--good);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding-top: 6px;
    }
    label{ color: var(--sub); font-size: 13px; }
    select{
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--text);
      outline:none;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--sub);
      cursor:pointer;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(248,250,252,.65); color: var(--text); }
    .btn-primary{
      border: none;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(56,189,248,.95));
      color:#021018;
      font-weight: 800;
      box-shadow: 0 14px 40px rgba(34,197,94,.25);
    }
    .status{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(6,10,20,.92));
      box-shadow: 0 18px 52px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card-h{
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(148,163,184,.16);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{
      font-size: 13px;
      letter-spacing:.16em;
      color: rgba(226,232,240,.92);
      text-transform: uppercase;
    }
    .card-h span{
      font-size: 12px;
      color: var(--muted);
    }
    .card-b{ padding: 14px 16px 16px; }

    .muted{ color: var(--sub); font-size: 12px; line-height:1.65; }

    .two-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .radar-wrap{ height: 360px; padding: 8px 6px 0; }
    .chart-wrap{ height: 320px; }
    .mini{ font-size:12px; color: var(--muted); line-height:1.75; }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .kpi{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .t{ font-size:12px; color: var(--sub); }
    .kpi .v{ font-size:18px; font-weight:900; margin-top:6px; letter-spacing:.04em; }
    .kpi .s{ font-size:12px; color: var(--muted); margin-top:4px; line-height:1.55; }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
    }
    .table th,.table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      text-align:right;
      color: rgba(226,232,240,.9);
      white-space: nowrap;
    }
    .table th:first-child,.table td:first-child{ text-align:left; white-space: normal; width: 30%; }
    .table thead th{ color: rgba(226,232,240,.8); font-weight: 700; background: rgba(2,6,23,.35); }

    .tagpill{
      display:inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    .tagpill.good{ border-color: rgba(34,197,94,.55); color:#bbf7d0; }
    .tagpill.mid{ border-color: rgba(250,204,21,.55); color:#fde68a; }
    .tagpill.bad{ border-color: rgba(248,113,113,.55); color:#fecaca; }

    .note{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px;
      line-height:1.75;
      color: rgba(226,232,240,.88);
      font-size: 13px;
    }
    .note b{ color: #bbf7d0; }
    .hr{ height:1px; background: rgba(148,163,184,.16); margin: 10px 0; }

    @media (max-width: 980px){
      .two-cols{ grid-template-columns: 1fr; }
      .kpi-row{ grid-template-columns: 1fr 1fr; }
      .status{ width:100%; margin-left:0; }
    }
    @media (max-width: 520px){
      .kpi-row{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-left">
            <img class="logo" src="https://aschangaspossible.github.io/logo.jpeg" alt="logo" />
            <div class="brand-title">
              <b>å¥•æ™‰ç¶²çƒå­¸é™¢ï½œå…¨éšŠé«”èƒ½å„€è¡¨æ¿</b>
              <span>åŒ¿åï¼ˆä¸å«ä»»ä½•å€‹äººè³‡æ–™ï¼‰ï½œåªçœ‹ã€Œå…¨éšŠè¼ªå»“ã€èˆ‡ã€Œåˆ†å¸ƒã€ï½œ0â€“100ï¼š50=åŒç´šå¹³å‡ï¼ˆåŒçµ„=æ€§åˆ¥Ã—åˆ†ç´šï¼‰</span>
            </div>
          </div>
          <div class="pill"><span class="dot"></span><span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°</span></div>
        </div>

        <div class="controls">
          <button class="btn" id="reloadBtn">ğŸ”„ é‡æ–°è¼‰å…¥</button>

          <label for="groupSelect">æŸ¥çœ‹çµ„åˆ¥ï¼š</label>
          <select id="groupSelect" disabled>
            <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
          </select>

          <button class="btn btn-primary" id="viewAllBtn">ğŸ‘¥ å…¨éšŠï¼ˆå…¨éƒ¨ï¼‰</button>

          <span class="status" id="statusMsg">â€”</span>
        </div>

        <div class="note" style="margin-top:12px">
          <b>ä½¿ç”¨èªªæ˜ï¼ˆå»æ¯”è¼ƒåŒ–ï¼‰</b><br/>
          1) é€™é ä¸å‘ˆç¾ä»»ä½•å€‹äººæ’åæˆ–å€‹äººæ•¸æ“šï¼Œé¿å…è½å…¥æ¯”è¼ƒå¿ƒæ…‹ã€‚<br/>
          2) æˆ‘å€‘åªçœ‹ã€Œå…¨éšŠçµæ§‹ã€ï¼šå¹³å‡ç·šã€åˆ†å¸ƒã€å„ªå…ˆæ”¹å–„æ–¹å‘ã€‚<br/>
          3) çµ„åˆ¥äººæ•¸ <b>å°‘æ–¼ 5 äºº</b> æœƒè‡ªå‹•éš±è—ï¼ˆéš±ç§ä¿è­·ï¼šé¿å…è¢«æ¨æ¸¬æ˜¯èª°ï¼‰ã€‚<br/>
          <div class="hr"></div>
          <span class="mini">åˆ†æ•¸è½‰æ›ï¼šScore = clamp(50 + ZÃ—15)ï¼ŒZ ç”±åŒçµ„ï¼ˆæ€§åˆ¥Ã—åˆ†ç´šï¼‰å¹³å‡èˆ‡ SD è¨ˆç®—ï¼ˆé€Ÿåº¦/æ•æ·ç­‰ã€Œè¶Šå°è¶Šå¥½ã€å·²åå‘è™•ç†ï¼‰ã€‚</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <b>TEAM SNAPSHOT</b>
          <span id="scopeText">ç¯„åœï¼šå…¨éšŠ</span>
        </div>
        <div class="card-b">
          <div class="kpi-row">
            <div class="kpi">
              <div class="t">æœ‰æ•ˆæ¨£æœ¬æ•¸</div>
              <div class="v" id="kpiN">â€”</div>
              <div class="s">æœ‰åƒèˆ‡æª¢æ¸¬ä¸”å¯è¨ˆç®— Z çš„äººæ•¸</div>
            </div>
            <div class="kpi">
              <div class="t">å„ªå‹¢é¢ï¼ˆå…¨éšŠï¼‰</div>
              <div class="v" id="kpiBest">â€”</div>
              <div class="s">å¹³å‡åˆ†æ•¸æœ€é«˜çš„æŒ‡æ¨™</div>
            </div>
            <div class="kpi">
              <div class="t">å„ªå…ˆè£œå¼·ï¼ˆå…¨éšŠï¼‰</div>
              <div class="v" id="kpiWeak">â€”</div>
              <div class="s">å¹³å‡åˆ†æ•¸æœ€ä½çš„æŒ‡æ¨™</div>
            </div>
            <div class="kpi">
              <div class="t">æ•´é«”ç‹€æ…‹</div>
              <div class="v" id="kpiMood">â€”</div>
              <div class="s">çœ‹åˆ†å¸ƒï¼Œè€Œä¸æ˜¯çœ‹åæ¬¡</div>
            </div>
          </div>
        </div>
      </div>

      <div class="two-cols">
        <div class="card">
          <div class="card-h">
            <b>8 å¤§æŒ‡æ¨™ï½œå…¨éšŠå¹³å‡é›·é”åœ–</b>
            <span>è—=å…¨éšŠå¹³å‡ï½œç°=åŒç´šå¹³å‡ 50</span>
          </div>
          <div class="card-b">
            <div class="radar-wrap">
              <canvas id="teamRadar"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <b>åˆ†å¸ƒåœ–ï½œå¼·/ä¸­/å¼±äººæ•¸</b>
            <span>ç¶ (>55)ï½œé»ƒ(45â€“55)ï½œç´…(<45)</span>
          </div>
          <div class="card-b">
            <div class="chart-wrap">
              <canvas id="distChart"></canvas>
            </div>
            <div class="mini" style="margin-top:8px">
              é€™å¼µåœ–çš„ç›®çš„æ˜¯ï¼šè®“æ•™ç·´å¿«é€ŸçŸ¥é“ã€Œå“ªå¹¾é …æ˜¯å…¨éšŠå…±åŒå¼±é …ã€ï¼Œå®‰æ’åœ˜éšŠè¨“ç·´è³‡æºã€‚ä¸æ˜¯è®“çƒå“¡äº’ç›¸æ¯”ã€‚
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <b>8 å¤§æŒ‡æ¨™ï½œå…¨éšŠæ‘˜è¦è¡¨</b>
          <span>å¹³å‡åˆ† / åˆ†å¸ƒ / å»ºè­°</span>
        </div>
        <div class="card-b">
          <table class="table">
            <thead>
              <tr>
                <th>æŒ‡æ¨™</th>
                <th>å¹³å‡åˆ†</th>
                <th>ç¶ (>55)</th>
                <th>é»ƒ(45â€“55)</th>
                <th>ç´…(<45)</th>
                <th>åˆ¤è®€</th>
              </tr>
            </thead>
            <tbody id="axisTable"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <b>çµ„åˆ¥æ‘˜è¦ï¼ˆéš±ç§ä¿è­·ï¼‰</b>
          <span>åªé¡¯ç¤ºäººæ•¸ â‰¥ 5 çš„çµ„åˆ¥</span>
        </div>
        <div class="card-b">
          <div class="mini" style="margin-bottom:10px">
            çµ„åˆ¥æ‘˜è¦ç”¨ä¾†è®“æ•™ç·´çœ‹ã€Œä¸åŒçµ„åˆ¥è³‡æºæ€éº¼åˆ†é…ã€ï¼Œä¸æ˜¯æ‹¿ä¾†è²¼æ¨™ç±¤ã€‚äººæ•¸å¤ªå°‘çš„çµ„åˆ¥æœƒè‡ªå‹•éš±è—ã€‚
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>çµ„åˆ¥ï¼ˆæ€§åˆ¥Ã—åˆ†ç´šï¼‰</th>
                <th>äººæ•¸</th>
                <th>å„ªå‹¢é¢</th>
                <th>è£œå¼·é¢</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody id="groupTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

<script>
  // ==============================
  // 0) ä½ çš„è©¦ç®—è¡¨è¨­å®šï¼ˆè¦æ”¹ï¼‰
  // ==============================
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests: "æª¢æ¸¬æˆç¸¾"
  };

  // éš±ç§ä¿è­·é–€æª»ï¼šçµ„åˆ¥è‡³å°‘å¹¾äººæ‰èƒ½é¡¯ç¤º
  const K_ANON = 5;

  // ==============================
  // 1) æ¬„ä½è¾¨è­˜ï¼ˆå®¹éŒ¯ï¼‰
  // ==============================
  const COL = {
    name: ["å§“å"],
    sex:  ["æ€§åˆ¥"],
    level:["åˆ†ç´š","å¹´ç´š","å¹´é½¡"],
    date:["æœ€æ–°æª¢æ¸¬æ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ","æª¢æ¸¬æ—¥æœŸ"],

    deadlift:["ç¡¬æ‹‰(kg)","ç¡¬æ‹‰","Deadlift","Deadlift(kg)"],

    imtp:["IMTP(N)","IMTP","IMTP (RFD 200ms)","IMTP(RFD200ms)","IMTP RFD","RFD","IMTP(N) "],
    cmj:["CMJ(cm)","CMJ","å‚ç›´è·³(cm)","å‚ç›´è·³","Vertical Jump","VerticalJump"],
    broad:["ç«‹å®šè·³(m)","ç«‹å®šè·³","Broad jump (m)","Broad jump","BroadJump","Broad Jump"],
    lateralL:["å´å‘è·³(å·¦)(m)","å´å‘è·³(å·¦)","Lateral jump (L)","LateralJumpL","å´å‘è·³(å·¦)(cm)"],
    lateralR:["å´å‘è·³(å³)(m)","å´å‘è·³(å³)","Lateral jump (R)","LateralJumpR","å´å‘è·³(å³)(cm)"],

    invRow:["åå‘åˆ’èˆ¹(æ¬¡æ•¸)","Inverted row(æ¬¡æ•¸)","Inverted row","Inverted Rows","åå‘åˆ’èˆ¹"],
    pushup:["ä¿¯è‡¥æ’(æ¬¡æ•¸)","Push up(æ¬¡æ•¸)","Push-ups(æ¬¡æ•¸)","Push up","Push-ups","ä¿¯è‡¥æ’"],
    grip:["æ¡åŠ›(kg)","æ¡åŠ›","Grip strength(kg)","Grip strength","Grip"],
    plank:["å¹³æ¿æ’(ç§’)","å¹³æ¿æ’","Plank(æ™‚é–“)","Plank","Plank(s)","å¹³æ¿æ’(æ™‚é–“)"],

    sohm:["ç«™å§¿éé ­æ‹‹","ç«™å§¿éé ­æ‹‹(è·é›¢)","Standing OH MB Throw"],
    kohm:["æ™šå§¿éé ­æ‹‹","è·ªå§¿éé ­æ‹‹","Kneeling OH MB Throw"],
    shmb:["ç«™å§¿æ°´å¹³æ‹‹","Standing Horizontal MB Throw"],
    khmb:["æ™šå§¿æ°´å¹³æ‹‹","è·ªå§¿æ°´å¹³æ‹‹","Kneeling Horizontal MB Throw"],

    sprint10:["10ç±³è¡åˆº(ç§’)","10m sprint","10m Sprint","10m"],
    sprint20:["20ç±³è¡åˆº(ç§’)","20m sprint","20m Sprint","20m"],

    t505L:["505æ•æ·è·‘(å·¦)(ç§’)","505æ•æ·è·‘(å·¦)","505å·¦","505 L","505 (L)"],
    t505R:["505æ•æ·è·‘(å³)(ç§’)","505æ•æ·è·‘(å³)","505å³","505 R","505 (R)"],
    spider:["èœ˜è››è·‘(ç§’)","èœ˜è››è·‘","Spider test(ç§’)","Spider test","Spider"],
    hop:["Hop test(m/s)","Hop test","Hop"],

    react:["åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸)","åæ‡‰ç‡ˆæ¸¬è©¦","åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸) ","Reaction(æ¬¡æ•¸)","Reaction"]
  };

  function isLowerBetterMetric(label){
    const s = String(label || "");
    return (
      s.includes("ç§’") ||
      /sprint/i.test(s) ||
      s.includes("505") ||
      s.includes("èœ˜è››") ||
      s.includes("Spider")
    );
  }

  // ==============================
  // 2) åŠ æ¬Šè¨­å®šï¼ˆæ²¿ç”¨ä½ æ—¢æœ‰çš„å…«å¤§æŒ‡æ¨™ï¼‰
  // ==============================
  const WEIGHTS = {
    lowerStrength: { deadlift: 1.00 },
    lowerPower: { imtp: .35, cmj: .25, broad: .25, lateral: .15 },
    upperStrength: { invRow: .30, pushup: .30, grip: .25, plank: .15 },
    upperPower: { sohm: .30, kohm: .20, shmb: .30, khmb: .20 },
    speed: { sprint10: .60, sprint20: .40 },
    changeDir: { t505: .45, spider: .35, hop: .20 },
    reaction: { react: 1.00 },
    metabolic: { placeholder: 1.00 } // ç›®å‰ä¸ç®—ï¼Œé¡¯ç¤ºå›ºå®š 50
  };

  const RADAR_AXES = [
    { key:"lowerStrength", label:"ä¸‹è‚¢è‚ŒåŠ›" },
    { key:"lowerPower",    label:"ä¸‹è‚¢çˆ†ç™¼åŠ›" },
    { key:"upperStrength", label:"ä¸Šè‚¢è‚ŒåŠ›" },
    { key:"upperPower",    label:"ä¸Šè‚¢çˆ†ç™¼åŠ›" },
    { key:"speed",         label:"é€Ÿåº¦" },
    { key:"changeDir",     label:"è®Šå‘èƒ½åŠ›" },
    { key:"reaction",      label:"åæ‡‰" },
    { key:"metabolic",     label:"ä»£è¬èƒ½åŠ›" }
  ];

  function zToScore(z){
    if (z == null || isNaN(z)) return 50;
    const v = 50 + z * 15;
    return Math.max(0, Math.min(100, v));
  }

  // ==============================
  // 3) è®€ Sheet
  // ==============================
  function csvUrlForSheet(sheetName){
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }
  function loadSheet(sheetName){
    return new Promise((resolve,reject)=>{
      Papa.parse(csvUrlForSheet(sheetName),{
        download:true,
        header:true,
        complete:r=>resolve(r.data || []),
        error:reject
      });
    });
  }
  function getVal(row, keys){
    for (const k of keys){
      if (row && row[k] != null && String(row[k]).trim() !== "") return row[k];
    }
    return "";
  }
  function toNum(v){
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return isNaN(n) ? null : n;
  }
  function groupKeyOf(playerRow, testRow){
    const sex = (getVal(playerRow, COL.sex) || getVal(testRow, COL.sex) || "").trim() || "-";
    const level = (getVal(playerRow, COL.level) || getVal(testRow, COL.level) || "").trim() || "-";
    return `${sex}|${level}`;
  }

  // ==============================
  // 4) å»º groupStatsï¼ˆåŒçµ„å¹³å‡/SDï¼‰
  // ==============================
  let playersByName = new Map();
  let testsArray = [];
  let testsByName = new Map();
  let groupStats = new Map();

  function buildGroupStats(){
    const bucket = new Map();
    testsArray.forEach(row=>{
      const name = String(getVal(row, COL.name) || "").trim();
      if(!name) return;
      const playerRow = playersByName.get(name) || {};
      const gk = groupKeyOf(playerRow, row);
      if(!bucket.has(gk)) bucket.set(gk, new Map());
      const m = bucket.get(gk);

      Object.keys(row).forEach(k=>{
        if(!k) return;
        if (COL.name.includes(k) || COL.sex.includes(k) || COL.level.includes(k) || COL.date.includes(k)) return;
        const v = toNum(row[k]);
        if(v == null) return;
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(v);
      });
    });

    groupStats = new Map();
    bucket.forEach((m,gk)=>{
      const stat = {};
      m.forEach((arr,metricName)=>{
        if(!arr.length) return;
        const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
        const variance = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length;
        const sd = Math.sqrt(variance);
        stat[metricName] = { mean, sd, n: arr.length };
      });
      groupStats.set(gk, stat);
    });
  }

  function pickMetric(row, keyList){
    for (const k of keyList){
      const v = toNum(row[k]);
      if(v != null) return { col: k, val: v };
    }
    return { col: null, val: null };
  }

  function zOfMetric(testRow, gk, colName, val){
    if(val == null || !colName) return null;
    const stats = groupStats.get(gk) || {};
    const s = stats[colName];
    if(!s || s.sd == null || s.sd === 0) return null;

    const lowerBetter = isLowerBetterMetric(colName);
    return lowerBetter ? (s.mean - val) / s.sd : (val - s.mean) / s.sd;
  }

  function wsum(pairs){
    let num = 0, den = 0;
    for(const [z,w] of pairs){
      if(z == null || isNaN(z)) continue;
      num += z*w;
      den += w;
    }
    return den ? (num/den) : null;
  }

  function calcCompositeZ(testRow, playerRow){
    const gk = groupKeyOf(playerRow, testRow);

    const deadlift = pickMetric(testRow, COL.deadlift);

    const imtp  = pickMetric(testRow, COL.imtp);
    const cmj   = pickMetric(testRow, COL.cmj);
    const broad = pickMetric(testRow, COL.broad);
    const latL  = pickMetric(testRow, COL.lateralL);
    const latR  = pickMetric(testRow, COL.lateralR);

    const lateralZ = (()=>{
      const zl = zOfMetric(testRow, gk, latL.col, latL.val);
      const zr = zOfMetric(testRow, gk, latR.col, latR.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    const invRow = pickMetric(testRow, COL.invRow);
    const pushup = pickMetric(testRow, COL.pushup);
    const grip   = pickMetric(testRow, COL.grip);
    const plank  = pickMetric(testRow, COL.plank);

    const sohm = pickMetric(testRow, COL.sohm);
    const kohm = pickMetric(testRow, COL.kohm);
    const shmb = pickMetric(testRow, COL.shmb);
    const khmb = pickMetric(testRow, COL.khmb);

    const s10 = pickMetric(testRow, COL.sprint10);
    const s20 = pickMetric(testRow, COL.sprint20);

    const t505L = pickMetric(testRow, COL.t505L);
    const t505R = pickMetric(testRow, COL.t505R);
    const spider = pickMetric(testRow, COL.spider);
    const hop = pickMetric(testRow, COL.hop);

    const react = pickMetric(testRow, COL.react);

    const z505 = (()=>{
      const zl = zOfMetric(testRow, gk, t505L.col, t505L.val);
      const zr = zOfMetric(testRow, gk, t505R.col, t505R.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    const z_deadlift = zOfMetric(testRow, gk, deadlift.col, deadlift.val);

    const z_imtp  = zOfMetric(testRow, gk, imtp.col,  imtp.val);
    const z_cmj   = zOfMetric(testRow, gk, cmj.col,   cmj.val);
    const z_broad = zOfMetric(testRow, gk, broad.col, broad.val);

    const z_invRow = zOfMetric(testRow, gk, invRow.col, invRow.val);
    const z_pushup = zOfMetric(testRow, gk, pushup.col, pushup.val);
    const z_grip   = zOfMetric(testRow, gk, grip.col,   grip.val);
    const z_plank  = zOfMetric(testRow, gk, plank.col,  plank.val);

    const z_sohm = zOfMetric(testRow, gk, sohm.col, sohm.val);
    const z_kohm = zOfMetric(testRow, gk, kohm.col, kohm.val);
    const z_shmb = zOfMetric(testRow, gk, shmb.col, shmb.val);
    const z_khmb = zOfMetric(testRow, gk, khmb.col, khmb.val);

    const z_s10 = zOfMetric(testRow, gk, s10.col, s10.val);
    const z_s20 = zOfMetric(testRow, gk, s20.col, s20.val);

    const z_spider = zOfMetric(testRow, gk, spider.col, spider.val);
    const z_hop    = zOfMetric(testRow, gk, hop.col, hop.val);

    const z_react = zOfMetric(testRow, gk, react.col, react.val);

    const z_lowerStrength = wsum([[z_deadlift, WEIGHTS.lowerStrength.deadlift]]);
    const z_lowerPower = wsum([
      [z_imtp,  WEIGHTS.lowerPower.imtp],
      [z_cmj,   WEIGHTS.lowerPower.cmj],
      [z_broad, WEIGHTS.lowerPower.broad],
      [lateralZ,WEIGHTS.lowerPower.lateral]
    ]);
    const z_upperStrength = wsum([
      [z_invRow, WEIGHTS.upperStrength.invRow],
      [z_pushup, WEIGHTS.upperStrength.pushup],
      [z_grip,   WEIGHTS.upperStrength.grip],
      [z_plank,  WEIGHTS.upperStrength.plank]
    ]);
    const z_upperPower = wsum([
      [z_sohm, WEIGHTS.upperPower.sohm],
      [z_kohm, WEIGHTS.upperPower.kohm],
      [z_shmb, WEIGHTS.upperPower.shmb],
      [z_khmb, WEIGHTS.upperPower.khmb]
    ]);
    const z_speed = wsum([
      [z_s10, WEIGHTS.speed.sprint10],
      [z_s20, WEIGHTS.speed.sprint20]
    ]);
    const z_changeDir = wsum([
      [z505,     WEIGHTS.changeDir.t505],
      [z_spider, WEIGHTS.changeDir.spider],
      [z_hop,    WEIGHTS.changeDir.hop]
    ]);
    const z_reaction = wsum([[z_react, WEIGHTS.reaction.react]]);
    const z_metabolic = null; // æœªæä¾›

    return {
      groupKey: gk,
      zByAxis: {
        lowerStrength: z_lowerStrength,
        lowerPower: z_lowerPower,
        upperStrength: z_upperStrength,
        upperPower: z_upperPower,
        speed: z_speed,
        changeDir: z_changeDir,
        reaction: z_reaction,
        metabolic: z_metabolic
      }
    };
  }

  // ==============================
  // 5) åŒ¿ååŒ–ï¼šçµ„åˆ¥æ¸…å–®ã€å…¨éšŠçµ±è¨ˆ
  // ==============================
  function mean(arr){
    const xs = arr.filter(x=>x!=null && !isNaN(x));
    if(!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0)/xs.length;
  }

  function tagOfScore(avgScore){
    if(avgScore == null) return `<span class="tagpill">â€”</span>`;
    if(avgScore >= 55) return `<span class="tagpill good">æ•´é«”åå¼·</span>`;
    if(avgScore <= 45) return `<span class="tagpill bad">æ•´é«”åå¼±</span>`;
    return `<span class="tagpill mid">æ¥è¿‘å¹³å‡</span>`;
  }

  function distBucket(score){
    if(score == null || isNaN(score)) return null;
    if(score > 55) return "good";
    if(score < 45) return "bad";
    return "mid";
  }

  // ==============================
  // 6) åœ–è¡¨æ¸²æŸ“
  // ==============================
  let radarChart = null;
  let distChart = null;

  function renderRadar(avgScores){
    const ctx = document.getElementById("teamRadar").getContext("2d");
    if(radarChart) radarChart.destroy();

    const labels = RADAR_AXES.map(a=>a.label);
    const dataAvg = RADAR_AXES.map(a=>avgScores[a.key] ?? 50);
    const avgLine = labels.map(_=>50);

    radarChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "å…¨éšŠå¹³å‡",
            data: dataAvg,
            borderColor: "rgba(56,189,248,.95)",
            backgroundColor: "rgba(56,189,248,.18)",
            pointBackgroundColor: "rgba(56,189,248,.95)",
            pointRadius: 3,
            borderWidth: 2
          },
          {
            label: "åŒç´šå¹³å‡ï¼ˆå›ºå®š 50ï¼‰",
            data: avgLine,
            borderColor: "rgba(148,163,184,.55)",
            backgroundColor: "rgba(148,163,184,.06)",
            pointRadius: 0,
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ labels:{ color:"#cbd5e1", boxWidth:18, font:{ size: 12 } } }
        },
        scales:{
          r:{
            min:0, max:100,
            ticks:{ color:"#94a3b8", backdropColor:"transparent", stepSize:10, font:{ size: 10 } },
            grid:{ color:"rgba(148,163,184,.16)" },
            angleLines:{ color:"rgba(148,163,184,.14)" },
            pointLabels:{ color:"#e2e8f0", font:{ size: 12 } }
          }
        }
      }
    });
  }

  function renderDistribution(distByAxis){
    const ctx = document.getElementById("distChart").getContext("2d");
    if(distChart) distChart.destroy();

    const labels = RADAR_AXES.map(a=>a.label);
    const good = RADAR_AXES.map(a=>distByAxis[a.key]?.good ?? 0);
    const mid  = RADAR_AXES.map(a=>distByAxis[a.key]?.mid  ?? 0);
    const bad  = RADAR_AXES.map(a=>distByAxis[a.key]?.bad  ?? 0);

    distChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "ç¶ (>55)", data: good, backgroundColor: "rgba(34,197,94,.78)", stack: "s" },
          { label: "é»ƒ(45â€“55)", data: mid, backgroundColor: "rgba(250,204,21,.72)", stack: "s" },
          { label: "ç´…(<45)", data: bad, backgroundColor: "rgba(248,113,113,.75)", stack: "s" }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#cbd5e1", font:{ size: 12 } } } },
        scales:{
          x:{ stacked:true, ticks:{ color:"#cbd5e1", font:{ size: 11 } }, grid:{ display:false } },
          y:{ stacked:true, ticks:{ color:"#94a3b8", font:{ size: 11 } }, grid:{ color:"rgba(148,163,184,.14)" } }
        }
      }
    });
  }

  // ==============================
  // 7) è¨ˆç®—å…¨éšŠ/çµ„åˆ¥çµ±è¨ˆï¼ˆä¸è¼¸å‡ºä»»ä½•å€‹äººï¼‰
  // ==============================
  function computeScopeStats(scopeGroupKey=null){
    // è’é›†æ¯ä½çƒå“¡çš„ 8 è»¸åˆ†æ•¸ï¼ˆåŒ¿åï¼Œä¸ç•™å§“åï¼‰
    const scoreRows = [];

    testsByName.forEach((testRow, name)=>{
      const playerRow = playersByName.get(name) || {};
      const comp = calcCompositeZ(testRow, playerRow);
      const gk = comp.groupKey;

      if(scopeGroupKey && gk !== scopeGroupKey) return;

      const axisScores = {};
      let okCount = 0;

      for(const a of RADAR_AXES){
        const z = comp.zByAxis[a.key];
        const s = zToScore(z);
        axisScores[a.key] = s;
        if(z != null && !isNaN(z)) okCount++;
      }

      // è‡³å°‘è¦æœ‰ 3 è»¸å¯ç®—ï¼Œæ‰ç®—æœ‰æ•ˆæ¨£æœ¬ï¼ˆé¿å…å™ªéŸ³ï¼‰
      if(okCount >= 3){
        scoreRows.push({ groupKey: gk, scores: axisScores });
      }
    });

    // å¹³å‡åˆ†
    const avgScores = {};
    for(const a of RADAR_AXES){
      avgScores[a.key] = mean(scoreRows.map(r=>r.scores[a.key]));
    }

    // åˆ†å¸ƒï¼ˆgood/mid/badï¼‰
    const distByAxis = {};
    for(const a of RADAR_AXES){
      distByAxis[a.key] = { good:0, mid:0, bad:0 };
      scoreRows.forEach(r=>{
        const b = distBucket(r.scores[a.key]);
        if(!b) return;
        distByAxis[a.key][b]++;
      });
    }

    // æ‰¾å¼·/å¼±ï¼ˆä¾å¹³å‡ï¼‰
    const axisList = RADAR_AXES
      .map(a=>({key:a.key, label:a.label, avg: avgScores[a.key]}))
      .filter(x=>x.avg!=null && !isNaN(x.avg))
      .sort((a,b)=>b.avg-a.avg);

    const best = axisList[0];
    const weak = axisList[axisList.length-1];

    // moodï¼šçœ‹ã€Œç´…çš„æ¯”ä¾‹ã€
    const totalN = scoreRows.length;
    let redTotal = 0, cellTotal = 0;
    for(const a of RADAR_AXES){
      const d = distByAxis[a.key];
      redTotal += (d.bad || 0);
      cellTotal += ((d.good||0)+(d.mid||0)+(d.bad||0));
    }
    const redRate = cellTotal ? (redTotal / cellTotal) : 0;
    let mood = "ç©©å®šç™¼å±•";
    if(redRate > 0.28) mood = "å„ªå…ˆè£œå¼·æœŸ";
    if(redRate < 0.12) mood = "ç¶­æŒï¼‹é€²éšæœŸ";

    return { totalN, avgScores, distByAxis, best, weak, mood, scoreRows };
  }

  // çµ„åˆ¥åˆ—è¡¨ï¼ˆåªé¡¯ç¤º n>=K_ANONï¼‰
  function buildGroupOptions(){
    const counts = new Map();
    testsByName.forEach((testRow, name)=>{
      const playerRow = playersByName.get(name) || {};
      const gk = groupKeyOf(playerRow, testRow);
      counts.set(gk, (counts.get(gk)||0) + 1);
    });

    // åªç•™ä¸‹å¯é¡¯ç¤ºçš„çµ„åˆ¥
    const eligible = Array.from(counts.entries())
      .filter(([gk,n])=>n >= K_ANON)
      .sort((a,b)=>b[1]-a[1]);

    const sel = document.getElementById("groupSelect");
    sel.innerHTML = `<option value="">â€” åªçœ‹å…¨éšŠï¼ˆé è¨­ï¼‰â€”</option>`;
    eligible.forEach(([gk,n])=>{
      const [sex, level] = gk.split("|");
      const op = document.createElement("option");
      op.value = gk;
      op.textContent = `${sex}ãƒ»${level}ï¼ˆ${n}äººï¼‰`;
      sel.appendChild(op);
    });

    sel.disabled = false;
  }

  function renderAxisTable(avgScores, distByAxis){
    const tbody = document.getElementById("axisTable");
    tbody.innerHTML = RADAR_AXES.map(a=>{
      const avg = avgScores[a.key];
      const d = distByAxis[a.key] || {good:0,mid:0,bad:0};
      const verdict = tagOfScore(avg);
      return `
        <tr>
          <td>${a.label}</td>
          <td>${avg!=null ? avg.toFixed(1) : "â€”"}</td>
          <td>${d.good ?? 0}</td>
          <td>${d.mid ?? 0}</td>
          <td>${d.bad ?? 0}</td>
          <td>${verdict}</td>
        </tr>
      `;
    }).join("");
  }

  function axisLabel(key){
    return (RADAR_AXES.find(a=>a.key===key)?.label) || key;
  }

  function renderGroupTable(){
    const tbody = document.getElementById("groupTable");

    // counts
    const counts = new Map();
    testsByName.forEach((testRow, name)=>{
      const playerRow = playersByName.get(name) || {};
      const gk = groupKeyOf(playerRow, testRow);
      counts.set(gk, (counts.get(gk)||0) + 1);
    });

    // eligible
    const eligible = Array.from(counts.entries())
      .filter(([gk,n])=>n >= K_ANON)
      .sort((a,b)=>b[1]-a[1]);

    if(!eligible.length){
      tbody.innerHTML = `<tr><td colspan="5">ç›®å‰æ²’æœ‰ç¬¦åˆéš±ç§é–€æª»ï¼ˆâ‰¥${K_ANON}ï¼‰çš„çµ„åˆ¥å¯é¡¯ç¤ºã€‚</td></tr>`;
      return;
    }

    tbody.innerHTML = eligible.map(([gk,n])=>{
      const stats = computeScopeStats(gk);
      const [sex, level] = gk.split("|");
      const best = stats.best ? axisLabel(stats.best.key) : "â€”";
      const weak = stats.weak ? axisLabel(stats.weak.key) : "â€”";
      const note = (stats.totalN < K_ANON) ? "ï¼ˆéš±ç§ä¿è­·ï¼šæœªé¡¯ç¤ºï¼‰" : "åªåšè³‡æºé…ç½®åƒè€ƒ";
      return `
        <tr>
          <td>${sex}ãƒ»${level}</td>
          <td>${n}</td>
          <td>${best}</td>
          <td>${weak}</td>
          <td>${note}</td>
        </tr>
      `;
    }).join("");
  }

  function applyScope(scopeGroupKey=null){
    const scopeText = document.getElementById("scopeText");
    if(scopeGroupKey){
      const [sex, level] = scopeGroupKey.split("|");
      scopeText.textContent = `ç¯„åœï¼š${sex}ãƒ»${level}ï¼ˆåŒ¿åçµ„åˆ¥æ‘˜è¦ï¼‰`;
    }else{
      scopeText.textContent = "ç¯„åœï¼šå…¨éšŠ";
    }

    const stats = computeScopeStats(scopeGroupKey);

    document.getElementById("kpiN").textContent = stats.totalN ?? "â€”";
    document.getElementById("kpiBest").textContent = stats.best ? axisLabel(stats.best.key) : "â€”";
    document.getElementById("kpiWeak").textContent = stats.weak ? axisLabel(stats.weak.key) : "â€”";
    document.getElementById("kpiMood").textContent = stats.mood || "â€”";

    renderRadar(stats.avgScores);
    renderDistribution(stats.distByAxis);
    renderAxisTable(stats.avgScores, stats.distByAxis);

    // çµ„åˆ¥è¡¨å›ºå®šæ¸²æŸ“ï¼ˆåªé¡¯ç¤º eligibleï¼‰
    renderGroupTable();
  }

  // ==============================
  // 8) åˆå§‹åŒ–è¼‰å…¥
  // ==============================
  async function reloadAll(){
    const status = document.getElementById("statusMsg");
    const groupSelect = document.getElementById("groupSelect");
    status.textContent = "å¾ Google Sheets è¼‰å…¥ä¸­â€¦";
    groupSelect.disabled = true;
    groupSelect.innerHTML = `<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>`;

    try{
      const [players, tests] = await Promise.all([
        loadSheet(SHEETS.players),
        loadSheet(SHEETS.tests)
      ]);

      // players index
      playersByName = new Map();
      players.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) playersByName.set(n, r);
      });

      // tests: é€™è£¡æ¡ã€ŒåŒåæœ€å¾Œä¸€ç­†ã€ç‚ºæœ€æ–°ï¼ˆè‹¥ä½ è¡¨å…§æ˜¯æŒ‰æ—¥æœŸæ’åºï¼Œæœƒåƒåˆ°æœ€å¾Œï¼‰
      testsArray = (tests || []).filter(r=>Object.keys(r||{}).length);
      const tmp = new Map();
      testsArray.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) tmp.set(n, r);
      });
      testsByName = tmp;

      buildGroupStats();
      buildGroupOptions();

      applyScope(null);
      status.textContent = "è¼‰å…¥å®Œæˆï¼ˆåŒ¿åå„€è¡¨æ¿ï¼‰";
    }catch(err){
      console.error(err);
      status.textContent = "è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèªè©¦ç®—è¡¨å·²å…¬é–‹ã€åˆ†é åç¨±æ­£ç¢ºï¼ˆå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ï¼‰ã€‚";
    }
  }

  // ==============================
  // 9) ç¶äº‹ä»¶
  // ==============================
  document.getElementById("reloadBtn").addEventListener("click", reloadAll);
  document.getElementById("viewAllBtn").addEventListener("click", ()=>{
    document.getElementById("groupSelect").value = "";
    applyScope(null);
  });
  document.getElementById("groupSelect").addEventListener("change", (e)=>{
    const gk = e.target.value || null;
    applyScope(gk);
  });

  // åˆå§‹
  reloadAll();
</script>
</body>
</html>
