<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¶²çƒå­¸é™¢ï½œé‹å‹•å“¡è¨“ç·´æˆæ•ˆå ±å‘Šï¼ˆå«äº”è»¸é›·é”ï¼‰</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg-page:#020617;
      --accent:#22c55e;
      --accent-alt:#38bdf8;
      --accent-soft:#bbf7d0;
      --text-main:#e5e7eb;
      --text-sub:#9ca3af;
      --text-muted:#6b7280;
      --border:rgba(148,163,184,0.35);
      --card:rgba(15,23,42,0.97);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,sans-serif;
      background: radial-gradient(circle at 10% 0,#0f172a 0,#020617 45%,#000 100%);
      color:var(--text-main);
      display:flex; justify-content:center;
    }
    .page-frame{ width:820px; margin:32px auto; padding:0; }
    .report-shell{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(34,197,94,0.18) 0, transparent 60%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 55%);
      border-radius:24px;
      padding:24px 26px 26px;
      box-shadow:0 18px 60px rgba(15,23,42,0.95), 0 0 0 1px rgba(148,163,184,0.25);
      position:relative; overflow:hidden;
    }
    .report-shell::before{
      content:""; position:absolute; width:220px; height:220px; border-radius:999px;
      border:1px solid rgba(56,189,248,0.4);
      right:-110px; top:-70px; opacity:.4;
      box-shadow:0 0 40px rgba(56,189,248,0.5);
    }
    .report-shell::after{
      content:""; position:absolute; width:140px; height:140px; border-radius:999px;
      border:2px solid rgba(34,197,94,0.8);
      left:-60px; bottom:-50px; opacity:.35;
      box-shadow:0 0 32px rgba(34,197,94,0.6);
    }
    header{ position:relative; z-index:1; margin-bottom:14px; }
    .top-row{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    h1{
      margin:0; font-size:20px; letter-spacing:.08em; text-transform:uppercase;
      color:#f9fafb; display:flex; align-items:center; gap:10px;
    }
    .logo-mark{
      width:32px; height:32px; border-radius:999px;
      border:2px solid rgba(34,197,94,0.9);
      box-shadow:0 0 18px rgba(34,197,94,0.9);
      object-fit:cover; display:inline-block;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }
    .brand-sub{ font-size:12px; color:var(--text-sub); margin-top:4px; }
    .pill-tag{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.9);
      color:var(--text-sub);
      display:inline-flex; align-items:center; gap:6px;
    }
    .pill-tag .dot{
      width:7px; height:7px; border-radius:999px;
      background:#22c55e; box-shadow:0 0 10px #22c55e;
    }

    .control-row{
      margin-top:10px; margin-bottom:14px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      font-size:13px; position:relative; z-index:1;
    }
    label{ color:var(--text-sub); }
    select{
      padding:7px 12px; font-size:13px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      color:var(--text-main);
      min-width:180px; appearance:none; outline:none; padding-right:26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 50%, calc(100% - 11px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    .btn{
      padding:7px 11px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.95);
      cursor:pointer; font-size:12px; color:var(--text-sub);
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn:hover{ border-color:rgba(248,250,252,0.9); color:#e5e7eb; background:rgba(15,23,42,1); }
    .status-note{ font-size:11px; color:var(--text-muted); margin-left:auto; }

    .report-body{
      position:relative; z-index:1;
      background:var(--card);
      border-radius:18px;
      padding:16px 18px 18px;
      border:1px solid var(--border);
    }
    .section-title{
      font-size:14px; font-weight:600; margin:0 0 6px;
      display:flex; align-items:center; gap:6px; color:#e5e7eb;
    }
    .section-title .dot{
      width:7px; height:7px; border-radius:999px;
      background:var(--accent); box-shadow:0 0 8px var(--accent);
    }
    .section-sub{ font-size:11px; color:var(--text-muted); margin:0 0 10px; line-height:1.6; }

    .profile-row{ display:grid; grid-template-columns:1.1fr 1fr; gap:10px; margin-bottom:12px; }
    .profile-card{
      background: radial-gradient(circle at top left, rgba(34,197,94,0.10) 0, transparent 60%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,1) 0, #020617 80%);
      border-radius:14px; border:1px solid rgba(148,163,184,0.3);
      padding:10px 12px; font-size:12px;
    }
    .profile-card h3{
      margin:0 0 6px; font-size:11px; letter-spacing:.18em;
      text-transform:uppercase; color:var(--text-muted);
    }
    .profile-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; }
    .profile-item-title{ font-size:11px; color:var(--text-muted); }
    .profile-item-value{ font-size:14px; font-weight:700; color:#f9fafb; }

    .grid-2{
      display:grid; grid-template-columns:1.25fr .9fr; gap:10px;
      margin-top:10px;
    }
    .card{
      background:rgba(15,23,42,0.98);
      border-radius:14px; border:1px solid var(--border);
      padding:10px 12px;
    }
    .card h3{
      margin:0 0 6px; font-size:11px; letter-spacing:.18em;
      text-transform:uppercase; color:var(--text-muted);
    }

    .chart-wrapper{
      border-radius:14px; border:1px solid var(--border);
      background: radial-gradient(circle at top, #020617 0, #020617 90%);
      padding:10px 12px 12px;
    }
    .chart-box{ position:relative; width:100%; height:220px; }
    .radar-box{ position:relative; width:100%; height:260px; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
      font-size:11px; color:var(--text-sub);
    }
    .chip{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(2,6,23,0.45);
    }
    .chip strong{ color:#f9fafb; }

    table{
      width:100%; border-collapse:collapse; font-size:11px;
      border-radius:12px; overflow:hidden;
      border:1px solid rgba(148,163,184,0.6);
      background:#020617; color:#f9fafb;
      margin-top:10px;
    }
    th,td{
      padding:6px 8px; border-bottom:1px solid rgba(30,41,59,0.9);
      text-align:right; white-space:nowrap; color:#f9fafb;
    }
    th:first-child, td:first-child{ text-align:left; max-width:160px; white-space:normal; }
    thead th{ background:#020617; color:#e5e7eb; font-weight:600; }
    tbody tr:nth-child(even) td{ background:#020819; }
    tbody tr:last-child td{ border-bottom:none; }

    .tag{ padding:2px 6px; border-radius:999px; border:1px solid transparent; font-size:10px; white-space:nowrap; }
    .tag.good{ border-color:rgba(34,197,94,0.85); background:rgba(22,163,74,0.2); color:#bbf7d0; }
    .tag.mid{ border-color:rgba(250,204,21,0.8); background:rgba(133,77,14,0.28); color:#facc15; }
    .tag.bad{ border-color:rgba(248,113,113,0.9); background:rgba(127,29,29,0.4); color:#fecaca; }
    .tag.key{ border-color:rgba(59,130,246,0.9); background:rgba(30,64,175,0.4); color:#bfdbfe; }

    .footer-row{
      margin-top:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      flex-wrap:wrap;
    }
    .btn-pdf{
      padding:9px 16px; border-radius:999px; border:none;
      cursor:pointer; font-size:13px; font-weight:800;
      letter-spacing:.08em; text-transform:uppercase;
      background:linear-gradient(to right,#22c55e,#38bdf8);
      color:#020617;
      box-shadow:0 10px 30px rgba(34,197,94,0.7);
    }
    .btn-pdf:disabled{ opacity:.6; cursor:default; box-shadow:none; }
    .small-note{ font-size:10px; color:var(--text-muted); line-height:1.5; }

    #reportSection{ display:none; }

    @media (max-width:820px){
      .page-frame{ width:100%; margin:16px auto; padding:0 8px; }
      .report-shell{ padding:18px 14px 20px; border-radius:20px; }
      .profile-row, .grid-2{ grid-template-columns:minmax(0,1fr); }
      .chart-box{ height:240px; }
      .radar-box{ height:280px; }
    }
  </style>
</head>

<body>
<div class="page-frame" id="pdfArea">
  <div class="report-shell">
    <header>
      <div class="top-row">
        <div>
          <h1>
            <img class="logo-mark" src="https://aschangaspossible.github.io/logo.jpeg" alt="Logo" />
            <span>å¥•æ™‰ç¶²çƒå­¸é™¢</span>
          </h1>
          <div class="brand-sub">Match Point Labï½œé«”èƒ½æª¢æ¸¬ä¸­å¿ƒï½œè‡ªå‹•å ±å‘Šï¼ˆå«äº”è»¸é›·é”ï¼‰</div>
        </div>
        <div class="pill-tag"><span class="dot"></span><span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°</span></div>
      </div>

      <div class="control-row">
        <label for="studentSelect">é¸æ“‡å­¸å“¡ï¼š</label>
        <select id="studentSelect" disabled onchange="loadStudentData()">
          <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
        </select>
        <button class="btn" id="reloadBtn" onclick="reloadSheets()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <span id="statusMsg" class="status-note"></span>
      </div>
    </header>

    <section id="reportSection" class="report-body">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <h2 class="section-title"><span class="dot"></span> é‹å‹•å“¡åŸºæœ¬è³‡æ–™</h2>
      <p class="section-sub">æœ¬å ±å‘Šæœƒç”¨ã€ŒåŒä¸€æ€§åˆ¥ Ã— åŒä¸€ U çµ„ï¼ˆU16/U18â€¦ï¼‰ã€åšæ¯”è¼ƒï¼Œè¨ˆç®—å„é … Z åˆ†æ•¸èˆ‡äº”å¤§èƒ½åŠ›ç¶œåˆæŒ‡æ¨™ã€‚</p>

      <div class="profile-row">
        <div class="profile-card">
          <h3>PLAYER PROFILE</h3>
          <div class="profile-grid">
            <div>
              <div class="profile-item-title">å§“å</div>
              <div class="profile-item-value" id="dispName">â€”</div>
            </div>
            <div>
              <div class="profile-item-title">åˆ†çµ„ï¼ˆæ€§åˆ¥Ã—å¹´é½¡ï¼‰</div>
              <div class="profile-item-value" id="dispGroup">â€”</div>
            </div>
            <div>
              <div class="profile-item-title">è³‡æ–™åˆ—</div>
              <div class="profile-item-value" id="dispRow">â€”</div>
            </div>
          </div>
        </div>
        <div class="profile-card">
          <h3>SESSION SUMMARY</h3>
          <p class="section-sub" style="margin:0;color:var(--text-sub)">
            Z åˆ†æ•¸ï¼š0 = åŒç´šå¹³å‡ï¼›â‰¥ +1 æ˜é¡¯å„ªå‹¢ï¼›â‰¤ -0.5 å»ºè­°è£œå¼·ã€‚<br/>
            é›·é”åœ–æ¡ 0â€“100 åˆ†æ›ç®—ï¼š50 = åŒç´šå¹³å‡ï¼ˆç‚ºäº†å¥½è®€ï¼Œä¸æœƒã€Œä¸‹åŠéƒ¨ä¸è¦‹ã€é‚£ç¨®æ€ªåœ–ï¼‰ã€‚
          </p>
        </div>
      </div>

      <!-- äº”è»¸é›·é” + äº”è»¸æ•¸å€¼ -->
      <div class="grid-2">
        <div class="card">
          <h3>äº”å¤§èƒ½åŠ›é›·é”åœ–ï¼ˆ0â€“100 åˆ†ï½œ50=åŒç´šå¹³å‡ï¼‰</h3>
          <div class="chart-wrapper">
            <div class="radar-box">
              <canvas id="radar5"></canvas>
            </div>
          </div>
          <div class="chips" id="axisChips"></div>
          <div class="small-note">
            â€» è‹¥æŸèƒ½åŠ›çš„æŸå€‹å­é …ç›®æ¨£æœ¬ä¸è¶³æˆ– SD=0ï¼Œè©²å­é …ç›®æœƒè¢«ç•¥éä¸¦è‡ªå‹•ã€Œé‡æ–°æ­£è¦åŒ–æ¬Šé‡ã€ï¼Œç¢ºä¿ç¶œåˆä»åˆç†ã€‚
          </div>
        </div>

        <div class="card">
          <h3>COACH NOTE</h3>
          <div id="coachComment" style="font-size:12px; color:var(--text-sub); line-height:1.75">
            è«‹å…ˆé¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆæ•™ç·´çŸ­è©•ã€‚
          </div>
        </div>
      </div>

      <!-- é—œéµæŒ‡æ¨™ bar chart -->
      <div style="margin-top:12px">
        <h2 class="section-title"><span class="dot"></span> é—œéµæŒ‡æ¨™ï¼šèˆ‡åŒç´šå¹³å‡å·®è·æœ€å¤§ï¼ˆTop 10ï¼‰</h2>
        <p class="section-sub">å– |Z| æœ€å¤§çš„å‰ 10 é …ï¼Œæ–¹ä¾¿å¿«é€Ÿé–å®šæœ€é‡è¦çš„å¼·é …èˆ‡å¼±é …ã€‚</p>
        <div class="chart-wrapper">
          <div class="chart-box"><canvas id="barChart"></canvas></div>
        </div>
      </div>

      <!-- å®Œæ•´è¡¨æ ¼ -->
      <div style="margin-top:12px">
        <h2 class="section-title"><span class="dot"></span> å®Œæ•´æª¢æ¸¬è¡¨ï¼ˆå­¸ç”Ÿ vs åŒç´šå¹³å‡ï¼‰</h2>
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å­¸ç”Ÿ</th>
              <th>åŒç´šå¹³å‡</th>
              <th>SD</th>
              <th>Z</th>
              <th>è©•ä¼°</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="footer-row">
        <span class="small-note">â€» æœ¬å ±å‘Šåƒ…ä¾›æ•™ç·´èˆ‡å­¸å“¡æºé€šè¨“ç·´æ–¹å‘ä¹‹ç”¨ã€‚</span>
        <button class="btn-pdf" id="pdfBtn" onclick="exportPDF()">ğŸ“„ ä¸‹è¼‰ PDF</button>
      </div>
    </section>
  </div>
</div>

<script>
  // =======================
  // 1) Google Sheets è¨­å®š
  // =======================
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";

  // âœ… ä½ çš„åˆ†é åç¨±å¦‚æœä¸æ˜¯é€™å€‹ï¼Œæ”¹é€™è£¡
  const SHEETS = {
    tests: "æª¢æ¸¬æˆç¸¾"
  };

  // =======================
  // 2) æ¬„ä½è¦å‰‡
  // =======================
  const IDENTITY_KEYS = new Set(["å§“å","æ€§åˆ¥","å¹´é½¡"]);

  // æ•¸å€¼è¶Šå°è¶Šå¥½ï¼ˆç§’æ•¸é¡ï¼‰
  const LOWER_BETTER_KEYS = ["ç§’","10ç±³","20ç±³","505","èœ˜è››ç¶²"];

  function isLowerBetter(name){
    return LOWER_BETTER_KEYS.some(k => name.includes(k));
  }

  function parseNumber(v){
    if(v==null || v==="") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return Number.isFinite(n) ? n : null;
  }

  function avg2(a,b){
    const x=parseNumber(a), y=parseNumber(b);
    if(x==null && y==null) return null;
    if(x==null) return y;
    if(y==null) return x;
    return (x+y)/2;
  }

  // åˆ†çµ„ï¼šåŒä¸€æ€§åˆ¥ Ã— åŒä¸€ U çµ„ï¼ˆU16/U18...ï¼‰
  function buildGroupKey(row){
    const sex = (row["æ€§åˆ¥"] || "-").trim() || "-";
    const age = (row["å¹´é½¡"] || "-").trim() || "-";
    return `${sex} Â· ${age}`;
  }

  function csvUrlForSheet(sheetName){
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function loadSheet(sheetName){
    const url = csvUrlForSheet(sheetName);
    return new Promise((resolve,reject)=>{
      Papa.parse(url,{
        download:true,
        header:true,
        complete:r=>resolve(r.data),
        error:e=>reject(e)
      });
    });
  }

  // =======================
  // 3) äº”å¤§èƒ½åŠ›ï¼šå­é … + æ¬Šé‡ï¼ˆä½ è¦çš„è¨ˆç®—ï¼‰
  //    é‡è¦ï¼šå…¨éƒ¨ç”¨ã€Œä½ è¡¨æ ¼çœŸçš„æœ‰çš„æ¬„ä½ã€
  // =======================
  const AXES = [
    {
      id:"LBP",
      label:"ä¸‹è‚¢çˆ†ç™¼åŠ›",
      components:[
        { key:"IMTP(N)", w:0.35, higherBetter:true },
        { key:"å‚ç›´è·³(cm)", w:0.25, higherBetter:true },
        { key:"ç«‹å®šè·³(m)", w:0.25, higherBetter:true },
        // å´å‘è·³ç”¨å·¦å³å¹³å‡ï¼ˆä½ è¡¨æ ¼æ˜¯å…©æ¬„ï¼‰
        { key:["å´å‘è·³(å·¦)(m)","å´å‘è·³(å³)(m)"], w:0.15, higherBetter:true }
      ]
    },
    {
      id:"UBP",
      label:"ä¸Šè‚¢çˆ†ç™¼åŠ›",
      components:[
        { key:"éé ­æ‹‹(m)", w:0.30, higherBetter:true },
        { key:"è·ªå§¿éé ­æ‹‹(m)", w:0.20, higherBetter:true },
        // æ°´å¹³æ‹‹ç”¨å·¦å³å¹³å‡
        { key:["æ°´å¹³æ‹‹(å·¦)(m)","æ°´å¹³æ‹‹(å³)(m)"], w:0.30, higherBetter:true },
        { key:["è·ªå§¿æ°´å¹³æ‹‹(å·¦)(m)","è·ªå§¿æ°´å¹³æ‹‹(å³)(m)"], w:0.20, higherBetter:true }
      ]
    },
    {
      id:"UBS",
      label:"ä¸Šè‚¢è‚ŒåŠ›",
      components:[
        { key:"åå‘åˆ’èˆ¹(æ¬¡æ•¸)", w:0.30, higherBetter:true },
        { key:"ä¿¯è‡¥æ’(æ¬¡æ•¸)", w:0.30, higherBetter:true },
        { key:"æ¡åŠ›", w:0.25, higherBetter:true },
        { key:"å¹³æ¿æ’(ç§’)", w:0.15, higherBetter:true }
      ]
    },
    {
      id:"SPD",
      label:"é€Ÿåº¦",
      components:[
        { key:"10ç±³è¡åˆº(ç§’)", w:0.60, higherBetter:false },
        { key:"20ç±³è¡åˆº(ç§’)", w:0.40, higherBetter:false }
      ]
    },
    {
      id:"COD",
      label:"è®Šå‘èƒ½åŠ›",
      components:[
        // 505 ç”¨å·¦å³å¹³å‡ï¼ˆä½ è¡¨æ ¼æœ‰å·¦å³ï¼‰
        { key:["505æ•æ·è·‘(å·¦)(ç§’)","505æ•æ·è·‘(å³)(ç§’)"], w:0.45, higherBetter:false },
        { key:"èœ˜è››ç¶²(ç§’)", w:0.35, higherBetter:false },
        // âœ… ä½ èªªå°‘ä¸€å€‹ï¼šç”¨è¡¨æ ¼æœ‰çš„ã€Œåæ‡‰è®Šå‘æ¸¬è©¦(æ¬¡æ•¸)ã€è£œé½Šï¼ˆæ¬¡æ•¸è¶Šå¤šè¶Šå¥½ï¼‰
        { key:"åæ‡‰è®Šå‘æ¸¬è©¦(æ¬¡æ•¸)", w:0.20, higherBetter:true }
      ]
    }
  ];

  // =======================
  // 4) å…¨åŸŸè³‡æ–™
  // =======================
  let testsArray = [];
  let testsByName = new Map();
  let groupStats = new Map(); // groupKey -> statsObj[metricName] = {mean, sd, n}

  let radar5Chart = null;
  let barChart = null;

  // å»ºç«‹ groupStatsï¼šæŠŠæ¯å€‹æ¬„ä½ï¼ˆéèº«ä»½æ¬„ï¼‰åœ¨æ¯å€‹ group çš„ mean/sd/n ç®—å¥½
  function buildGroupStats(){
    const collector = new Map(); // group -> Map(metricKey -> [values])
    testsArray.forEach(row=>{
      const name = (row["å§“å"]||"").trim();
      if(!name) return;
      const g = buildGroupKey(row);

      if(!collector.has(g)) collector.set(g, new Map());
      const gMap = collector.get(g);

      Object.keys(row).forEach(k=>{
        if(!k || IDENTITY_KEYS.has(k)) return;
        const v = parseNumber(row[k]);
        if(v==null) return;

        if(!gMap.has(k)) gMap.set(k, []);
        gMap.get(k).push(v);
      });
    });

    groupStats = new Map();
    collector.forEach((m, g)=>{
      const out = {};
      m.forEach((vals, k)=>{
        const n = vals.length;
        if(!n) return;
        const mean = vals.reduce((a,b)=>a+b,0)/n;
        const variance = vals.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
        const sd = Math.sqrt(variance);
        out[k] = {mean, sd, n};
      });
      groupStats.set(g, out);
    });
  }

  function zScore(value, mean, sd, higherBetter){
    if(value==null || mean==null || sd==null || sd===0) return null;
    const raw = (value - mean) / sd;
    return higherBetter ? raw : -raw; // ç§’æ•¸é¡ï¼šè¶Šå°è¶Šå¥½ => åå‘
  }

  // Z -> 0..100ï¼Œ50=å¹³å‡
  function zToScore(z){
    if(z==null) return 50;
    let s = 50 + z*10; // 1 SD = 10 åˆ†
    if(s<0) s=0;
    if(s>100) s=100;
    return s;
  }

  // å–å¾—æŸ component çš„ valueï¼ˆæ”¯æ´å·¦å³å¹³å‡ï¼‰
  function getComponentValue(row, key){
    if(Array.isArray(key)){
      return avg2(row[key[0]], row[key[1]]);
    }
    return parseNumber(row[key]);
  }

  // è¨ˆç®—æŸä¸€è»¸çš„ã€ŒåŠ æ¬Š Zã€ï¼šåªç”¨ç®—å¾—å‡º Z çš„å­é …ï¼Œä¸¦é‡æ–°æ­£è¦åŒ–æ¬Šé‡
  function computeAxisWeightedZ(row, groupKey, axis){
    const stats = groupStats.get(groupKey) || {};
    let sum = 0;
    let wSum = 0;

    const detail = [];

    axis.components.forEach(c=>{
      // æ‰¾åˆ°çœŸæ­£ç”¨ä¾†ç®—çµ±è¨ˆçš„ keyï¼ˆå·¦å³å¹³å‡æ™‚ï¼Œç”¨å…©æ¬„å„è‡ªçš„ stats æœƒä¸æº–ï¼‰
      // æ‰€ä»¥ï¼šå·¦å³å¹³å‡çš„ stats æˆ‘å€‘ç”¨ã€ŒæŠŠå·¦å³å¹³å‡å€¼ç•¶æˆä¸€å€‹è‡¨æ™‚å€¼ã€ä¾†ç®— Z
      // åšæ³•ï¼šç›´æ¥ç”¨ group çš„ rows é‡æ–°æ”¶é›†ï¼ˆä½†æˆæœ¬é«˜ï¼‰
      // âœ… ç°¡åŒ–ï¼šå·¦å³å¹³å‡çš„ Z ç”¨ã€Œå·¦å³å„è‡ª Z çš„å¹³å‡ã€ï¼ˆæœ€ç©©ã€åˆä¸ç”¨å‹•è¡¨ï¼‰
      if(Array.isArray(c.key)){
        const k1=c.key[0], k2=c.key[1];
        const v1=parseNumber(row[k1]), v2=parseNumber(row[k2]);
        const s1=stats[k1], s2=stats[k2];

        const z1 = (s1 && s1.sd && s1.sd!==0) ? zScore(v1, s1.mean, s1.sd, c.higherBetter) : null;
        const z2 = (s2 && s2.sd && s2.sd!==0) ? zScore(v2, s2.mean, s2.sd, c.higherBetter) : null;

        const z = (z1==null && z2==null) ? null
                : (z1==null) ? z2
                : (z2==null) ? z1
                : (z1+z2)/2;

        detail.push({name:`${k1} / ${k2}`, z, w:c.w});

        if(z!=null){
          sum += z*c.w;
          wSum += c.w;
        }
        return;
      }

      const v = parseNumber(row[c.key]);
      const s = stats[c.key];
      const z = (s && s.sd && s.sd!==0 && s.n>=2) ? zScore(v, s.mean, s.sd, c.higherBetter) : null;
      detail.push({name:c.key, z, w:c.w});
      if(z!=null){
        sum += z*c.w;
        wSum += c.w;
      }
    });

    const weightedZ = (wSum>0) ? (sum/wSum) : null;
    return { weightedZ, detail };
  }

  // =======================
  // 5) UIï¼šè¼‰å…¥ã€é¸äººã€ç•«åœ–ã€è¡¨æ ¼
  // =======================
  async function reloadSheets(){
    const status=document.getElementById("statusMsg");
    const select=document.getElementById("studentSelect");
    const report=document.getElementById("reportSection");

    status.textContent="å¾ Google Sheets è¼‰å…¥ä¸­â€¦";
    select.disabled=true;
    select.innerHTML='<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>';
    report.style.display="none";

    try{
      const tests = await loadSheet(SHEETS.tests);
      testsArray = (tests||[]).filter(r => r && (r["å§“å"]||"").trim());
      testsByName = new Map();
      testsArray.forEach(r=>testsByName.set((r["å§“å"]||"").trim(), r));

      buildGroupStats();

      const names = Array.from(testsByName.keys()).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      select.innerHTML='<option value="">â€” è«‹é¸æ“‡å­¸å“¡ â€”</option>';
      names.forEach(n=>{
        const op=document.createElement("option");
        op.value=n; op.textContent=n;
        select.appendChild(op);
      });
      select.disabled=false;

      status.textContent="è¼‰å…¥å®Œæˆï¼Œè«‹é¸æ“‡å­¸å“¡ã€‚";
    }catch(err){
      console.error(err);
      status.textContent="è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèªè©¦ç®—è¡¨å·²å…¬é–‹ã€åˆ†é åç¨±æ­£ç¢ºã€‚";
    }
  }
  reloadSheets();

  function loadStudentData(){
    const name=document.getElementById("studentSelect").value;
    const report=document.getElementById("reportSection");
    const status=document.getElementById("statusMsg");
    if(!name){ report.style.display="none"; return; }

    const row = testsByName.get(name);
    if(!row){ status.textContent=`ã€Œ${name}ã€æ‰¾ä¸åˆ°è³‡æ–™`; report.style.display="none"; return; }

    const groupKey = buildGroupKey(row);

    document.getElementById("dispName").textContent=name;
    document.getElementById("dispGroup").textContent=groupKey;
    document.getElementById("dispRow").textContent="â€”";

    // ----- 1) ç®—äº”è»¸ -----
    const axisResults = AXES.map(ax=>{
      const r = computeAxisWeightedZ(row, groupKey, ax);
      return {
        id: ax.id,
        label: ax.label,
        z: r.weightedZ,
        score: zToScore(r.weightedZ),
        detail: r.detail
      };
    });

    // chips
    const chips=document.getElementById("axisChips");
    chips.innerHTML="";
    axisResults.forEach(a=>{
      const el=document.createElement("div");
      el.className="chip";
      el.innerHTML=`<strong>${a.label}</strong>ï¼š${a.z==null?"--":a.z.toFixed(2)}ï¼ˆåˆ†æ•¸ ${Math.round(a.score)}ï¼‰`;
      chips.appendChild(el);
    });

    // ----- 2) é›·é”åœ–ï¼ˆäº”è»¸ï¼‰-----
    const radarLabels = axisResults.map(a=>a.label);
    const radarPlayer = axisResults.map(a=>a.score);
    const radarAvg = axisResults.map(()=>50);

    const rctx=document.getElementById("radar5").getContext("2d");
    if(radar5Chart) radar5Chart.destroy();
    radar5Chart = new Chart(rctx,{
      type:"radar",
      data:{
        labels:radarLabels,
        datasets:[
          {
            label:"å­¸å“¡ï¼ˆ50=åŒç´šå¹³å‡ï¼‰",
            data:radarPlayer,
            backgroundColor:"rgba(34,197,94,0.22)",
            borderColor:"rgba(34,197,94,1)",
            pointBackgroundColor:"rgba(56,189,248,1)",
            borderWidth:2,
            pointRadius:3
          },
          {
            label:"åŒç´šå¹³å‡ï¼ˆå›ºå®š50ï¼‰",
            data:radarAvg,
            backgroundColor:"rgba(148,163,184,0.05)",
            borderColor:"rgba(148,163,184,0.65)",
            pointBackgroundColor:"rgba(148,163,184,0.65)",
            borderWidth:1,
            pointRadius:2
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          r:{
            min:0,
            max:100,
            ticks:{ stepSize:10, color:"#9ca3af", showLabelBackdrop:false },
            grid:{ color:"#1f2937" },
            angleLines:{ color:"#1f2937" },
            pointLabels:{ font:{ size:11 }, color:"#e5e7eb" }
          }
        },
        plugins:{
          legend:{ labels:{ font:{ size:11 }, color:"#e5e7eb" } }
        }
      }
    });

    // ----- 3) å…¨æŒ‡æ¨™ Zï¼ˆçµ¦ bar + tableï¼‰-----
    const gStats = groupStats.get(groupKey) || {};
    const metricRows = [];
    Object.keys(row).forEach(k=>{
      if(!k || IDENTITY_KEYS.has(k)) return;
      const v = parseNumber(row[k]);
      if(v==null) return;

      const s = gStats[k];
      const mean = s ? s.mean : null;
      const sd = s ? s.sd : null;
      const hb = !isLowerBetter(k);
      const z = (mean!=null && sd!=null && sd!==0) ? zScore(v, mean, sd, hb) : null;

      metricRows.push({label:k, latest:v, mean, sd, z});
    });

    const withZ = metricRows.filter(r=>r.z!=null);
    withZ.sort((a,b)=>Math.abs(b.z)-Math.abs(a.z));
    const keyMetrics = withZ.slice(0,10);
    const keySet = new Set(keyMetrics.map(r=>r.label));

    // bar
    const bctx=document.getElementById("barChart").getContext("2d");
    if(barChart) barChart.destroy();
    barChart = new Chart(bctx,{
      type:"bar",
      data:{
        labels:keyMetrics.map(r=>r.label),
        datasets:[
          { label:"å­¸ç”Ÿ", data:keyMetrics.map(r=>r.latest), backgroundColor:"rgba(34,197,94,0.85)" },
          { label:"åŒç´šå¹³å‡", data:keyMetrics.map(r=>r.mean), backgroundColor:"rgba(56,189,248,0.85)" }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ ticks:{ font:{ size:10 }, color:"#e5e7eb" }, grid:{ display:false } },
          y:{ ticks:{ font:{ size:10 }, color:"#9ca3af" }, grid:{ color:"#1f2937" } }
        }
      }
    });

    // table
    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";
    metricRows
      .slice()
      .sort((a,b)=>{
        if(a.z==null && b.z==null) return a.label.localeCompare(b.label,"zh-Hant");
        if(a.z==null) return 1;
        if(b.z==null) return -1;
        return Math.abs(b.z)-Math.abs(a.z);
      })
      .forEach(r=>{
        let tag="â€”";
        if(r.z!=null){
          if(r.z>=1) tag = '<span class="tag good">å„ªæ–¼åŒç´š</span>';
          else if(r.z<=-0.5) tag = '<span class="tag bad">å»ºè­°è£œå¼·</span>';
          else tag = '<span class="tag mid">æ¥è¿‘åŒç´š</span>';
          if(keySet.has(r.label)) tag += ' <span class="tag key">é—œéµæŒ‡æ¨™</span>';
        }
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${r.label}</td>
          <td>${r.latest}</td>
          <td>${r.mean!=null ? r.mean.toFixed(2) : "â€”"}</td>
          <td>${r.sd!=null ? r.sd.toFixed(2) : "â€”"}</td>
          <td>${r.z!=null ? r.z.toFixed(2) : "â€”"}</td>
          <td>${tag}</td>
        `;
        tbody.appendChild(tr);
      });

    // ----- 4) æ•™ç·´çŸ­è©•ï¼šç”¨äº”è»¸ Z åšæ›´ã€Œå°ˆæ¥­ã€çš„æ‘˜è¦ -----
    const coach=document.getElementById("coachComment");
    const sorted = axisResults
      .map(a=>({label:a.label, z:a.z}))
      .filter(a=>a.z!=null)
      .sort((a,b)=>b.z-a.z);

    const best = sorted.slice(0,2);
    const worst = sorted.slice(-2).reverse();

    const list = arr => arr.length
      ? arr.map(x=>`${x.label}ï¼ˆZ=${x.z.toFixed(2)}ï¼‰`).join("ã€")
      : "ç›®å‰æ¨£æœ¬ä¸è¶³ï¼Œæš«ç„¡æ³•åˆ¤è®€ã€‚";

    coach.innerHTML = `
      <strong>${name}</strong>ï¼ˆ${groupKey}ï¼‰çš„äº”å¤§èƒ½åŠ›æ¦‚æ³ï¼š<br><br>
      ãƒ»ä¸»è¦<strong>å„ªå‹¢èƒ½åŠ›</strong>ï¼š${list(best)}<br>
      ãƒ»å»ºè­°<strong>å„ªå…ˆè£œå¼·</strong>ï¼š${list(worst)}<br><br>
      å»ºè­°ï¼šè£œå¼·é¢å‘å®‰æ’æ¯é€±å›ºå®šå°ˆé …ï¼ˆä¾‹å¦‚ 2 æ¬¡ï¼‰ï¼Œå…¶é¤˜ç¶­æŒå„ªå‹¢èƒ½åŠ›çš„ã€Œä¿ç•™é‡ã€ï¼Œé¿å…è¨“ç·´åç§»é€ æˆå„ªå‹¢æµå¤±ã€‚
    `;

    status.textContent="";
    report.style.display="block";
  }

  // =======================
  // 6) åŒ¯å‡º PDFï¼ˆæŠŠé›·é”ä¸€èµ·å°é€²å»ï¼‰
  // =======================
  async function exportPDF(){
    const report=document.getElementById("reportSection");
    if(report.style.display==="none"){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡å†ä¸‹è¼‰ PDF"); return; }

    const btn=document.getElementById("pdfBtn");
    btn.disabled=true;
    btn.textContent="ç”¢ç”Ÿ PDF ä¸­â€¦";

    try{
      const pdfArea=document.getElementById("pdfArea");
      const canvas=await html2canvas(pdfArea,{
        scale:3,
        backgroundColor:"#020617",
        useCORS:true
      });

      const imgData=canvas.toDataURL("image/png");
      const {jsPDF}=window.jspdf;

      const pdf=new jsPDF("p","mm","a4");
      const pageW=pdf.internal.pageSize.getWidth();
      const pageH=pdf.internal.pageSize.getHeight();

      const imgW=pageW;
      const imgH=canvas.height*imgW/canvas.width;

      let pos=0;
      let left=imgH;

      pdf.addImage(imgData,"PNG",0,pos,imgW,imgH,"","FAST");
      left-=pageH;

      while(left>0){
        pos-=pageH;
        pdf.addPage();
        pdf.addImage(imgData,"PNG",0,pos,imgW,imgH,"","FAST");
        left-=pageH;
      }

      const name=document.getElementById("dispName").textContent || "report";
      pdf.save(`AthleteReport-${name}.pdf`);
    }catch(e){
      console.error(e);
      alert("ç”¢ç”Ÿ PDF å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }finally{
      btn.disabled=false;
      btn.textContent="ğŸ“„ ä¸‹è¼‰ PDF";
    }
  }
</script>
</body>
</html>
