<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MATCH POINT LABï½œé«”èƒ½æª¢æ¸¬å ±å‘Šï¼ˆçƒå“¡ç‰ˆ/æ•™ç·´ç‰ˆï¼‰</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#071024;
      --card:#0b1226;
      --card2:#0b1a2f;
      --line:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --sub:#94a3b8;
      --muted:#64748b;
      --good:#22c55e;
      --warn:#facc15;
      --bad:#f87171;
      --blue:#38bdf8;
      --radius:18px;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(34,197,94,.18) 0, transparent 55%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 62%);
      min-height:100vh;
    }

    .wrap{
      max-width: 1180px;
      margin: 24px auto 60px;
      padding: 0 14px;
    }

    .topbar{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(10,18,38,.92), rgba(6,10,20,.92));
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 15% 0, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 85% 0, rgba(34,197,94,.22), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }

    .topbar-inner{
      position:relative;
      padding: 16px 16px 14px;
    }

    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      margin-bottom: 12px;
    }

    .brand-left{
      display:flex; align-items:center; gap:12px;
    }

    .logo{
      width:38px; height:38px; border-radius:999px;
      border:2px solid rgba(34,197,94,.85);
      box-shadow: 0 0 24px rgba(34,197,94,.5);
      object-fit:cover;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }

    .brand-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand-title b{
      font-size: 16px;
      letter-spacing:.12em;
    }
    .brand-title span{
      font-size: 12px;
      color: var(--sub);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.55);
      color: var(--sub);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 12px var(--good);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding-top: 6px;
    }

    label{ color: var(--sub); font-size: 13px; }

    select{
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--text);
      outline:none;
    }

    .btn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--sub);
      cursor:pointer;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(248,250,252,.65); color: var(--text); }

    .btn-primary{
      border: none;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(56,189,248,.95));
      color:#021018;
      font-weight: 800;
      box-shadow: 0 14px 40px rgba(34,197,94,.25);
    }

    .btn-tab{
      border: 1px solid rgba(148,163,184,.30);
      background: rgba(2,6,23,.35);
      color: var(--sub);
    }
    .btn-tab.active{
      border-color: rgba(34,197,94,.75);
      box-shadow: 0 0 0 3px rgba(34,197,94,.14);
      color: #d1fae5;
    }

    .status{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(6,10,20,.92));
      box-shadow: 0 18px 52px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .card-h{
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(148,163,184,.16);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{
      font-size: 13px;
      letter-spacing:.16em;
      color: rgba(226,232,240,.92);
      text-transform: uppercase;
    }
    .card-h span{
      font-size: 12px;
      color: var(--muted);
    }

    .card-b{
      padding: 14px 16px 16px;
    }

    .muted{ color: var(--sub); font-size: 12px; line-height:1.65; }

    /* Player layout */
    .player-hero{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    .photo{
      border: 1px dashed rgba(148,163,184,.28);
      border-radius: 16px;
      min-height: 220px;
      background: rgba(2,6,23,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .photo img{ width:100%; height:100%; object-fit: cover; display:block; }
    .photo .ph-txt{ color: rgba(148,163,184,.7); font-size: 12px; text-align:center; line-height:1.6; padding: 10px; }

    .player-info h2{
      margin: 2px 0 8px;
      font-size: 22px;
      letter-spacing: .06em;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 10px; }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.24);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-size: 12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .chip b{ color: rgba(226,232,240,.94); font-weight:700; }

    .two-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .radar-wrap{
      height: 360px;
      padding: 10px 6px 0;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .todo{
      border:1px solid rgba(148,163,184,.18);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(2,6,23,.25);
    }
    .todo ol{ margin: 0; padding-left: 18px; }
    .todo li{ margin: 8px 0; color: rgba(226,232,240,.9); line-height:1.7; }
    .todo .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 8px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,.22);
      color: var(--sub);
      background: rgba(2,6,23,.35);
    }

    .badge-row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .badge{
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.22);
      font-size: 13px;
      line-height:1.7;
      color: rgba(226,232,240,.88);
    }
    .badge .dot{
      width:10px; height:10px; border-radius:999px;
      margin-top: 6px;
      background: var(--blue);
      box-shadow: 0 0 14px rgba(56,189,248,.55);
      flex: 0 0 auto;
    }
    .badge.good .dot{ background: var(--good); box-shadow: 0 0 14px rgba(34,197,94,.55); }
    .badge.bad .dot{ background: var(--bad); box-shadow: 0 0 14px rgba(248,113,113,.55); }

    .coach-note-box{
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px 12px;
      line-height:1.75;
      color: rgba(226,232,240,.88);
      font-size: 13px;
    }
    .coach-note-box b{ color: #bbf7d0; }

    /* Coach layout */
    .coach-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .chart-box{ height: 260px; }
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
    }
    .table th,.table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      text-align:right;
      color: rgba(226,232,240,.9);
      white-space: nowrap;
    }
    .table th:first-child,.table td:first-child{ text-align:left; white-space: normal; width: 28%; }
    .table thead th{ color: rgba(226,232,240,.8); font-weight: 700; background: rgba(2,6,23,.35); }

    .tagpill{
      display:inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    .tagpill.good{ border-color: rgba(34,197,94,.55); color:#bbf7d0; }
    .tagpill.mid{ border-color: rgba(250,204,21,.55); color:#fde68a; }
    .tagpill.bad{ border-color: rgba(248,113,113,.55); color:#fecaca; }
    .tagpill.key{ border-color: rgba(59,130,246,.55); color:#bfdbfe; }

    /* PDF areas */
    .pdf-surface{
      border-radius: 22px;
      overflow:hidden;
    }

    .hide{ display:none !important; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .player-hero{ grid-template-columns: 1fr; }
      .two-cols{ grid-template-columns: 1fr; }
      .coach-grid{ grid-template-columns: 1fr; }
      .status{ width: 100%; margin-left:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-left">
            <img class="logo" src="https://aschangaspossible.github.io/logo.jpeg" alt="logo" />
            <div class="brand-title">
              <b>MATCH POINT LABï½œé«”èƒ½æª¢æ¸¬å ±å‘Š</b>
              <span>çƒå“¡ç‰ˆï¼ˆå«å®¶é•·ï¼‰ / æ•™ç·´ç‰ˆï¼ˆå®Œæ•´ç‰ˆï¼‰ï½œåŒç´šæ¯”è¼ƒè‡ªå‹•ç®— Z â†’ è½‰æˆ 0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
            </div>
          </div>
          <div class="pill"><span class="dot"></span><span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°</span></div>
        </div>

        <div class="controls">
          <label for="studentSelect">é¸æ“‡å­¸å“¡ï¼š</label>
          <select id="studentSelect" disabled>
            <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
          </select>

          <button class="btn" id="reloadBtn">ğŸ”„ é‡æ–°è¼‰å…¥</button>

          <button class="btn btn-tab active" id="tabPlayer">ğŸŸ¢ çƒå“¡ç‰ˆï¼ˆå«å®¶é•·ï¼‰</button>
          <button class="btn btn-tab" id="tabCoach">ğŸ“Š æ•™ç·´ç‰ˆï¼ˆå®Œæ•´ç‰ˆï¼‰</button>

          <button class="btn btn-primary" id="pdfPlayerBtn">ğŸ“„ çƒå“¡ç‰ˆ PDF</button>
          <button class="btn btn-primary" id="pdfCoachBtn">ğŸ“„ æ•™ç·´ç‰ˆ PDF</button>

          <span class="status" id="statusMsg">â€”</span>
        </div>
      </div>
    </div>

    <!-- ä¸»å…§å®¹ -->
    <div class="grid">

      <!-- LEFT: å…§å®¹å€ï¼ˆåˆ‡æ›çƒå“¡/æ•™ç·´ï¼‰ -->
      <div class="card pdf-surface" id="mainSurface">
        <div class="card-h">
          <b id="viewTitle">PLAYER VERSION</b>
          <span id="viewSubtitle">çœ‹å¾—æ‡‚ã€çœ‹å¾—é‡é»ï¼šç…§ç‰‡ / åŸºæœ¬è³‡æ–™ / é›·é”åœ– / æœ¬é€± 3 ä»¶äº‹ / æ•™ç·´æé†’</span>
        </div>

        <div class="card-b">

          <!-- ============ çƒå“¡ç‰ˆ ============ -->
          <section id="playerView">
            <div class="player-hero">
              <div class="photo" id="playerPhotoBox">
                <div class="ph-txt">
                  ï¼ˆå¯é¸ï¼‰æ”¾çƒå“¡æ‰“çƒç…§ç‰‡<br/>
                  æ¬„ä½ï¼š<b>ç…§ç‰‡</b>ï¼ˆURLï¼‰
                </div>
              </div>

              <div class="player-info">
                <h2 id="p_name">â€”</h2>
                <div class="chips">
                  <div class="chip">æ€§åˆ¥ï¼š<b id="p_sex">â€”</b></div>
                  <div class="chip">åˆ†ç´šï¼š<b id="p_level">â€”</b></div>
                  <div class="chip">èº«é«˜ï¼š<b id="p_height">â€”</b></div>
                  <div class="chip">é«”é‡ï¼š<b id="p_weight">â€”</b></div>
                  <div class="chip">åŒç´šæ¯”è¼ƒï¼š<b id="p_groupKey">â€”</b></div>
                  <div class="chip">æœ€è¿‘æª¢æ¸¬ï¼š<b id="p_date">â€”</b></div>
                </div>

                <div class="badge-row">
                  <div class="badge good" id="p_bestBadge">
                    <span class="dot"></span>
                    <div>
                      <b>ä½ æœ€å¼·çš„æ–¹å‘ï¼š</b>
                      <span id="p_bestText">â€”</span>
                    </div>
                  </div>
                  <div class="badge bad" id="p_weakBadge">
                    <span class="dot"></span>
                    <div>
                      <b>å„ªå…ˆè£œå¼·ï¼š</b>
                      <span id="p_weakText">â€”</span>
                    </div>
                  </div>
                </div>

                <div style="margin-top:12px" class="muted">
                  é€™ä»½æ˜¯ã€Œçµ¦çƒå“¡ï¼†å®¶é•·çœ‹çš„ç‰ˆæœ¬ã€ï¼šåªä¿ç•™ä½ çœ‹å¾—æ‡‚ã€ä½ åœ¨æ„ã€ä½ èƒ½ç«‹åˆ»åšçš„å…§å®¹ã€‚<br/>
                  é›·é”åœ–åˆ†æ•¸ç‚º 0â€“100ï¼Œå…¶ä¸­ <b>50 ä»£è¡¨åŒç´šå¹³å‡</b>ï¼ˆåŒçµ„ = æ€§åˆ¥ Ã— åˆ†ç´šï¼‰ã€‚
                </div>
              </div>
            </div>

            <div class="two-cols">
              <!-- Radar -->
              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>8 å¤§æŒ‡æ¨™é›·é”åœ–</b>
                  <span>0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
                </div>
                <div class="card-b">
                  <div class="radar-wrap">
                    <canvas id="playerRadar"></canvas>
                  </div>
                  <div class="muted" style="margin-top:6px">
                    ç°è‰²ç·š = å›ºå®š 50ï¼ˆåŒç´šå¹³å‡åŸºæº–ï¼‰ã€‚ç´…è‰² = ä½ çš„åˆ†æ•¸ã€‚
                  </div>
                </div>
              </div>

              <!-- 3 things -->
              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>æœ¬é€±è¨“ç·´å»ºè­°ï¼ˆåªåš 3 ä»¶äº‹ï¼‰</b>
                  <span>è¶Šå°‘è¶Šæœ‰æ•ˆ</span>
                </div>
                <div class="card-b">
                  <div class="todo">
                    <ol id="p_todoList">
                      <li>è«‹å…ˆé¸æ“‡å­¸å“¡</li>
                    </ol>
                  </div>
                  <div class="muted" style="margin-top:10px">
                    è¨˜ä½å°±å¥½ï¼š<b>æœ¬é€±å…ˆè£œ 1â€“2 å€‹å¼±é …</b>ï¼Œå…¶ä»–ç¶­æŒã€‚åšå¤ªå¤šåè€Œæ²’é€²æ­¥ã€‚
                  </div>
                </div>
              </div>
            </div>

            <!-- Coach Note (Player Version) ç¨ç«‹æ¡†ã€æ”¾æœ€ä¸‹é¢ -->
            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>COACH NOTEï¼ˆçµ¦çƒå“¡/å®¶é•·çœ‹çš„æé†’ï¼‰</b>
                <span>ä¸€æ®µè©±è¬›æ¸…æ¥š</span>
              </div>
              <div class="card-b">
                <div class="coach-note-box" id="p_coachNote">
                  è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆæé†’å…§å®¹ã€‚
                </div>
              </div>
            </div>
          </section>

          <!-- ============ æ•™ç·´ç‰ˆ ============ -->
          <section id="coachView" class="hide">
            <div class="coach-grid">
              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>PLAYER PROFILE</b>
                  <span>æ•™ç·´ç”¨</span>
                </div>
                <div class="card-b">
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="chip">å§“åï¼š<b id="c_name">â€”</b></div>
                    <div class="chip">åŒç´šï¼š<b id="c_groupKey">â€”</b></div>
                    <div class="chip">æ€§åˆ¥ï¼š<b id="c_sex">â€”</b></div>
                    <div class="chip">åˆ†ç´šï¼š<b id="c_level">â€”</b></div>
                    <div class="chip">æœ€è¿‘æª¢æ¸¬ï¼š<b id="c_date">â€”</b></div>
                    <div class="chip">èº«é«˜/é«”é‡ï¼š<b id="c_hw">â€”</b></div>
                  </div>
                  <div class="muted" style="margin-top:10px">
                    Z åˆ†æ•¸åŸºæº–ï¼šåŒçµ„ï¼ˆæ€§åˆ¥ Ã— åˆ†ç´šï¼‰è‡ªå‹•è¨ˆç®—å¹³å‡èˆ‡ SDã€‚  
                    é€™è£¡åŒæ™‚æä¾›ã€Œ8 å¤§æŒ‡æ¨™é›·é”åœ–ã€èˆ‡ã€Œé—œéµæŒ‡æ¨™å‰ 10 é …ã€æ–¹ä¾¿æŠ“æ–¹å‘ã€‚
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>8 å¤§æŒ‡æ¨™é›·é”åœ–</b>
                  <span>0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
                </div>
                <div class="card-b">
                  <div class="radar-wrap">
                    <canvas id="coachRadar"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>é—œéµæŒ‡æ¨™ï¼šå­¸ç”Ÿ vs åŒç´šå¹³å‡ï¼ˆæœ€å¤š 10 é …ï¼‰</b>
                <span>ä¾ |Z| æœ€å¤§æ’åº</span>
              </div>
              <div class="card-b">
                <div class="chart-box">
                  <canvas id="barChart"></canvas>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>æ•™ç·´çŸ­è©•ï¼ˆå®Œæ•´ç‰ˆï¼‰</b>
                <span>è‡ªå‹•æ•´ç†å¼·å¼±é …</span>
              </div>
              <div class="card-b">
                <div class="coach-note-box" id="c_coachNote">è«‹å…ˆé¸æ“‡å­¸å“¡ã€‚</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>å®Œæ•´æª¢æ¸¬è¡¨ï¼ˆå« Z åˆ†æ•¸ï¼‰</b>
                <span>å¯ä½œç‚ºè¿½è¹¤ç´€éŒ„</span>
              </div>
              <div class="card-b">
                <table class="table">
                  <thead>
                    <tr>
                      <th>æŒ‡æ¨™</th>
                      <th>å­¸ç”Ÿ</th>
                      <th>åŒç´šå¹³å‡</th>
                      <th>SD</th>
                      <th>Z</th>
                      <th>è©•ä¼°</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

        </div>
      </div>

      <!-- RIGHT: å°é¢æ¿ï¼ˆå¯æ”¾æ¬Šé‡èªªæ˜ / ä½ ä¹‹å¾Œè¦åŠ çš„åŠ æ¬Šè¡¨ï¼‰ -->
      <div class="card">
        <div class="card-h">
          <b>æŒ‡æ¨™åŠ æ¬Šï¼ˆæ•™ç·´è³‡è¨Šï¼‰</b>
          <span>ä½ çµ¦çš„æ¬Šé‡å·²å¥—ç”¨</span>
        </div>
        <div class="card-b">
          <div class="muted" style="line-height:1.8">
            <b>ä¸‹è‚¢è‚ŒåŠ›</b>ï¼šç¡¬æ‹‰ 100%<br/>
            <b>ä¸‹è‚¢çˆ†ç™¼åŠ›</b>ï¼šIMTP 35%ï½œCMJ 25%ï½œBroad Jump 25%ï½œLateral Jump 15%<br/>
            <b>ä¸Šè‚¢è‚ŒåŠ›</b>ï¼šInverted Row 30%ï½œPush-up 30%ï½œGrip 25%ï½œPlank 15%<br/>
            <b>ä¸Šè‚¢çˆ†ç™¼åŠ›</b>ï¼šç«™å§¿éé ­æ‹‹ 30%ï½œæ™šå§¿éé ­æ‹‹ 20%ï½œç«™å§¿æ°´å¹³æ‹‹ 30%ï½œæ™šå§¿æ°´å¹³æ‹‹ 20%<br/>
            <b>é€Ÿåº¦</b>ï¼š10m 60%ï½œ20m 40%ï¼ˆè¶Šå°è¶Šå¥½ï¼‰<br/>
            <b>è®Šå‘èƒ½åŠ›</b>ï¼š5-10-5 45%ï½œSpider 35%ï¼ˆè¶Šå°è¶Šå¥½ï¼‰ï½œHop test 20%<br/>
            <b>åæ‡‰</b>ï¼šåæ‡‰ç‡ˆ 100%<br/>
            <b>ä»£è¬èƒ½åŠ›</b>ï¼šç›®å‰æœªæä¾›æ¬„ä½ â†’ æš«ä»¥ 50 é¡¯ç¤ºï¼ˆå¯ä¹‹å¾Œæ¥ YoYo / 1.2K / Beepï¼‰
          </div>
          <div class="muted" style="margin-top:10px">
            0â€“100 è½‰æ›æ–¹å¼ï¼š<b>Score = clamp(50 + ZÃ—15)</b>ï¼ˆZ=+1 ç´„ 65 åˆ†ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ==============================
  // 0) ä½ çš„è©¦ç®—è¡¨è¨­å®šï¼ˆè¦æ”¹ï¼‰
  // ==============================
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests: "æª¢æ¸¬æˆç¸¾"
  };

  // ==============================
  // 1) æ¬„ä½è¾¨è­˜ï¼ˆå®¹éŒ¯ï¼šåŒä¸€æ¦‚å¿µå¯èƒ½ä¸åŒæ¬„åï¼‰
  // ==============================
  const COL = {
    name: ["å§“å"],
    sex:  ["æ€§åˆ¥"],
    level:["åˆ†ç´š","å¹´ç´š","å¹´é½¡"],

    photo:["ç…§ç‰‡","Photo","photo","image","åœ–ç‰‡","åœ–ç‰‡ç¶²å€","ç…§ç‰‡ç¶²å€"],
    height:["èº«é«˜","èº«é«˜(cm)","height","Height"],
    weight:["é«”é‡","é‡é‡","é‡é‡(kg)","é«”é‡(kg)","weight","Weight"],

    date:["æœ€æ–°æª¢æ¸¬æ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ","æª¢æ¸¬æ—¥æœŸ"],

    // ä¸‹è‚¢è‚ŒåŠ›
    deadlift:["ç¡¬æ‹‰(kg)","ç¡¬æ‹‰","Deadlift","Deadlift(kg)"],

    // ä¸‹è‚¢çˆ†ç™¼åŠ›
    imtp:["IMTP(N)","IMTP","IMTP (RFD 200ms)","IMTP(RFD200ms)","IMTP RFD","RFD","IMTP(N) "],
    cmj:["CMJ(cm)","CMJ","å‚ç›´è·³(cm)","å‚ç›´è·³","Vertical Jump","VerticalJump"],
    broad:["ç«‹å®šè·³(m)","ç«‹å®šè·³","Broad jump (m)","Broad jump","BroadJump","Broad Jump"],
    lateralL:["å´å‘è·³(å·¦)(m)","å´å‘è·³(å·¦)","Lateral jump (L)","LateralJumpL","å´å‘è·³(å·¦)(cm)"],
    lateralR:["å´å‘è·³(å³)(m)","å´å‘è·³(å³)","Lateral jump (R)","LateralJumpR","å´å‘è·³(å³)(cm)"],

    // ä¸Šè‚¢è‚ŒåŠ›
    invRow:["åå‘åˆ’èˆ¹(æ¬¡æ•¸)","Inverted row(æ¬¡æ•¸)","Inverted row","Inverted Rows","åå‘åˆ’èˆ¹"],
    pushup:["ä¿¯è‡¥æ’(æ¬¡æ•¸)","Push up(æ¬¡æ•¸)","Push-ups(æ¬¡æ•¸)","Push up","Push-ups","ä¿¯è‡¥æ’"],
    grip:["æ¡åŠ›(kg)","æ¡åŠ›","Grip strength(kg)","Grip strength","Grip"],
    plank:["å¹³æ¿æ’(ç§’)","å¹³æ¿æ’","Plank(æ™‚é–“)","Plank","Plank(s)","å¹³æ¿æ’(æ™‚é–“)"],

    // ä¸Šè‚¢çˆ†ç™¼åŠ›ï¼ˆè—¥çƒï¼‰
    sohm:["ç«™å§¿éé ­æ‹‹","ç«™å§¿éé ­æ‹‹(è·é›¢)","Standing OH MB Throw"],
    kohm:["æ™šå§¿éé ­æ‹‹","è·ªå§¿éé ­æ‹‹","Kneeling OH MB Throw"],
    shmb:["ç«™å§¿æ°´å¹³æ‹‹","Standing Horizontal MB Throw"],
    khmb:["æ™šå§¿æ°´å¹³æ‹‹","è·ªå§¿æ°´å¹³æ‹‹","Kneeling Horizontal MB Throw"],

    // é€Ÿåº¦
    sprint10:["10ç±³è¡åˆº(ç§’)","10m sprint","10m Sprint","10m"],
    sprint20:["20ç±³è¡åˆº(ç§’)","20m sprint","20m Sprint","20m"],

    // è®Šå‘èƒ½åŠ›
    t505L:["505æ•æ·è·‘(å·¦)(ç§’)","505æ•æ·è·‘(å·¦)","505å·¦","505 L","505 (L)"],
    t505R:["505æ•æ·è·‘(å³)(ç§’)","505æ•æ·è·‘(å³)","505å³","505 R","505 (R)"],
    spider:["èœ˜è››è·‘(ç§’)","èœ˜è››è·‘","Spider test(ç§’)","Spider test","Spider"],
    hop:["Hop test(m/s)","Hop test","Hop"],

    // åæ‡‰
    react:["åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸)","åæ‡‰ç‡ˆæ¸¬è©¦","åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸) ","Reaction(æ¬¡æ•¸)","Reaction"]
  };

  // å“ªäº›æ¬„ä½è¶Šå°è¶Šå¥½
  function isLowerBetterMetric(label){
    const s = String(label || "");
    return (
      s.includes("ç§’") ||
      /sprint/i.test(s) ||
      s.includes("505") ||
      s.includes("èœ˜è››") ||
      s.includes("Spider")
    );
  }

  // ==============================
  // 2) åŠ æ¬Šè¨­å®šï¼ˆä½ çµ¦çš„ï¼‰
  // ==============================
  const WEIGHTS = {
    lowerStrength: { deadlift: 1.00 },

    lowerPower: { imtp: .35, cmj: .25, broad: .25, lateral: .15 },

    upperStrength: { invRow: .30, pushup: .30, grip: .25, plank: .15 },

    upperPower: { sohm: .30, kohm: .20, shmb: .30, khmb: .20 },

    speed: { sprint10: .60, sprint20: .40 },

    changeDir: { t505: .45, spider: .35, hop: .20 },

    reaction: { react: 1.00 },

    metabolic: { placeholder: 1.00 } // ç›®å‰å¾…è£œ
  };

  const RADAR_AXES = [
    { key:"lowerStrength", label:"ä¸‹è‚¢è‚ŒåŠ›" },
    { key:"lowerPower",    label:"ä¸‹è‚¢çˆ†ç™¼åŠ›" },
    { key:"upperStrength", label:"ä¸Šè‚¢è‚ŒåŠ›" },
    { key:"upperPower",    label:"ä¸Šè‚¢çˆ†ç™¼åŠ›" },
    { key:"speed",         label:"é€Ÿåº¦" },
    { key:"changeDir",     label:"è®Šå‘èƒ½åŠ›" },
    { key:"reaction",      label:"åæ‡‰" },
    { key:"metabolic",     label:"ä»£è¬èƒ½åŠ›" }
  ];

  // Z â†’ 0â€“100ï¼ˆ50=å¹³å‡ï¼‰
  function zToScore(z){
    if (z == null || isNaN(z)) return 50;
    const v = 50 + z * 15;
    return Math.max(0, Math.min(100, v));
  }

  // ==============================
  // 3) è®€ Sheet + å»ºç´¢å¼•
  // ==============================
  function csvUrlForSheet(sheetName){
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function loadSheet(sheetName){
    return new Promise((resolve,reject)=>{
      Papa.parse(csvUrlForSheet(sheetName),{
        download:true,
        header:true,
        complete:r=>resolve(r.data || []),
        error:reject
      });
    });
  }

  function getVal(row, keys){
    for (const k of keys){
      if (row && row[k] != null && String(row[k]).trim() !== "") return row[k];
    }
    return "";
  }

  function toNum(v){
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return isNaN(n) ? null : n;
  }

  function groupKeyOf(playerRow, testRow){
    const sex = (getVal(playerRow, COL.sex) || getVal(testRow, COL.sex) || "").trim() || "-";
    const level = (getVal(playerRow, COL.level) || getVal(testRow, COL.level) || "").trim() || "-";
    // è‹¥ä½ æœªä¾†çœŸçš„æœ‰ã€Œå¹´é½¡æ•¸å­—ã€å†åŠ é€²ä¾†ï¼š`${sex}|${age}|${level}`
    return `${sex}|${level}`;
  }

  let playersByName = new Map();
  let testsByName = new Map();
  let testsArray = [];
  let groupStats = new Map(); // groupKey -> { metricName -> {mean, sd} }

  // æœƒç•«çš„åœ–
  let radarPlayerChart = null;
  let radarCoachChart  = null;
  let barChart = null;

  // ==============================
  // 4) å»ºç«‹æ¯çµ„æ¯æ¬„ä½ mean/sd
  // ==============================
  function buildGroupStats(){
    const bucket = new Map(); // groupKey -> metricName -> values[]
    testsArray.forEach(row=>{
      const name = String(getVal(row, COL.name) || "").trim();
      if(!name) return;

      const playerRow = playersByName.get(name) || {};
      const gk = groupKeyOf(playerRow, row);

      if(!bucket.has(gk)) bucket.set(gk, new Map());

      const m = bucket.get(gk);

      Object.keys(row).forEach(k=>{
        if(!k) return;
        // å¿½ç•¥éæ•¸å€¼æ¬„ä½ï¼šå§“å/æ€§åˆ¥/åˆ†ç´š/æ—¥æœŸç­‰
        if (COL.name.includes(k) || COL.sex.includes(k) || COL.level.includes(k) || COL.date.includes(k)) return;

        const v = toNum(row[k]);
        if(v == null) return;

        if(!m.has(k)) m.set(k, []);
        m.get(k).push(v);
      });
    });

    groupStats = new Map();
    bucket.forEach((m,gk)=>{
      const stat = {};
      m.forEach((arr,metricName)=>{
        if(!arr.length) return;
        const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
        const variance = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length;
        const sd = Math.sqrt(variance);
        stat[metricName] = { mean, sd };
      });
      groupStats.set(gk, stat);
    });
  }

  // æ‰¾å‡º row è£¡å°æ‡‰æ¬„ä½çš„ã€Œå¯¦éš›æ¬„åã€+ æ•¸å€¼
  function pickMetric(row, keyList){
    for (const k of keyList){
      const v = toNum(row[k]);
      if(v != null) return { col: k, val: v };
    }
    return { col: null, val: null };
  }

  // å–å¾—æŸæ¸¬é©—é …ç›® Zï¼ˆä»¥å¯¦éš›æ¬„åçš„ mean/sd ç®—ï¼‰
  function zOfMetric(testRow, gk, colName, val){
    if(val == null || !colName) return null;
    const stats = groupStats.get(gk) || {};
    const s = stats[colName];
    if(!s || s.sd == null || s.sd === 0) return null;

    const lowerBetter = isLowerBetterMetric(colName);
    const z = lowerBetter ? (s.mean - val) / s.sd : (val - s.mean) / s.sd;
    return z;
  }

  // ==============================
  // 5) 8 å¤§æŒ‡æ¨™è¨ˆç®—ï¼ˆåŠ æ¬Š Zï¼‰
  // ==============================
  function calcCompositeZ(testRow, playerRow){
    const gk = groupKeyOf(playerRow, testRow);

    // helperï¼šå–å·¦å³å¹³å‡
    const avg2 = (a,b)=>{
      if(a == null && b == null) return null;
      if(a == null) return b;
      if(b == null) return a;
      return (a+b)/2;
    };

    // å…ˆæŠŠå¸¸ç”¨å€¼å–å‡ºä¾†ï¼ˆåŒ…å«å¯¦éš›æ¬„åï¼‰
    const deadlift = pickMetric(testRow, COL.deadlift);

    const imtp  = pickMetric(testRow, COL.imtp);
    const cmj   = pickMetric(testRow, COL.cmj);
    const broad = pickMetric(testRow, COL.broad);
    const latL  = pickMetric(testRow, COL.lateralL);
    const latR  = pickMetric(testRow, COL.lateralR);

    // lateral å¯èƒ½å·¦å³å…©æ¬„ï¼šä»¥æ•¸å€¼å¹³å‡ï¼Œä½† Z è¦ç”¨â€œåŒä¸€æ¬„â€çš„ mean/sd æ‰ç²¾æº–
    // é€™è£¡æ¡å‹™å¯¦ä½œæ³•ï¼šå¦‚æœå·¦å³éƒ½å­˜åœ¨ï¼Œå°±å…ˆç”¨å·¦å³å„è‡ª Z å†å¹³å‡ï¼›è‹¥åªæœ‰ä¸€é‚Šå°±ç”¨é‚£é‚Šã€‚
    const lateralZ = (()=>{
      const zl = zOfMetric(testRow, gk, latL.col, latL.val);
      const zr = zOfMetric(testRow, gk, latR.col, latR.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    const invRow = pickMetric(testRow, COL.invRow);
    const pushup = pickMetric(testRow, COL.pushup);
    const grip   = pickMetric(testRow, COL.grip);
    const plank  = pickMetric(testRow, COL.plank);

    const sohm = pickMetric(testRow, COL.sohm);
    const kohm = pickMetric(testRow, COL.kohm);
    const shmb = pickMetric(testRow, COL.shmb);
    const khmb = pickMetric(testRow, COL.khmb);

    const s10 = pickMetric(testRow, COL.sprint10);
    const s20 = pickMetric(testRow, COL.sprint20);

    const t505L = pickMetric(testRow, COL.t505L);
    const t505R = pickMetric(testRow, COL.t505R);
    const spider = pickMetric(testRow, COL.spider);
    const hop = pickMetric(testRow, COL.hop);

    const react = pickMetric(testRow, COL.react);

    // 505ï¼šå·¦å³å¹³å‡ï¼ŒZ ç”¨å·¦å³ Z å¹³å‡ï¼ˆæ¯”è¼ƒåˆç†ï¼‰
    const z505 = (()=>{
      const zl = zOfMetric(testRow, gk, t505L.col, t505L.val);
      const zr = zOfMetric(testRow, gk, t505R.col, t505R.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    // å„é … Z
    const z_deadlift = zOfMetric(testRow, gk, deadlift.col, deadlift.val);

    const z_imtp  = zOfMetric(testRow, gk, imtp.col,  imtp.val);
    const z_cmj   = zOfMetric(testRow, gk, cmj.col,   cmj.val);
    const z_broad = zOfMetric(testRow, gk, broad.col, broad.val);

    const z_invRow = zOfMetric(testRow, gk, invRow.col, invRow.val);
    const z_pushup = zOfMetric(testRow, gk, pushup.col, pushup.val);
    const z_grip   = zOfMetric(testRow, gk, grip.col,   grip.val);
    const z_plank  = zOfMetric(testRow, gk, plank.col,  plank.val);

    const z_sohm = zOfMetric(testRow, gk, sohm.col, sohm.val);
    const z_kohm = zOfMetric(testRow, gk, kohm.col, kohm.val);
    const z_shmb = zOfMetric(testRow, gk, shmb.col, shmb.val);
    const z_khmb = zOfMetric(testRow, gk, khmb.col, khmb.val);

    const z_s10 = zOfMetric(testRow, gk, s10.col, s10.val);
    const z_s20 = zOfMetric(testRow, gk, s20.col, s20.val);

    const z_spider = zOfMetric(testRow, gk, spider.col, spider.val);
    const z_hop    = zOfMetric(testRow, gk, hop.col, hop.val);

    const z_react = zOfMetric(testRow, gk, react.col, react.val);

    // åŠ æ¬Šåˆæˆï¼ˆåªåŠ æœ‰å€¼çš„é …ç›®ï¼Œä¸¦é‡ç®—æ¬Šé‡ç¸½å’Œé¿å…ç¼ºæ¬„ä½æ‹‰ä½åˆ†æ•¸ï¼‰
    const wsum = (pairs)=>{
      let num = 0, den = 0;
      for(const [z,w] of pairs){
        if(z == null || isNaN(z)) continue;
        num += z*w;
        den += w;
      }
      return den ? (num/den) : null;
    };

    const z_lowerStrength = wsum([[z_deadlift, WEIGHTS.lowerStrength.deadlift]]);

    const z_lowerPower = wsum([
      [z_imtp,  WEIGHTS.lowerPower.imtp],
      [z_cmj,   WEIGHTS.lowerPower.cmj],
      [z_broad, WEIGHTS.lowerPower.broad],
      [lateralZ,WEIGHTS.lowerPower.lateral]
    ]);

    const z_upperStrength = wsum([
      [z_invRow, WEIGHTS.upperStrength.invRow],
      [z_pushup, WEIGHTS.upperStrength.pushup],
      [z_grip,   WEIGHTS.upperStrength.grip],
      [z_plank,  WEIGHTS.upperStrength.plank]
    ]);

    const z_upperPower = wsum([
      [z_sohm, WEIGHTS.upperPower.sohm],
      [z_kohm, WEIGHTS.upperPower.kohm],
      [z_shmb, WEIGHTS.upperPower.shmb],
      [z_khmb, WEIGHTS.upperPower.khmb]
    ]);

    const z_speed = wsum([
      [z_s10, WEIGHTS.speed.sprint10],
      [z_s20, WEIGHTS.speed.sprint20]
    ]);

    const z_changeDir = wsum([
      [z505,     WEIGHTS.changeDir.t505],
      [z_spider, WEIGHTS.changeDir.spider],
      [z_hop,    WEIGHTS.changeDir.hop]
    ]);

    const z_reaction = wsum([[z_react, WEIGHTS.reaction.react]]);

    // ä»£è¬ï¼šå…ˆä½”ä½ï¼ˆ50ï¼‰
    const z_metabolic = null;

    return {
      groupKey: gk,
      zByAxis: {
        lowerStrength: z_lowerStrength,
        lowerPower: z_lowerPower,
        upperStrength: z_upperStrength,
        upperPower: z_upperPower,
        speed: z_speed,
        changeDir: z_changeDir,
        reaction: z_reaction,
        metabolic: z_metabolic
      }
    };
  }

  // ==============================
  // 6) UIï¼šè¼‰å…¥ã€åˆ‡æ›ã€æ¸²æŸ“
  // ==============================
  const el = (id)=>document.getElementById(id);

  async function reloadAll(){
    el("statusMsg").textContent = "å¾ Google Sheets è¼‰å…¥ä¸­â€¦";
    el("studentSelect").disabled = true;
    el("studentSelect").innerHTML = `<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>`;

    try{
      const [players, tests] = await Promise.all([
        loadSheet(SHEETS.players),
        loadSheet(SHEETS.tests)
      ]);

      playersByName = new Map();
      players.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) playersByName.set(n, r);
      });

      testsArray = tests || [];
      testsByName = new Map();
      testsArray.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) testsByName.set(n, r);
      });

      buildGroupStats();

      const names = Array.from(testsByName.keys()).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      el("studentSelect").innerHTML = `<option value="">â€” è«‹é¸æ“‡å­¸å“¡ â€”</option>`;
      names.forEach(n=>{
        const op = document.createElement("option");
        op.value = n; op.textContent = n;
        el("studentSelect").appendChild(op);
      });

      el("studentSelect").disabled = false;
      el("statusMsg").textContent = "è¼‰å…¥å®Œæˆï¼šè«‹é¸å­¸å“¡ã€‚";

    }catch(err){
      console.error(err);
      el("statusMsg").textContent = "è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèªè©¦ç®—è¡¨å·²å…¬é–‹ã€åˆ†é åç¨±æ­£ç¢ºï¼ˆå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ï¼‰ã€‚";
    }
  }

  // åˆ‡æ› view
  let currentView = "player"; // player | coach

  function setView(view){
    currentView = view;
    el("tabPlayer").classList.toggle("active", view==="player");
    el("tabCoach").classList.toggle("active", view==="coach");

    el("playerView").classList.toggle("hide", view!=="player");
    el("coachView").classList.toggle("hide", view!=="coach");

    if(view==="player"){
      el("viewTitle").textContent = "PLAYER VERSION";
      el("viewSubtitle").textContent = "çœ‹å¾—æ‡‚ã€çœ‹å¾—é‡é»ï¼šç…§ç‰‡ / åŸºæœ¬è³‡æ–™ / é›·é”åœ– / æœ¬é€± 3 ä»¶äº‹ / æ•™ç·´æé†’";
    }else{
      el("viewTitle").textContent = "COACH VERSION";
      el("viewSubtitle").textContent = "å®Œæ•´æ•¸æ“šï¼šé›·é”åœ– + é—œéµæŒ‡æ¨™å‰ 10 + å…¨è¡¨ï¼ˆå« Zï¼‰+ è‡ªå‹•çŸ­è©•";
    }
  }

  // ç”¢ç”Ÿã€Œæœ¬é€±3ä»¶äº‹ã€ï¼šå„ªå…ˆè£œå¼· 2 å€‹ + ç¶­æŒ 1 å€‹å„ªå‹¢
  function buildThreeThings(bestAxis, weakAxis){
    const axisTitle = (k)=> (RADAR_AXES.find(a=>a.key===k)?.label || k);

    const best = axisTitle(bestAxis);
    const weak1 = axisTitle(weakAxis[0]);
    const weak2 = axisTitle(weakAxis[1] || weakAxis[0]);

    return [
      { text:`æœ¬é€±ä¸»è»¸ï¼šæŠŠã€Œ${weak1}ã€æ’é€²æ¯é€± 2 æ¬¡å›ºå®šæ®µè½ï¼ˆç†±èº«å¾Œ 10â€“15 åˆ†é˜å°ˆé …ï¼‰ã€‚`, tag:"ä¸»è»¸" },
      { text:`ç¬¬äºŒå„ªå…ˆï¼šç”¨ 1 æ¬¡çŸ­èª²è¡¨è£œã€Œ${weak2}ã€ï¼Œé‡é»æ˜¯å‹•ä½œå“è³ªï¼Œä¸è¿½æ±‚çˆ†é‡ã€‚`, tag:"æ¬¡å„ªå…ˆ" },
      { text:`ç¶­æŒå„ªå‹¢ï¼šä¿ç•™ã€Œ${best}ã€çš„åˆºæ¿€ï¼ˆæ¯é€± 1 æ¬¡å³å¯ï¼‰ï¼Œé¿å…å„ªå‹¢æµå¤±ã€‚`, tag:"ç¶­æŒ" }
    ];
  }

  function rankAxes(zByAxis){
    const items = Object.keys(zByAxis).map(k=>({k, z:zByAxis[k]})).filter(x=>x.z!=null && !isNaN(x.z));
    items.sort((a,b)=>b.z-a.z);
    const best = items[0]?.k || "metabolic";
    const worst = items.slice().sort((a,b)=>a.z-b.z).map(x=>x.k);
    return { best, worst };
  }

  function renderPlayerPhoto(url){
    const box = el("playerPhotoBox");
    box.innerHTML = "";
    if(url){
      const img = document.createElement("img");
      img.src = url;
      img.alt = "player photo";
      box.appendChild(img);
    }else{
      const div = document.createElement("div");
      div.className = "ph-txt";
      div.innerHTML = "ï¼ˆå¯é¸ï¼‰æ”¾çƒå“¡æ‰“çƒç…§ç‰‡<br/>æ¬„ä½ï¼š<b>ç…§ç‰‡</b>ï¼ˆURLï¼‰";
      box.appendChild(div);
    }
  }

  function renderRadar(canvasId, scores, avgLine=true){
    const ctx = document.getElementById(canvasId).getContext("2d");
    const labels = RADAR_AXES.map(a=>a.label);

    const yourData = RADAR_AXES.map(a=>scores[a.key] ?? 50);
    const avgData  = labels.map(_=>50);

    const config = {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "ä½ ï¼ˆåˆ†æ•¸ï¼‰",
            data: yourData,
            borderColor: "rgba(248,113,113,.95)",
            backgroundColor: "rgba(248,113,113,.20)",
            pointBackgroundColor: "rgba(248,113,113,.95)",
            pointRadius: 3,
            borderWidth: 2
          },
          ...(avgLine ? [{
            label: "åŒç´šå¹³å‡ï¼ˆå›ºå®š 50ï¼‰",
            data: avgData,
            borderColor: "rgba(148,163,184,.55)",
            backgroundColor: "rgba(148,163,184,.06)",
            pointRadius: 0,
            borderWidth: 1
          }] : [])
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{
            labels:{ color:"#cbd5e1", boxWidth:18, font:{ size: 12 } }
          }
        },
        scales:{
          r:{
            min:0, max:100,
            ticks:{ color:"#94a3b8", backdropColor:"transparent", stepSize:10, font:{ size: 10 } },
            grid:{ color:"rgba(148,163,184,.16)" },
            angleLines:{ color:"rgba(148,163,184,.14)" },
            pointLabels:{ color:"#e2e8f0", font:{ size: 12 } }
          }
        }
      }
    };
    return new Chart(ctx, config);
  }

  function evalTag(z){
    if(z == null || isNaN(z)) return `<span class="tagpill">â€”</span>`;
    if(z >= 1) return `<span class="tagpill good">å„ªæ–¼åŒç´š</span>`;
    if(z <= -0.5) return `<span class="tagpill bad">å»ºè­°è£œå¼·</span>`;
    return `<span class="tagpill mid">æ¥è¿‘åŒç´š</span>`;
  }

  function renderCoachBar(keyMetrics){
    const ctx = document.getElementById("barChart").getContext("2d");
    if(barChart) barChart.destroy();

    barChart = new Chart(ctx,{
      type:"bar",
      data:{
        labels: keyMetrics.map(x=>x.label),
        datasets:[
          { label:"å­¸å“¡", data:keyMetrics.map(x=>x.latest), backgroundColor:"rgba(34,197,94,.80)" },
          { label:"åŒç´šå¹³å‡", data:keyMetrics.map(x=>x.mean), backgroundColor:"rgba(56,189,248,.80)" }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ ticks:{ color:"#cbd5e1", font:{ size: 11 } }, grid:{ display:false } },
          y:{ ticks:{ color:"#94a3b8", font:{ size: 11 } }, grid:{ color:"rgba(148,163,184,.14)" } }
        }
      }
    });
  }

  function loadStudent(){
    const name = el("studentSelect").value;
    if(!name) return;

    const testRow = testsByName.get(name);
    const playerRow = playersByName.get(name) || {};

    if(!testRow){
      el("statusMsg").textContent = `æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„æª¢æ¸¬æˆç¸¾ã€‚`;
      return;
    }

    // group key
    const gk = groupKeyOf(playerRow, testRow);

    // åŸºæœ¬è³‡æ–™ï¼ˆplayer sheet å„ªå…ˆï¼‰
    const sex = (getVal(playerRow, COL.sex) || getVal(testRow, COL.sex) || "-").trim() || "-";
    const level = (getVal(playerRow, COL.level) || getVal(testRow, COL.level) || "-").trim() || "-";
    const date = (getVal(playerRow, COL.date) || getVal(testRow, COL.date) || "-").trim() || "-";

    const height = (getVal(playerRow, COL.height) || "-").toString().trim() || "-";
    const weight = (getVal(playerRow, COL.weight) || "-").toString().trim() || "-";
    const photo  = (getVal(playerRow, COL.photo) || "").toString().trim();

    // è¨ˆç®— 8 å¤§æŒ‡æ¨™
    const comp = calcCompositeZ(testRow, playerRow);
    const zByAxis = comp.zByAxis;

    const scores = {};
    Object.keys(zByAxis).forEach(k=>{
      scores[k] = zToScore(zByAxis[k]);
    });

    // æ‰¾æœ€å¼·/æœ€å¼±ï¼ˆä»¥ Zï¼‰
    const { best, worst } = rankAxes(zByAxis);
    const weakPick = worst.slice(0,2);
    const bestAxis = best;

    const bestLabel = (RADAR_AXES.find(a=>a.key===bestAxis)?.label || bestAxis);
    const weakLabels = weakPick.map(k=>RADAR_AXES.find(a=>a.key===k)?.label || k);

    // ====== çƒå“¡ç‰ˆæ¸²æŸ“ ======
    el("p_name").textContent = name;
    el("p_sex").textContent = sex;
    el("p_level").textContent = level;
    el("p_height").textContent = (height && height!=="-") ? `${height}` : "â€”";
    el("p_weight").textContent = (weight && weight!=="-") ? `${weight}` : "â€”";
    el("p_groupKey").textContent = `${sex}ãƒ»${level}`;
    el("p_date").textContent = date || "â€”";

    renderPlayerPhoto(photo);

    el("p_bestText").textContent = `${bestLabel}ï¼ˆZ=${(zByAxis[bestAxis] ?? 0).toFixed(2)}ï¼‰`;
    el("p_weakText").textContent = weakLabels.length
      ? weakLabels.map((lbl,i)=> `${lbl}ï¼ˆZ=${(zByAxis[weakPick[i]] ?? 0).toFixed(2)}ï¼‰`).join("ã€")
      : "ç›®å‰æ²’æœ‰é¡¯è‘—å¼±é …ï¼ˆæ¥è¿‘åŒç´šå¹³å‡ï¼‰";

    // æœ¬é€± 3 ä»¶äº‹
    const todo = buildThreeThings(bestAxis, weakPick.length?weakPick:["speed","changeDir"]);
    el("p_todoList").innerHTML = todo.map(x=>`<li>${x.text}<span class="tag">${x.tag}</span></li>`).join("");

    // Coach noteï¼ˆplayer versionï¼‰â€” ç¨ç«‹æ¡†
    el("p_coachNote").innerHTML = `
      ç¶œåˆä¾†çœ‹ï¼Œ<b>${name}</b> åœ¨åŒçµ„ï¼ˆ${sex}ãƒ»${level}ï¼‰ä¸­ï¼š<br/><br/>
      ãƒ»æœ€å¼·æ–¹å‘ï¼š<b>${bestLabel}</b>ï¼ˆZ=${(zByAxis[bestAxis] ?? 0).toFixed(2)}ï¼‰<br/>
      ãƒ»å„ªå…ˆè£œå¼·ï¼š<b>${weakLabels[0] || "â€”"}</b>${weakLabels[1] ? `ã€<b>${weakLabels[1]}</b>` : ""}<br/><br/>
      é€™ä»½çƒå“¡ç‰ˆåªè¦è¨˜ä½ä¸€å¥ï¼š<b>æœ¬é€±å…ˆæŠŠ 1â€“2 å€‹å¼±é …æ‹‰å›å¹³å‡ç·šé™„è¿‘</b>ï¼Œç©©å®šåº¦æœƒå…ˆä¸Šä¾†ã€‚
    `;

    // Radarï¼ˆplayerï¼‰
    if(radarPlayerChart) radarPlayerChart.destroy();
    radarPlayerChart = renderRadar("playerRadar", scores, true);

    // ====== æ•™ç·´ç‰ˆæ¸²æŸ“ ======
    el("c_name").textContent = name;
    el("c_groupKey").textContent = `${sex}ãƒ»${level}`;
    el("c_sex").textContent = sex;
    el("c_level").textContent = level;
    el("c_date").textContent = date || "â€”";
    el("c_hw").textContent = `${(height && height!=="-"?height:"â€”")} / ${(weight && weight!=="-"?weight:"â€”")}`;

    if(radarCoachChart) radarCoachChart.destroy();
    radarCoachChart = renderRadar("coachRadar", scores, true);

    // çµ„å…§ mean/sdï¼ˆç”¨æ–¼è¡¨æ ¼èˆ‡ barï¼‰
    const stats = groupStats.get(gk) || {};

    // å»ºè¡¨ï¼šæŠŠ testRow çš„æ•¸å€¼æ¬„ä½æ•´ç†å‡ºä¾†ï¼ˆæ’é™¤å§“å/æ€§åˆ¥/åˆ†ç´š/æ—¥æœŸï¼‰
    const rows = [];
    Object.keys(testRow).forEach(k=>{
      if(!k) return;
      if (COL.name.includes(k) || COL.sex.includes(k) || COL.level.includes(k) || COL.date.includes(k)) return;
      const latest = toNum(testRow[k]);
      if(latest == null) return;

      const s = stats[k] || {};
      const mean = (s.mean==null?null:s.mean);
      const sd = (s.sd==null?null:s.sd);

      let z = null;
      if(mean != null && sd != null && sd !== 0){
        const lowerBetter = isLowerBetterMetric(k);
        z = lowerBetter ? (mean - latest)/sd : (latest - mean)/sd;
      }

      rows.push({ label:k, latest, mean, sd, z });
    });

    // é—œéµæŒ‡æ¨™å‰ 10ï¼ˆ|Z| æœ€å¤§ï¼‰
    const keyMetrics = rows.filter(r=>r.z!=null).sort((a,b)=>Math.abs(b.z)-Math.abs(a.z)).slice(0,10);
    renderCoachBar(keyMetrics);

    // è¡¨æ ¼ï¼šå…ˆæ”¾é—œéµå†æ”¾å…¶ä»–
    const keySet = new Set(keyMetrics.map(r=>r.label));
    const sorted = rows.slice().sort((a,b)=>{
      const ak = keySet.has(a.label), bk = keySet.has(b.label);
      if(ak !== bk) return bk-ak;
      if(a.z==null && b.z==null) return a.label.localeCompare(b.label,"zh-Hant");
      if(a.z==null) return 1;
      if(b.z==null) return -1;
      return Math.abs(b.z)-Math.abs(a.z);
    });

    el("tableBody").innerHTML = sorted.map(r=>{
      let extra = "";
      if(keySet.has(r.label)) extra = ` <span class="tagpill key">é—œéµæŒ‡æ¨™</span>`;
      return `
        <tr>
          <td>${r.label}</td>
          <td>${r.latest ?? "â€”"}</td>
          <td>${r.mean != null ? r.mean.toFixed(2) : "â€”"}</td>
          <td>${r.sd != null ? r.sd.toFixed(2) : "â€”"}</td>
          <td>${r.z != null ? r.z.toFixed(2) : "â€”"}</td>
          <td>${evalTag(r.z)}${extra}</td>
        </tr>
      `;
    }).join("");

    // æ•™ç·´çŸ­è©•ï¼ˆå®Œæ•´ç‰ˆï¼‰
    const strengths = rows.filter(r=>r.z!=null && r.z>=1).sort((a,b)=>b.z-a.z).slice(0,3);
    const weaknesses = rows.filter(r=>r.z!=null && r.z<=-0.5).sort((a,b)=>a.z-b.z).slice(0,3);

    const listText = arr => arr.length
      ? arr.map(x=>`${x.label}ï¼ˆZ=${x.z.toFixed(2)}ï¼‰`).join("ã€")
      : "ç„¡ï¼ˆå¤šæ•¸æ¥è¿‘åŒç´šå¹³å‡ï¼‰";

    el("c_coachNote").innerHTML = `
      æ ¹æ“šæœ¬æ¬¡æª¢æ¸¬ï¼Œ<b>${name}</b> èˆ‡åŒçµ„ï¼ˆ${sex}ãƒ»${level}ï¼‰ç›¸æ¯”ï¼š<br/><br/>
      ãƒ»ä¸»è¦å„ªå‹¢ï¼š${listText(strengths)}<br/>
      ãƒ»å»ºè­°è£œå¼·ï¼š${listText(weaknesses)}<br/><br/>
      å»ºè­°ï¼šè£œå¼·é …ç›®æ’å…¥æ¯é€±å›ºå®šç¯€é»ï¼ˆç†±èº«å¾Œ 10â€“15 åˆ†é˜ï¼‰ï¼Œä¸¦ä¿ç•™å„ªå‹¢é …ç›®æ¯é€± 1 æ¬¡åˆºæ¿€ï¼Œé¿å…å„ªå‹¢æµå¤±ã€‚
    `;

    el("statusMsg").textContent = "";
  }

  // ==============================
  // 7) PDF è¼¸å‡ºï¼ˆçƒå“¡ç‰ˆ / æ•™ç·´ç‰ˆï¼‰
  // ==============================
  async function exportPDF(mode){
    const { jsPDF } = window.jspdf;
    const name = (el("studentSelect").value || "report").trim() || "report";

    // æš«æ™‚åˆ‡æ›åˆ°è¦è¼¸å‡ºçš„ viewï¼ˆé¿å…æˆªéŒ¯ï¼‰
    const original = currentView;
    if(mode==="player") setView("player");
    if(mode==="coach") setView("coach");

    // è®“ DOM å®Œæ•´åˆ·æ–°ï¼ˆå¾ˆé‡è¦ï¼‰
    await new Promise(r=>setTimeout(r, 80));

    const surface = document.getElementById("mainSurface"); // åªæˆªä¸»å…§å®¹
    const canvas = await html2canvas(surface, {
      scale: 3,
      backgroundColor: "#020617",
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p","mm","a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let position = 0;
    let heightLeft = imgHeight;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position -= pageHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
      heightLeft -= pageHeight;
    }

    const suffix = mode==="player" ? "Player" : "Coach";
    pdf.save(`MatchPointLab-${suffix}-${name}.pdf`);

    // åˆ‡å›åŸ view
    setView(original);
  }

  // ==============================
  // 8) ç¶äº‹ä»¶
  // ==============================
  el("reloadBtn").addEventListener("click", reloadAll);
  el("studentSelect").addEventListener("change", loadStudent);

  el("tabPlayer").addEventListener("click", ()=>setView("player"));
  el("tabCoach").addEventListener("click", ()=>setView("coach"));

  el("pdfPlayerBtn").addEventListener("click", async ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    await exportPDF("player");
  });

  el("pdfCoachBtn").addEventListener("click", async ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    await exportPDF("coach");
  });

  // åˆå§‹
  setView("player");
  reloadAll();
</script>
</body>
</html>
