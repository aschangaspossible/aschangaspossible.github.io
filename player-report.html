<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥•æ™‰ç¶²çƒå­¸é™¢ï½œé«”èƒ½æª¢æ¸¬å ±å‘Šï¼ˆçƒå“¡ç‰ˆ/æ•™ç·´ç‰ˆï¼‰</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#071024;
      --card:#0b1226;
      --card2:#0b1a2f;
      --line:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --sub:#94a3b8;
      --muted:#64748b;
      --good:#22c55e;
      --warn:#facc15;
      --bad:#f87171;
      --blue:#38bdf8;
      --radius:18px;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(34,197,94,.18) 0, transparent 55%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 62%);
      min-height:100vh;
    }

    .wrap{
      max-width: 1180px;
      margin: 24px auto 60px;
      padding: 0 14px;
    }

    .topbar{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(10,18,38,.92), rgba(6,10,20,.92));
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 15% 0, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 85% 0, rgba(34,197,94,.22), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }

    .topbar-inner{
      position:relative;
      padding: 16px 16px 14px;
    }

    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      margin-bottom: 12px;
    }

    .brand-left{
      display:flex; align-items:center; gap:12px;
    }

    .logo{
      width:38px; height:38px; border-radius:999px;
      border:2px solid rgba(34,197,94,.85);
      box-shadow: 0 0 24px rgba(34,197,94,.5);
      object-fit:cover;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
    }

    .brand-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand-title b{
      font-size: 16px;
      letter-spacing:.12em;
    }
    .brand-title span{
      font-size: 12px;
      color: var(--sub);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.55);
      color: var(--sub);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 12px var(--good);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding-top: 6px;
    }

    label{ color: var(--sub); font-size: 13px; }

    select{
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--text);
      outline:none;
    }

    .btn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
      color: var(--sub);
      cursor:pointer;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(248,250,252,.65); color: var(--text); }

    .btn-primary{
      border: none;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(56,189,248,.95));
      color:#021018;
      font-weight: 800;
      box-shadow: 0 14px 40px rgba(34,197,94,.25);
    }

    .btn-tab{
      border: 1px solid rgba(148,163,184,.30);
      background: rgba(2,6,23,.35);
      color: var(--sub);
    }
    .btn-tab.active{
      border-color: rgba(34,197,94,.75);
      box-shadow: 0 0 0 3px rgba(34,197,94,.14);
      color: #d1fae5;
    }

    .status{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(6,10,20,.92));
      box-shadow: 0 18px 52px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .card-h{
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(148,163,184,.16);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{
      font-size: 13px;
      letter-spacing:.16em;
      color: rgba(226,232,240,.92);
      text-transform: uppercase;
    }
    .card-h span{
      font-size: 12px;
      color: var(--muted);
    }

    .card-b{
      padding: 14px 16px 16px;
    }

    .muted{ color: var(--sub); font-size: 12px; line-height:1.65; }

    .player-hero{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    .photo{
      border: 1px dashed rgba(148,163,184,.28);
      border-radius: 16px;
      min-height: 220px;
      background: rgba(2,6,23,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .photo img{ width:100%; height:100%; object-fit: cover; display:block; }
    .photo .ph-txt{ color: rgba(148,163,184,.7); font-size: 12px; text-align:center; line-height:1.6; padding: 10px; }

    .player-info h2{
      margin: 2px 0 8px;
      font-size: 22px;
      letter-spacing: .06em;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 10px; }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.24);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-size: 12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .chip b{ color: rgba(226,232,240,.94); font-weight:700; }

    .two-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .radar-wrap{
      height: 360px;
      padding: 10px 6px 0;
    }

    .todo{
      border:1px solid rgba(148,163,184,.18);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(2,6,23,.25);
    }
    .todo ol{ margin: 0; padding-left: 18px; }
    .todo li{ margin: 8px 0; color: rgba(226,232,240,.9); line-height:1.7; }
    .todo .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 8px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,.22);
      color: var(--sub);
      background: rgba(2,6,23,.35);
    }

    .badge-row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .badge{
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.22);
      font-size: 13px;
      line-height:1.7;
      color: rgba(226,232,240,.88);
    }
    .badge .dot{
      width:10px; height:10px; border-radius:999px;
      margin-top: 6px;
      background: var(--blue);
      box-shadow: 0 0 14px rgba(56,189,248,.55);
      flex: 0 0 auto;
    }
    .badge.good .dot{ background: var(--good); box-shadow: 0 0 14px rgba(34,197,94,.55); }
    .badge.bad .dot{ background: var(--bad); box-shadow: 0 0 14px rgba(248,113,113,.55); }

    .coach-note-box{
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px 12px;
      line-height:1.75;
      color: rgba(226,232,240,.88);
      font-size: 13px;
    }
    .coach-note-box b{ color: #bbf7d0; }

    .coach-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .chart-box{ height: 260px; }
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
    }
    .table th,.table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      text-align:right;
      color: rgba(226,232,240,.9);
      white-space: nowrap;
    }
    .table th:first-child,.table td:first-child{ text-align:left; white-space: normal; width: 28%; }
    .table thead th{ color: rgba(226,232,240,.8); font-weight: 700; background: rgba(2,6,23,.35); }

    .tagpill{
      display:inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    .tagpill.good{ border-color: rgba(34,197,94,.55); color:#bbf7d0; }
    .tagpill.mid{ border-color: rgba(250,204,21,.55); color:#fde68a; }
    .tagpill.bad{ border-color: rgba(248,113,113,.55); color:#fecaca; }
    .tagpill.key{ border-color: rgba(59,130,246,.55); color:#bfdbfe; }

    .pdf-surface{
      border-radius: 22px;
      overflow:hidden;
    }

    .hide{ display:none !important; }

    .print-only{ display:none !important; }
    body.exporting .no-print{ display:none !important; }
    body.exporting .print-only{ display:block !important; }

    textarea{
      width:100%;
      min-height: 124px;
      resize: vertical;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
      line-height: 1.75;
      font-size: 13px;
    }

    .editor-actions{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .editor-actions .left{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px){
      .player-hero{ grid-template-columns: 1fr; }
      .two-cols{ grid-template-columns: 1fr; }
      .coach-grid{ grid-template-columns: 1fr; }
      .status{ width: 100%; margin-left:0; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-left">
            <img class="logo" src="https://aschangaspossible.github.io/logo.jpeg" alt="logo" />
            <div class="brand-title">
              <b>å¥•æ™‰ç¶²çƒå­¸é™¢ï½œé«”èƒ½æª¢æ¸¬å ±å‘Š</b>
              <span>çƒå“¡ç‰ˆï¼ˆå«å®¶é•·ï¼‰ / æ•™ç·´ç‰ˆï¼ˆå®Œæ•´ç‰ˆï¼‰ï½œåŒç´šæ¯”è¼ƒè‡ªå‹•ç®— Z â†’ è½‰æˆ 0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
            </div>
          </div>
          <div class="pill"><span class="dot"></span><span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°</span></div>
        </div>

        <div class="controls">
          <label for="studentSelect">é¸æ“‡å­¸å“¡ï¼š</label>
          <select id="studentSelect" disabled>
            <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
          </select>

          <button class="btn" id="reloadBtn">ğŸ”„ é‡æ–°è¼‰å…¥</button>

          <button class="btn btn-tab active" id="tabPlayer">ğŸŸ¢ çƒå“¡ç‰ˆï¼ˆå«å®¶é•·ï¼‰</button>
          <button class="btn btn-tab" id="tabCoach">ğŸ“Š æ•™ç·´ç‰ˆï¼ˆå®Œæ•´ç‰ˆï¼‰</button>

          <button class="btn btn-primary" id="pdfPlayerBtn">ğŸ“„ çƒå“¡ç‰ˆ PDF</button>
          <button class="btn btn-primary" id="pdfCoachBtn">ğŸ“„ æ•™ç·´ç‰ˆ PDF</button>

          <span class="status" id="statusMsg">â€”</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card pdf-surface" id="mainSurface">
        <div class="card-h">
          <b id="viewTitle">PLAYER VERSION</b>
          <span id="viewSubtitle">çœ‹å¾—æ‡‚ã€çœ‹å¾—é‡é»ï¼šç…§ç‰‡ / åŸºæœ¬è³‡æ–™ / é›·é”åœ– / æœ¬é€± 3 ä»¶äº‹ / æ•™ç·´æé†’</span>
        </div>

        <div class="card-b">

          <!-- ============ çƒå“¡ç‰ˆ ============ -->
          <section id="playerView">
            <div class="player-hero">
              <div class="photo" id="playerPhotoBox">
                <div class="ph-txt">
                  ï¼ˆå¯é¸ï¼‰æ”¾çƒå“¡æ‰“çƒç…§ç‰‡<br/>
                  æ¬„ä½ï¼š<b>ç…§ç‰‡</b>ï¼ˆURLï¼‰
                </div>
              </div>

              <div class="player-info">
                <h2 id="p_name">â€”</h2>
                <div class="chips">
                  <div class="chip">æ€§åˆ¥ï¼š<b id="p_sex">â€”</b></div>
                  <div class="chip">åˆ†ç´šï¼š<b id="p_level">â€”</b></div>
                  <div class="chip">èº«é«˜ï¼š<b id="p_height">â€”</b></div>
                  <div class="chip">é«”é‡ï¼š<b id="p_weight">â€”</b></div>
                  <div class="chip">åŒç´šæ¯”è¼ƒï¼š<b id="p_groupKey">â€”</b></div>
                  <div class="chip">æœ€è¿‘æª¢æ¸¬ï¼š<b id="p_date">â€”</b></div>
                </div>

                <div class="badge-row">
                  <div class="badge good" id="p_bestBadge">
                    <span class="dot"></span>
                    <div>
                      <b>ä½ æœ€å¼·çš„æ–¹å‘ï¼š</b>
                      <span id="p_bestText">â€”</span>
                    </div>
                  </div>
                  <div class="badge bad" id="p_weakBadge">
                    <span class="dot"></span>
                    <div>
                      <b>å„ªå…ˆè£œå¼·ï¼š</b>
                      <span id="p_weakText">â€”</span>
                    </div>
                  </div>
                </div>

                <div style="margin-top:12px" class="muted">
                  <br/> é›·é”åœ–åˆ†æ•¸ç‚º 0â€“100ï¼Œå…¶ä¸­ <b>50 ä»£è¡¨åŒç´šå¹³å‡</b>ï¼ˆåŒçµ„ = æ€§åˆ¥ Ã— åˆ†ç´šï¼‰ã€‚
                </div>
              </div>
            </div>

            <div class="two-cols">
              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>8 å¤§æŒ‡æ¨™é›·é”åœ–</b>
                  <span>0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
                </div>
                <div class="card-b">
                  <div class="radar-wrap">
                    <canvas id="playerRadar"></canvas>
                  </div>
                  <div class="muted" style="margin-top:6px">
                    ç°è‰²ç·š = å›ºå®š 50ï¼ˆåŒç´šå¹³å‡åŸºæº–ï¼‰ã€‚ç´…è‰² = ä½ çš„åˆ†æ•¸ã€‚
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>è¨“ç·´å»ºè­°ï¼ˆåªåš 3 ä»¶äº‹ï¼‰</b>
                  <span>æ•™ç·´è™•æ–¹ </span>
                </div>
                <div class="card-b">
                  <div class="todo">
                    <ol id="p_todoList">
                      <li>è«‹å…ˆé¸æ“‡å­¸å“¡ï¼ˆæ•™ç·´æœƒåœ¨æ•™ç·´ç‰ˆå¡«å¯«ï¼‰</li>
                    </ol>
                  </div>
                  <div class="muted" style="margin-top:10px">
                    é€™ 3 é»æ˜¯ã€Œæ•™ç·´çµ¦ä½ çš„è™•æ–¹ã€ã€‚åšå®Œï¼Œæ¯”åšæ›´å¤šæ›´é‡è¦ã€‚
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>COACH NOTE</b>
                <span>ä¸€æ®µè©±è¬›æ¸…æ¥š</span>
              </div>
              <div class="card-b">
                <div class="coach-note-box" id="p_coachNote">
                  è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆæé†’å…§å®¹ã€‚
                </div>
              </div>
            </div>
          </section>

          <!-- ============ æ•™ç·´ç‰ˆ ============ -->
          <section id="coachView" class="hide">
            <div class="coach-grid">
              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>PLAYER PROFILE</b>
                  <span>æ•™ç·´ç”¨</span>
                </div>
                <div class="card-b">
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="chip">å§“åï¼š<b id="c_name">â€”</b></div>
                    <div class="chip">åŒç´šï¼š<b id="c_groupKey">â€”</b></div>
                    <div class="chip">æ€§åˆ¥ï¼š<b id="c_sex">â€”</b></div>
                    <div class="chip">åˆ†ç´šï¼š<b id="c_level">â€”</b></div>
                    <div class="chip">æœ€è¿‘æª¢æ¸¬ï¼š<b id="c_date">â€”</b></div>
                    <div class="chip">èº«é«˜/é«”é‡ï¼š<b id="c_hw">â€”</b></div>
                  </div>
                  <div class="muted" style="margin-top:10px">
                    Z åˆ†æ•¸åŸºæº–ï¼šåŒçµ„ï¼ˆæ€§åˆ¥ Ã— åˆ†ç´šï¼‰è‡ªå‹•è¨ˆç®—å¹³å‡èˆ‡ SDã€‚  
                    é€™è£¡æä¾›ã€Œé›·é”åœ–ï¼‹é—œéµæŒ‡æ¨™å‰ 10ï¼‹å…¨è¡¨ï¼ˆå« Zï¼‰ã€æ–¹ä¾¿æŠ“æ–¹å‘ã€‚
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none">
                <div class="card-h">
                  <b>8 å¤§æŒ‡æ¨™é›·é”åœ–</b>
                  <span>0â€“100ï¼ˆ50=åŒç´šå¹³å‡ï¼‰</span>
                </div>
                <div class="card-b">
                  <div class="radar-wrap">
                    <canvas id="coachRadar"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>æœ¬é€±è¨“ç·´è™•æ–¹ï¼ˆ3 é»ï½œæ•™ç·´å¯ç·¨è¼¯ï¼‰</b>
                <span>ç°¡ç‰ˆçµ¦çƒå“¡ / å®Œæ•´ç‰ˆçµ¦æ•™ç·´</span>
              </div>
              <div class="card-b">

                <div class="no-print">
                  <div class="muted" style="margin-bottom:10px; line-height:1.8">
                    å»ºè­°å¯«æ³•ï¼š<b>ã€Œç›®çš„ â†’ åŠŸé‡ â†’ å“è³ªæ¨™æº–ã€</b><br/>
                    ä¾‹ï¼šä¸‹è‚¢çˆ†ç™¼åŠ›ï½œCMJ 3Ã—5ï½œè½åœ°å®‰éœã€è†è“‹å°é½Šã€ä¼‘æ¯ 60â€“90s
                  </div>

                  <div class="card" style="box-shadow:none; margin-bottom:12px">
                    <div class="card-h">
                      <b>çƒå“¡ç°¡ç‰ˆï¼ˆçƒå“¡ç‰ˆæœƒçœ‹åˆ°ï¼‰</b>
                      <span>çŸ­ã€æ¸…æ¥šã€å¯åŸ·è¡Œ</span>
                    </div>
                    <div class="card-b">
                      <textarea id="coachPlanSimple" placeholder="ä¸€è¡Œä¸€é»ï¼ˆæœ€å¤š 3 é»ï¼‰&#10;1.&#10;2.&#10;3."></textarea>
                    </div>
                  </div>

                  <div class="card" style="box-shadow:none">
                    <div class="card-h">
                      <b>æ•™ç·´å®Œæ•´ç‰ˆï¼ˆæ•™ç·´ç‰ˆ PDF æœƒç”¨é€™çµ„ï¼‰</b>
                      <span>å¯æ›´å°ˆæ¥­ã€å¯å¯«ç´°ç¯€</span>
                    </div>
                    <div class="card-b">
                      <textarea id="coachPlanFull" placeholder="ä¸€è¡Œä¸€é»ï¼ˆæœ€å¤š 3 é»ï¼‰&#10;1.&#10;2.&#10;3."></textarea>

                      <div class="editor-actions">
                        <div class="left">
                          <button class="btn btn-tab" id="savePlanBtn">ğŸ’¾ å„²å­˜è™•æ–¹</button>
                          <button class="btn btn-tab" id="resetPlanBtn">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                        <div class="hint" id="planStatus">æœªå„²å­˜</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="print-only">
                  <div class="muted" style="margin-bottom:8px">çƒå“¡ç°¡ç‰ˆï¼ˆ3 é»ï¼‰</div>
                  <div class="todo"><ol id="printPlanSimple"></ol></div>
                  <div class="muted" style="margin:14px 0 8px">æ•™ç·´å®Œæ•´ç‰ˆï¼ˆ3 é»ï¼‰</div>
                  <div class="todo"><ol id="printPlanFull"></ol></div>
                </div>

              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>é—œéµæŒ‡æ¨™ï¼šå­¸ç”Ÿ vs åŒç´šå¹³å‡ï¼ˆæœ€å¤š 10 é …ï¼‰</b>
                <span>ä¾ |Z| æœ€å¤§æ’åº</span>
              </div>
              <div class="card-b">
                <div class="chart-box">
                  <canvas id="barChart"></canvas>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>æ•™ç·´çŸ­è©•ï¼ˆå®Œæ•´ç‰ˆï¼‰</b>
                <span>è‡ªå‹•æ•´ç†å¼·å¼±é …</span>
              </div>
              <div class="card-b">
                <div class="coach-note-box" id="c_coachNote">è«‹å…ˆé¸æ“‡å­¸å“¡ã€‚</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-top:14px">
              <div class="card-h">
                <b>å®Œæ•´æª¢æ¸¬è¡¨ï¼ˆå« Z åˆ†æ•¸ï¼‰</b>
                <span>å¯ä½œç‚ºè¿½è¹¤ç´€éŒ„</span>
              </div>
              <div class="card-b">
                <table class="table">
                  <thead>
                    <tr>
                      <th>æŒ‡æ¨™</th>
                      <th>å­¸ç”Ÿ</th>
                      <th>åŒç´šå¹³å‡</th>
                      <th>SD</th>
                      <th>Z</th>
                      <th>è©•ä¼°</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

        </div>
      </div>
    </div>

    <div class="card" id="weightCard" style="margin-top:16px">
      <div class="card-h" style="cursor:pointer" id="weightToggle">
        <b>ğŸ“Š æŒ‡æ¨™åŠ æ¬Šèˆ‡è¨ˆç®—æ–¹å¼ï¼ˆæ•™ç·´è³‡è¨Šï¼‰</b>
        <span id="weightToggleText">é»æ“Šå±•é–‹</span>
      </div>
      <div class="card-b hide" id="weightContent">
        <div class="muted" style="line-height:1.9">
          <b>ä¸‹è‚¢è‚ŒåŠ›</b>ï¼šç¡¬æ‹‰ 100%<br/>
          <b>ä¸‹è‚¢çˆ†ç™¼åŠ›</b>ï¼šIMTP 35%ï½œCMJ 25%ï½œBroad Jump 25%ï½œLateral Jump 15%<br/>
          <b>ä¸Šè‚¢è‚ŒåŠ›</b>ï¼šInverted Row 25%ï½œPush-up 25%ï½œGrip 35%ï½œPlank 15%<br/>
          <b>ä¸Šè‚¢çˆ†ç™¼åŠ›</b>ï¼šè·ªå§¿æ°´å¹³æ‹‹ 30%ï½œè·ªå§¿éé ­æ‹‹ 30%ï½œç«™å§¿éé ­æ‹‹ 20%ï½œç«™å§¿æ°´å¹³æ‹‹ 20%<br/>
          <b>é€Ÿåº¦</b>ï¼š10m 60%ï½œ20m 40%ï¼ˆè¶Šå°è¶Šå¥½ï¼‰<br/>
          <b>è®Šå‘èƒ½åŠ›</b>ï¼š5-10-5 45%ï½œSpider 35%ï¼ˆè¶Šå°è¶Šå¥½ï¼‰ï½œHop test 20%<br/>
          <b>åæ‡‰</b>ï¼šåæ‡‰ç‡ˆ 100%<br/>
          <b>ä»£è¬èƒ½åŠ›</b>ï¼šæœ€å¤§æœ‰æ°§ 50%ï½œç„¡æ°§ä»£è¬ 50%ï¼ˆæœªå¡«å‰‡ç¶­æŒ 50 åˆ†ï¼‰
        </div>
        <div class="muted" style="margin-top:12px">
          0â€“100 è½‰æ›æ–¹å¼ï¼š<b>Score = clamp(50 + ZÃ—15)</b>ï¼ˆZ=+1 ç´„ 65 åˆ†ï¼‰
        </div>
        <div class="muted" style="margin-top:10px">
          ç„¡æ°§ä»£è¬æ¬„ä½æ”¯æ´ï¼š<b>ç„¡æ°§ä»£è¬(%)</b>ï¼ˆACï¼‰/ ç„¡æ°§ä»£è¬åˆ†æ•¸ / Anaerobic Score / FRIï¼ˆæœƒè‡ªå‹•è½‰æˆ 0â€“100ï¼‰
        </div>
      </div>
    </div>
  </div>

<script>
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests: "æª¢æ¸¬æˆç¸¾"
  };

  // ==============================
  // 0) ç„¡æ°§ä»£è¬ï¼šFRI â†’ 0â€“100 æ–°åˆ†æ•¸ï¼ˆ50=å¹³å‡ï¼‰
  // - è‹¥è¡¨å…§å¡«çš„æ˜¯ FRIï¼ˆç´„ 0.90~1.10ï¼‰ï¼Œæœƒè‡ªå‹•è½‰æ›
  // - è‹¥è¡¨å…§å·²æ˜¯ 0â€“100ï¼Œå°±ç›´æ¥ç”¨
  // ==============================
  const ANA_FRI_TO_SCORE_MULT = 400; // 0.01 â‰ˆ 4 åˆ†ï¼ˆæƒ³æ›´æ•æ„Ÿå¯èª¿ 450ï¼Œæƒ³æ›´ä¿å®ˆ 300ï¼‰

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function anaerobicNormalize(raw){
    const v = toNum(raw);
    if(v == null) return null;

    // Case A: already a 0â€“100 score
    if(v >= 0 && v <= 100) return v;

    // Case B: looks like FRI (ratio around 1.0)
    if(v >= 0.75 && v <= 1.35){
      const score = 50 + (1 - v) * ANA_FRI_TO_SCORE_MULT;
      return clamp(score, 0, 100);
    }

    // Otherwise: unknown scale -> ignore
    return null;
  }

  // ==============================
  // 1) æ¬„ä½è¾¨è­˜ï¼ˆå®¹éŒ¯ï¼šåŒä¸€æ¦‚å¿µå¯èƒ½ä¸åŒæ¬„åï¼‰
  // ==============================
  const COL = {
    name: ["å§“å"],
    sex:  ["æ€§åˆ¥"],
    level:["åˆ†ç´š","å¹´ç´š","å¹´é½¡"],

    photo:["ç…§ç‰‡","Photo","photo","image","åœ–ç‰‡","åœ–ç‰‡ç¶²å€","ç…§ç‰‡ç¶²å€"],
    height:["èº«é«˜","èº«é«˜(cm)","height","Height"],
    weight:["é«”é‡","é‡é‡","é‡é‡(kg)","é«”é‡(kg)","weight","Weight"],

    date:["æœ€æ–°æª¢æ¸¬æ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ","æª¢æ¸¬æ—¥æœŸ"],

    deadlift:["ç¡¬æ‹‰(kg)","ç¡¬æ‹‰","Deadlift","Deadlift(kg)"],

    imtp:["IMTP(N)","IMTP","IMTP (RFD 200ms)","IMTP(RFD200ms)","IMTP RFD","RFD","IMTP(N) "],
    cmj:["CMJ(cm)","CMJ","å‚ç›´è·³(cm)","å‚ç›´è·³","Vertical Jump","VerticalJump"],
    broad:["ç«‹å®šè·³(m)","ç«‹å®šè·³","Broad jump (m)","Broad jump","BroadJump","Broad Jump"],
    lateralL:["å´å‘è·³(å·¦)(m)","å´å‘è·³(å·¦)","Lateral jump (L)","LateralJumpL","å´å‘è·³(å·¦)(cm)"],
    lateralR:["å´å‘è·³(å³)(m)","å´å‘è·³(å³)","Lateral jump (R)","LateralJumpR","å´å‘è·³(å³)(cm)"],

    invRow:["åå‘åˆ’èˆ¹(æ¬¡æ•¸)","Inverted row(æ¬¡æ•¸)","Inverted row","Inverted Rows","åå‘åˆ’èˆ¹"],
    pushup:["ä¿¯è‡¥æ’(æ¬¡æ•¸)","Push up(æ¬¡æ•¸)","Push-ups(æ¬¡æ•¸)","Push up","Push-ups","ä¿¯è‡¥æ’"],
    grip:["æ¡åŠ›(kg)","æ¡åŠ›","Grip strength(kg)","Grip strength","Grip"],
    plank:["å¹³æ¿æ’(ç§’)","å¹³æ¿æ’","Plank(æ™‚é–“)","Plank","Plank(s)","å¹³æ¿æ’(æ™‚é–“)"],

    sohm:["ç«™å§¿éé ­æ‹‹","ç«™å§¿éé ­æ‹‹(è·é›¢)","Standing OH MB Throw"],
    kohm:["æ™šå§¿éé ­æ‹‹","è·ªå§¿éé ­æ‹‹","Kneeling OH MB Throw"],
    shmb:["ç«™å§¿æ°´å¹³æ‹‹","Standing Horizontal MB Throw"],
    khmb:["æ™šå§¿æ°´å¹³æ‹‹","è·ªå§¿æ°´å¹³æ‹‹","Kneeling Horizontal MB Throw"],

    sprint10:["10ç±³è¡åˆº(ç§’)","10m sprint","10m Sprint","10m"],
    sprint20:["20ç±³è¡åˆº(ç§’)","20m sprint","20m Sprint","20m"],

    t505L:["505æ•æ·è·‘(å·¦)(ç§’)","505æ•æ·è·‘(å·¦)","505å·¦","505 L","505 (L)"],
    t505R:["505æ•æ·è·‘(å³)(ç§’)","505æ•æ·è·‘(å³)","505å³","505 R","505 (R)"],
    spider:["èœ˜è››è·‘(ç§’)","èœ˜è››è·‘","Spider test(ç§’)","Spider test","Spider"],
    hop:["Hop test(m/s)","Hop test","Hop"],

    react:["åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸)","åæ‡‰ç‡ˆæ¸¬è©¦","åæ‡‰ç‡ˆæ¸¬è©¦(æ¬¡æ•¸) ","Reaction(æ¬¡æ•¸)","Reaction"],

    // âœ… ä»£è¬èƒ½åŠ›
    aerobic:["æœ€å¤§æœ‰æ°§","æœ€å¤§æœ‰æ°§(ml/kg/min)","VO2max","VO2 max","Max Aerobic","Aerobic"],

    // âœ… ç„¡æ°§ä»£è¬ï¼šæ”¯æ´ 0â€“100 åˆ†æ•¸ or FRI
    anaerobic:[
      "ç„¡æ°§ä»£è¬(%)","ç„¡æ°§ä»£è¬","ç„¡æ°§ä»£è¬åˆ†æ•¸",
      "Anaerobic","Anaerobic Score","Anaerobic capacity",
      "FRI","ç–²å‹èª¿ç¯€æŒ‡æ•¸","Fatigue Regulation Index"
    ]
  };

  function isLowerBetterMetric(label){
    const s = String(label || "");
    return (
      s.includes("ç§’") ||
      /sprint/i.test(s) ||
      s.includes("505") ||
      s.includes("èœ˜è››") ||
      s.includes("Spider")
    );
  }

  // ==============================
  // 2) åŠ æ¬Šè¨­å®š
  // ==============================
  const WEIGHTS = {
    lowerStrength: { deadlift: 1.00 },
    lowerPower: { imtp: .35, cmj: .25, broad: .25, lateral: .15 },

    upperStrength: { invRow: .25, pushup: .25, grip: .35, plank: .15 },
    upperPower: { sohm: .20, kohm: .30, shmb: .20, khmb: .30 },

    speed: { sprint10: .60, sprint20: .40 },
    changeDir: { t505: .45, spider: .35, hop: .20 },
    reaction: { react: 1.00 },

    // âœ… ä»£è¬ï¼šæœ€å¤§æœ‰æ°§ 50 / ç„¡æ°§ä»£è¬ 50
    metabolic: { aerobic: .50, anaerobic: .50 }
  };

  const RADAR_AXES = [
    { key:"lowerStrength", label:"ä¸‹è‚¢è‚ŒåŠ›" },
    { key:"lowerPower",    label:"ä¸‹è‚¢çˆ†ç™¼åŠ›" },
    { key:"upperStrength", label:"ä¸Šè‚¢è‚ŒåŠ›" },
    { key:"upperPower",    label:"ä¸Šè‚¢çˆ†ç™¼åŠ›" },
    { key:"speed",         label:"é€Ÿåº¦" },
    { key:"changeDir",     label:"è®Šå‘èƒ½åŠ›" },
    { key:"reaction",      label:"åæ‡‰" },
    { key:"metabolic",     label:"ä»£è¬èƒ½åŠ›" }
  ];

  function zToScore(z){
    if (z == null || isNaN(z)) return 50;
    const v = 50 + z * 15;
    return Math.max(0, Math.min(100, v));
  }

  function csvUrlForSheet(sheetName){
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function loadSheet(sheetName){
    return new Promise((resolve,reject)=>{
      Papa.parse(csvUrlForSheet(sheetName),{
        download:true,
        header:true,
        complete:r=>resolve(r.data || []),
        error:reject
      });
    });
  }

  function getVal(row, keys){
    for (const k of keys){
      if (row && row[k] != null && String(row[k]).trim() !== "") return row[k];
    }
    return "";
  }

  function toNum(v){
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return isNaN(n) ? null : n;
  }

  function groupKeyOf(playerRow, testRow){
    const sex = (getVal(playerRow, COL.sex) || getVal(testRow, COL.sex) || "").trim() || "-";
    const level = (getVal(playerRow, COL.level) || getVal(testRow, COL.level) || "").trim() || "-";
    return `${sex}|${level}`;
  }

  let playersByName = new Map();
  let testsByName = new Map();
  let testsArray = [];
  let groupStats = new Map();

  let radarPlayerChart = null;
  let radarCoachChart  = null;
  let barChart = null;

  function buildGroupStats(){
    const bucket = new Map();
    testsArray.forEach(row=>{
      const name = String(getVal(row, COL.name) || "").trim();
      if(!name) return;

      const playerRow = playersByName.get(name) || {};
      const gk = groupKeyOf(playerRow, row);
      if(!bucket.has(gk)) bucket.set(gk, new Map());
      const m = bucket.get(gk);

      Object.keys(row).forEach(k=>{
        if(!k) return;
        if (COL.name.includes(k) || COL.sex.includes(k) || COL.level.includes(k) || COL.date.includes(k)) return;

        // âœ… ç„¡æ°§ä»£è¬ï¼šè‹¥æ˜¯ FRI/åˆ†æ•¸æ¬„ä½ï¼Œå°±å…ˆ normalize æˆ 0â€“100 å†åšç¾¤çµ„çµ±è¨ˆ
        const isAna = COL.anaerobic.includes(k);
        const raw = row[k];
        const v = isAna ? anaerobicNormalize(raw) : toNum(raw);

        if(v == null) return;
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(v);
      });
    });

    groupStats = new Map();
    bucket.forEach((m,gk)=>{
      const stat = {};
      m.forEach((arr,metricName)=>{
        if(!arr.length) return;
        const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
        const variance = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length;
        const sd = Math.sqrt(variance);
        stat[metricName] = { mean, sd };
      });
      groupStats.set(gk, stat);
    });
  }

  function pickMetric(row, keyList){
    for (const k of keyList){
      if(!(k in row)) continue;
      const raw = row[k];

      // âœ… ç„¡æ°§ä»£è¬ï¼šè‡ªå‹• normalize
      if(keyList === COL.anaerobic){
        const v = anaerobicNormalize(raw);
        if(v != null) return { col:k, val:v };
        continue;
      }

      const v = toNum(raw);
      if(v != null) return { col: k, val: v };
    }
    return { col: null, val: null };
  }

  function zOfMetric(testRow, gk, colName, val){
    if(val == null || !colName) return null;
    const stats = groupStats.get(gk) || {};
    const s = stats[colName];
    if(!s || s.sd == null || s.sd === 0) return null;

    const lowerBetter = isLowerBetterMetric(colName);
    const z = lowerBetter ? (s.mean - val) / s.sd : (val - s.mean) / s.sd;
    return z;
  }

  function calcCompositeZ(testRow, playerRow){
    const gk = groupKeyOf(playerRow, testRow);

    const deadlift = pickMetric(testRow, COL.deadlift);

    const imtp  = pickMetric(testRow, COL.imtp);
    const cmj   = pickMetric(testRow, COL.cmj);
    const broad = pickMetric(testRow, COL.broad);
    const latL  = pickMetric(testRow, COL.lateralL);
    const latR  = pickMetric(testRow, COL.lateralR);

    const lateralZ = (()=>{
      const zl = zOfMetric(testRow, gk, latL.col, latL.val);
      const zr = zOfMetric(testRow, gk, latR.col, latR.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    const invRow = pickMetric(testRow, COL.invRow);
    const pushup = pickMetric(testRow, COL.pushup);
    const grip   = pickMetric(testRow, COL.grip);
    const plank  = pickMetric(testRow, COL.plank);

    const sohm = pickMetric(testRow, COL.sohm);
    const kohm = pickMetric(testRow, COL.kohm);
    const shmb = pickMetric(testRow, COL.shmb);
    const khmb = pickMetric(testRow, COL.khmb);

    const s10 = pickMetric(testRow, COL.sprint10);
    const s20 = pickMetric(testRow, COL.sprint20);

    const t505L = pickMetric(testRow, COL.t505L);
    const t505R = pickMetric(testRow, COL.t505R);
    const spider = pickMetric(testRow, COL.spider);
    const hop = pickMetric(testRow, COL.hop);

    const react = pickMetric(testRow, COL.react);

    // âœ… ä»£è¬èƒ½åŠ›ï¼ˆæœ€å¤§æœ‰æ°§ + ç„¡æ°§ä»£è¬ï¼‰
    const aerobic = pickMetric(testRow, COL.aerobic);
    const anaerobic = pickMetric(testRow, COL.anaerobic);

    const z505 = (()=>{
      const zl = zOfMetric(testRow, gk, t505L.col, t505L.val);
      const zr = zOfMetric(testRow, gk, t505R.col, t505R.val);
      if(zl == null && zr == null) return null;
      if(zl == null) return zr;
      if(zr == null) return zl;
      return (zl+zr)/2;
    })();

    const z_deadlift = zOfMetric(testRow, gk, deadlift.col, deadlift.val);

    const z_imtp  = zOfMetric(testRow, gk, imtp.col,  imtp.val);
    const z_cmj   = zOfMetric(testRow, gk, cmj.col,   cmj.val);
    const z_broad = zOfMetric(testRow, gk, broad.col, broad.val);

    const z_invRow = zOfMetric(testRow, gk, invRow.col, invRow.val);
    const z_pushup = zOfMetric(testRow, gk, pushup.col, pushup.val);
    const z_grip   = zOfMetric(testRow, gk, grip.col,   grip.val);
    const z_plank  = zOfMetric(testRow, gk, plank.col,  plank.val);

    const z_sohm = zOfMetric(testRow, gk, sohm.col, sohm.val);
    const z_kohm = zOfMetric(testRow, gk, kohm.col, kohm.val);
    const z_shmb = zOfMetric(testRow, gk, shmb.col, shmb.val);
    const z_khmb = zOfMetric(testRow, gk, khmb.col, khmb.val);

    const z_s10 = zOfMetric(testRow, gk, s10.col, s10.val);
    const z_s20 = zOfMetric(testRow, gk, s20.col, s20.val);

    const z_spider = zOfMetric(testRow, gk, spider.col, spider.val);
    const z_hop    = zOfMetric(testRow, gk, hop.col, hop.val);

    const z_react = zOfMetric(testRow, gk, react.col, react.val);

    // âœ… ä»£è¬ Zï¼šæ³¨æ„ val å¯èƒ½æ˜¯å·² normalize çš„ 0â€“100ï¼ˆè‹¥ä½ å­˜çš„æ˜¯åˆ†æ•¸ï¼‰
    const z_aerobic = zOfMetric(testRow, gk, aerobic.col, aerobic.val);
    const z_anaerobic = zOfMetric(testRow, gk, anaerobic.col, anaerobic.val);

    const wsum = (pairs)=>{
      let num = 0, den = 0;
      for(const [z,w] of pairs){
        if(z == null || isNaN(z)) continue;
        num += z*w;
        den += w;
      }
      return den ? (num/den) : null;
    };

    const z_lowerStrength = wsum([[z_deadlift, WEIGHTS.lowerStrength.deadlift]]);

    const z_lowerPower = wsum([
      [z_imtp,  WEIGHTS.lowerPower.imtp],
      [z_cmj,   WEIGHTS.lowerPower.cmj],
      [z_broad, WEIGHTS.lowerPower.broad],
      [lateralZ,WEIGHTS.lowerPower.lateral]
    ]);

    const z_upperStrength = wsum([
      [z_invRow, WEIGHTS.upperStrength.invRow],
      [z_pushup, WEIGHTS.upperStrength.pushup],
      [z_grip,   WEIGHTS.upperStrength.grip],
      [z_plank,  WEIGHTS.upperStrength.plank]
    ]);

    const z_upperPower = wsum([
      [z_sohm, WEIGHTS.upperPower.sohm],
      [z_kohm, WEIGHTS.upperPower.kohm],
      [z_shmb, WEIGHTS.upperPower.shmb],
      [z_khmb, WEIGHTS.upperPower.khmb]
    ]);

    const z_speed = wsum([
      [z_s10, WEIGHTS.speed.sprint10],
      [z_s20, WEIGHTS.speed.sprint20]
    ]);

    const z_changeDir = wsum([
      [z505,     WEIGHTS.changeDir.t505],
      [z_spider, WEIGHTS.changeDir.spider],
      [z_hop,    WEIGHTS.changeDir.hop]
    ]);

    const z_reaction = wsum([[z_react, WEIGHTS.reaction.react]]);

    // âœ… ä»£è¬ï¼šæœ€å¤§æœ‰æ°§ 50 / ç„¡æ°§ä»£è¬ 50ï¼ˆå…©è€…éƒ½æ²’å¡« â†’ null â†’ åˆ†æ•¸é¡¯ç¤º 50ï¼‰
    const z_metabolic = wsum([
      [z_aerobic, WEIGHTS.metabolic.aerobic],
      [z_anaerobic, WEIGHTS.metabolic.anaerobic]
    ]);

    return {
      groupKey: gk,
      zByAxis: {
        lowerStrength: z_lowerStrength,
        lowerPower: z_lowerPower,
        upperStrength: z_upperStrength,
        upperPower: z_upperPower,
        speed: z_speed,
        changeDir: z_changeDir,
        reaction: z_reaction,
        metabolic: z_metabolic
      }
    };
  }

  const el = (id)=>document.getElementById(id);

  async function reloadAll(){
    el("statusMsg").textContent = "å¾ Google Sheets è¼‰å…¥ä¸­â€¦";
    el("studentSelect").disabled = true;
    el("studentSelect").innerHTML = `<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>`;

    try{
      const [players, tests] = await Promise.all([
        loadSheet(SHEETS.players),
        loadSheet(SHEETS.tests)
      ]);

      playersByName = new Map();
      players.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) playersByName.set(n, r);
      });

      testsArray = tests || [];
      testsByName = new Map();
      testsArray.forEach(r=>{
        const n = String(getVal(r, COL.name) || "").trim();
        if(n) testsByName.set(n, r);
      });

      buildGroupStats();

      const names = Array.from(testsByName.keys()).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
      el("studentSelect").innerHTML = `<option value="">â€” è«‹é¸æ“‡å­¸å“¡ â€”</option>`;
      names.forEach(n=>{
        const op = document.createElement("option");
        op.value = n; op.textContent = n;
        el("studentSelect").appendChild(op);
      });

      el("studentSelect").disabled = false;
      el("statusMsg").textContent = "è¼‰å…¥å®Œæˆï¼šè«‹é¸å­¸å“¡ã€‚";

    }catch(err){
      console.error(err);
      el("statusMsg").textContent = "è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèªè©¦ç®—è¡¨å·²å…¬é–‹ã€åˆ†é åç¨±æ­£ç¢ºï¼ˆå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ï¼‰ã€‚";
    }
  }

  let currentView = "player";

  function setView(view){
    currentView = view;
    el("tabPlayer").classList.toggle("active", view==="player");
    el("tabCoach").classList.toggle("active", view==="coach");

    el("playerView").classList.toggle("hide", view!=="player");
    el("coachView").classList.toggle("hide", view!=="coach");

    if(view==="player"){
      el("viewTitle").textContent = "PLAYER VERSION";
      el("viewSubtitle").textContent = "çœ‹å¾—æ‡‚ã€çœ‹å¾—é‡é»ï¼šç…§ç‰‡ / åŸºæœ¬è³‡æ–™ / é›·é”åœ– / æœ¬é€± 3 ä»¶äº‹ / æ•™ç·´æé†’";
    }else{
      el("viewTitle").textContent = "COACH VERSION";
      el("viewSubtitle").textContent = "å®Œæ•´æ•¸æ“šï¼šé›·é”åœ– + é—œéµæŒ‡æ¨™å‰ 10 + å…¨è¡¨ï¼ˆå« Zï¼‰+ æ•™ç·´è™•æ–¹ï¼ˆå¯ç·¨è¼¯ï¼‰";
    }
  }

  function renderPlayerPhoto(url){
    const box = el("playerPhotoBox");
    box.innerHTML = "";
    if(url){
      const img = document.createElement("img");
      img.src = url;
      img.alt = "player photo";
      box.appendChild(img);
    }else{
      const div = document.createElement("div");
      div.className = "ph-txt";
      div.innerHTML = "ï¼ˆå¯é¸ï¼‰æ”¾çƒå“¡æ‰“çƒç…§ç‰‡<br/>æ¬„ä½ï¼š<b>ç…§ç‰‡</b>ï¼ˆURLï¼‰";
      box.appendChild(div);
    }
  }

  function renderRadar(canvasId, scores, avgLine=true){
    const ctx = document.getElementById(canvasId).getContext("2d");
    const labels = RADAR_AXES.map(a=>a.label);

    const yourData = RADAR_AXES.map(a=>scores[a.key] ?? 50);
    const avgData  = labels.map(_=>50);

    const config = {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "ä½ ï¼ˆåˆ†æ•¸ï¼‰",
            data: yourData,
            borderColor: "rgba(248,113,113,.95)",
            backgroundColor: "rgba(248,113,113,.20)",
            pointBackgroundColor: "rgba(248,113,113,.95)",
            pointRadius: 3,
            borderWidth: 2
          },
          ...(avgLine ? [{
            label: "åŒç´šå¹³å‡ï¼ˆå›ºå®š 50ï¼‰",
            data: avgData,
            borderColor: "rgba(148,163,184,.55)",
            backgroundColor: "rgba(148,163,184,.06)",
            pointRadius: 0,
            borderWidth: 1
          }] : [])
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{
            labels:{ color:"#cbd5e1", boxWidth:18, font:{ size: 12 } }
          }
        },
        scales:{
          r:{
            min:0, max:100,
            ticks:{ color:"#94a3b8", backdropColor:"transparent", stepSize:10, font:{ size: 10 } },
            grid:{ color:"rgba(148,163,184,.16)" },
            angleLines:{ color:"rgba(148,163,184,.14)" },
            pointLabels:{ color:"#e2e8f0", font:{ size: 12 } }
          }
        }
      }
    };
    return new Chart(ctx, config);
  }

  function evalTag(z){
    if(z == null || isNaN(z)) return `<span class="tagpill">â€”</span>`;
    if(z >= 1) return `<span class="tagpill good">å„ªæ–¼åŒç´š</span>`;
    if(z <= -0.5) return `<span class="tagpill bad">å»ºè­°è£œå¼·</span>`;
    return `<span class="tagpill mid">æ¥è¿‘åŒç´š</span>`;
  }

  function renderCoachBar(keyMetrics){
    const ctx = document.getElementById("barChart").getContext("2d");
    if(barChart) barChart.destroy();

    barChart = new Chart(ctx,{
      type:"bar",
      data:{
        labels: keyMetrics.map(x=>x.label),
        datasets:[
          { label:"å­¸å“¡", data:keyMetrics.map(x=>x.latest), backgroundColor:"rgba(34,197,94,.80)" },
          { label:"åŒç´šå¹³å‡", data:keyMetrics.map(x=>x.mean), backgroundColor:"rgba(56,189,248,.80)" }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ ticks:{ color:"#cbd5e1", font:{ size: 11 } }, grid:{ display:false } },
          y:{ ticks:{ color:"#94a3b8", font:{ size: 11 } }, grid:{ color:"rgba(148,163,184,.14)" } }
        }
      }
    });
  }

  let currentPlanKey = null;

  function planStorageKey(name, date){
    const safeName = String(name||"").trim() || "unknown";
    const safeDate = String(date||"").trim() || "unknownDate";
    return `MPL_PLAN_${safeName}_${safeDate}`;
  }

  function normalize3Lines(text){
    return String(text||"")
      .split("\n")
      .map(s=>s.trim())
      .filter(Boolean)
      .slice(0,3)
      .map(s=>s.replace(/^\d+[.)ã€-]?\s*/,""));
  }

  function loadPlanToEditors(){
    if(!currentPlanKey) return;
    const raw = localStorage.getItem(currentPlanKey);
    let data = null;
    try{ data = raw ? JSON.parse(raw) : null; }catch(e){ data=null; }

    el("coachPlanSimple").value = data?.simple || "";
    el("coachPlanFull").value = data?.full || "";
    el("planStatus").textContent = data?.updatedAt ? `å·²å„²å­˜ï¼š${data.updatedAt}` : "æœªå„²å­˜";
    renderPlanToPlayerAndPrint();
  }

  function savePlanFromEditors(){
    if(!currentPlanKey) return;
    const now = new Date();
    const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;

    const data = {
      simple: el("coachPlanSimple").value.trim(),
      full: el("coachPlanFull").value.trim(),
      updatedAt: stamp
    };
    localStorage.setItem(currentPlanKey, JSON.stringify(data));
    el("planStatus").textContent = `å·²å„²å­˜ï¼š${stamp}`;
    renderPlanToPlayerAndPrint();
  }

  function resetPlan(){
    if(!currentPlanKey) return;
    localStorage.removeItem(currentPlanKey);
    el("coachPlanSimple").value = "";
    el("coachPlanFull").value = "";
    el("planStatus").textContent = "æœªå„²å­˜";
    renderPlanToPlayerAndPrint();
  }

  function renderPlanToPlayerAndPrint(){
    const simpleList = normalize3Lines(el("coachPlanSimple")?.value || "");
    const fullList   = normalize3Lines(el("coachPlanFull")?.value || "");

    el("p_todoList").innerHTML = simpleList.length
      ? simpleList.map((t,i)=>`<li>${t}<span class="tag">${i===0?"ä¸»è»¸":i===1?"æ¬¡å„ªå…ˆ":"ç¶­æŒ"}</span></li>`).join("")
      : `<li>å°šæœªå¡«å¯«ï¼ˆæ•™ç·´æœƒåœ¨æ•™ç·´ç‰ˆå¡«å¯«ï¼‰</li>`;

    el("printPlanSimple").innerHTML = simpleList.length
      ? simpleList.map(t=>`<li>${t}</li>`).join("")
      : `<li>ï¼ˆå°šæœªå¡«å¯«ï¼‰</li>`;

    el("printPlanFull").innerHTML = fullList.length
      ? fullList.map(t=>`<li>${t}</li>`).join("")
      : `<li>ï¼ˆå°šæœªå¡«å¯«ï¼‰</li>`;
  }

  function loadStudent(){
    const name = el("studentSelect").value;
    if(!name) return;

    const testRow = testsByName.get(name);
    const playerRow = playersByName.get(name) || {};

    if(!testRow){
      el("statusMsg").textContent = `æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„æª¢æ¸¬æˆç¸¾ã€‚`;
      return;
    }

    const sex = (getVal(playerRow, COL.sex) || getVal(testRow, COL.sex) || "-").trim() || "-";
    const level = (getVal(playerRow, COL.level) || getVal(testRow, COL.level) || "-").trim() || "-";
    const date = (getVal(playerRow, COL.date) || getVal(testRow, COL.date) || "-").trim() || "-";

    const height = (getVal(playerRow, COL.height) || "-").toString().trim() || "-";
    const weight = (getVal(playerRow, COL.weight) || "-").toString().trim() || "-";
    const photo  = (getVal(playerRow, COL.photo) || "").toString().trim();

    const comp = calcCompositeZ(testRow, playerRow);
    const zByAxis = comp.zByAxis;

    const scores = {};
    Object.keys(zByAxis).forEach(k=>{
      scores[k] = zToScore(zByAxis[k]);
    });

    const items = Object.keys(zByAxis).map(k=>({k, z:zByAxis[k]})).filter(x=>x.z!=null && !isNaN(x.z));
    items.sort((a,b)=>b.z-a.z);
    const bestAxis = items[0]?.k || "metabolic";
    const worst = items.slice().sort((a,b)=>a.z-b.z).map(x=>x.k);
    const weakPick = worst.slice(0,2);

    const bestLabel = (RADAR_AXES.find(a=>a.key===bestAxis)?.label || bestAxis);
    const weakLabels = weakPick.map(k=>RADAR_AXES.find(a=>a.key===k)?.label || k);

    el("p_name").textContent = name;
    el("p_sex").textContent = sex;
    el("p_level").textContent = level;
    el("p_height").textContent = (height && height!=="-") ? `${height}` : "â€”";
    el("p_weight").textContent = (weight && weight!=="-") ? `${weight}` : "â€”";
    el("p_groupKey").textContent = `${sex}ãƒ»${level}`;
    el("p_date").textContent = date || "â€”";
    renderPlayerPhoto(photo);

    el("p_bestText").textContent = `${bestLabel}ï¼ˆZ=${(zByAxis[bestAxis] ?? 0).toFixed(2)}ï¼‰`;
    el("p_weakText").textContent = weakLabels.length
      ? weakLabels.map((lbl,i)=> `${lbl}ï¼ˆZ=${(zByAxis[weakPick[i]] ?? 0).toFixed(2)}ï¼‰`).join("ã€")
      : "ç›®å‰æ²’æœ‰é¡¯è‘—å¼±é …ï¼ˆæ¥è¿‘åŒç´šå¹³å‡ï¼‰";

    el("p_coachNote").innerHTML = `
      ç¶œåˆä¾†çœ‹ï¼Œ<b>${name}</b> åœ¨åŒçµ„ï¼ˆ${sex}ãƒ»${level}ï¼‰ä¸­ï¼š<br/><br/>
      ãƒ»æœ€å¼·æ–¹å‘ï¼š<b>${bestLabel}</b>ï¼ˆZ=${(zByAxis[bestAxis] ?? 0).toFixed(2)}ï¼‰<br/>
      ãƒ»å„ªå…ˆè£œå¼·ï¼š<b>${weakLabels[0] || "â€”"}</b>${weakLabels[1] ? `ã€<b>${weakLabels[1]}</b>` : ""}<br/><br/>
      é€™ä»½çƒå“¡ç‰ˆåªè¦è¨˜ä½ä¸€å¥ï¼š<b>æœ¬é€±å…ˆæŠŠ 1â€“2 å€‹å¼±é …æ‹‰å›å¹³å‡ç·šé™„è¿‘</b>ï¼Œç©©å®šåº¦æœƒå…ˆä¸Šä¾†ã€‚
    `;

    if(radarPlayerChart) radarPlayerChart.destroy();
    radarPlayerChart = renderRadar("playerRadar", scores, true);

    el("c_name").textContent = name;
    el("c_groupKey").textContent = `${sex}ãƒ»${level}`;
    el("c_sex").textContent = sex;
    el("c_level").textContent = level;
    el("c_date").textContent = date || "â€”";
    el("c_hw").textContent = `${(height && height!=="-"?height:"â€”")} / ${(weight && weight!=="-"?weight:"â€”")}`;

    if(radarCoachChart) radarCoachChart.destroy();
    radarCoachChart = renderRadar("coachRadar", scores, true);

    const gk = groupKeyOf(playerRow, testRow);
    const stats = groupStats.get(gk) || {};

    const rows = [];
    Object.keys(testRow).forEach(k=>{
      if(!k) return;
      if (COL.name.includes(k) || COL.sex.includes(k) || COL.level.includes(k) || COL.date.includes(k)) return;

      const isAna = COL.anaerobic.includes(k);
      const latest = isAna ? anaerobicNormalize(testRow[k]) : toNum(testRow[k]);
      if(latest == null) return;

      const s = stats[k] || {};
      const mean = (s.mean==null?null:s.mean);
      const sd = (s.sd==null?null:s.sd);

      let z = null;
      if(mean != null && sd != null && sd !== 0){
        const lowerBetter = isLowerBetterMetric(k);
        z = lowerBetter ? (mean - latest)/sd : (latest - mean)/sd;
      }
      rows.push({ label:k, latest, mean, sd, z });
    });

    const keyMetrics = rows.filter(r=>r.z!=null).sort((a,b)=>Math.abs(b.z)-Math.abs(a.z)).slice(0,10);
    renderCoachBar(keyMetrics);

    const keySet = new Set(keyMetrics.map(r=>r.label));
    const sorted = rows.slice().sort((a,b)=>{
      const ak = keySet.has(a.label), bk = keySet.has(b.label);
      if(ak !== bk) return bk-ak;
      if(a.z==null && b.z==null) return a.label.localeCompare(b.label,"zh-Hant");
      if(a.z==null) return 1;
      if(b.z==null) return -1;
      return Math.abs(b.z)-Math.abs(a.z);
    });

    el("tableBody").innerHTML = sorted.map(r=>{
      let extra = "";
      if(keySet.has(r.label)) extra = ` <span class="tagpill key">é—œéµæŒ‡æ¨™</span>`;
      return `
        <tr>
          <td>${r.label}</td>
          <td>${r.latest ?? "â€”"}</td>
          <td>${r.mean != null ? r.mean.toFixed(2) : "â€”"}</td>
          <td>${r.sd != null ? r.sd.toFixed(2) : "â€”"}</td>
          <td>${r.z != null ? r.z.toFixed(2) : "â€”"}</td>
          <td>${evalTag(r.z)}${extra}</td>
        </tr>
      `;
    }).join("");

    const strengths = rows.filter(r=>r.z!=null && r.z>=1).sort((a,b)=>b.z-a.z).slice(0,3);
    const weaknesses = rows.filter(r=>r.z!=null && r.z<=-0.5).sort((a,b)=>a.z-b.z).slice(0,3);
    const listText = arr => arr.length ? arr.map(x=>`${x.label}ï¼ˆZ=${x.z.toFixed(2)}ï¼‰`).join("ã€") : "ç„¡ï¼ˆå¤šæ•¸æ¥è¿‘åŒç´šå¹³å‡ï¼‰";

    el("c_coachNote").innerHTML = `
      æ ¹æ“šæœ¬æ¬¡æª¢æ¸¬ï¼Œ<b>${name}</b> èˆ‡åŒçµ„ï¼ˆ${sex}ãƒ»${level}ï¼‰ç›¸æ¯”ï¼š<br/><br/>
      ãƒ»ä¸»è¦å„ªå‹¢ï¼š${listText(strengths)}<br/>
      ãƒ»å»ºè­°è£œå¼·ï¼š${listText(weaknesses)}<br/><br/>
      å»ºè­°ï¼šè£œå¼·é …ç›®æ’å…¥æ¯é€±å›ºå®šç¯€é»ï¼ˆç†±èº«å¾Œ 10â€“15 åˆ†é˜ï¼‰ï¼Œä¸¦ä¿ç•™å„ªå‹¢é …ç›®æ¯é€± 1 æ¬¡åˆºæ¿€ï¼Œé¿å…å„ªå‹¢æµå¤±ã€‚
    `;

    currentPlanKey = planStorageKey(name, date);
    loadPlanToEditors();

    el("statusMsg").textContent = "";
  }

  async function exportPDF(mode){
    const { jsPDF } = window.jspdf;
    const name = (el("studentSelect").value || "report").trim() || "report";

    renderPlanToPlayerAndPrint();

    const original = currentView;
    if(mode==="player") setView("player");
    if(mode==="coach") setView("coach");

    document.body.classList.add("exporting");
    await new Promise(r=>setTimeout(r, 120));

    const surface = document.getElementById("mainSurface");
    const canvas = await html2canvas(surface, {
      scale: 3,
      backgroundColor: "#020617",
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p","mm","a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let position = 0;
    let heightLeft = imgHeight;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position -= pageHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
      heightLeft -= pageHeight;
    }

    const suffix = mode==="player" ? "Player" : "Coach";
    pdf.save(`MatchPointLab-${suffix}-${name}.pdf`);

    document.body.classList.remove("exporting");
    setView(original);
  }

  el("reloadBtn").addEventListener("click", reloadAll);
  el("studentSelect").addEventListener("change", loadStudent);

  el("tabPlayer").addEventListener("click", ()=>setView("player"));
  el("tabCoach").addEventListener("click", ()=>setView("coach"));

  el("pdfPlayerBtn").addEventListener("click", async ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    await exportPDF("player");
  });

  el("pdfCoachBtn").addEventListener("click", async ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    await exportPDF("coach");
  });

  el("savePlanBtn").addEventListener("click", ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    savePlanFromEditors();
  });
  el("resetPlanBtn").addEventListener("click", ()=>{
    if(!el("studentSelect").value){ alert("è«‹å…ˆé¸æ“‡å­¸å“¡"); return; }
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºé€™ä½å­¸å“¡é€™æ¬¡æª¢æ¸¬çš„è™•æ–¹å—ï¼Ÿ")) resetPlan();
  });

  (function(){
    const toggle = document.getElementById("weightToggle");
    const content = document.getElementById("weightContent");
    const text = document.getElementById("weightToggleText");
    if(!toggle || !content) return;
    toggle.addEventListener("click", ()=>{
      const isOpen = !content.classList.contains("hide");
      content.classList.toggle("hide", isOpen);
      text.textContent = isOpen ? "é»æ“Šå±•é–‹" : "é»æ“Šæ”¶åˆ";
    });
  })();

  setView("player");
  reloadAll();
</script>
</body>
</html>
