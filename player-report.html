<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¶²çƒå­¸é™¢ï½œé‹å‹•å“¡è¨“ç·´æˆæ•ˆå ±å‘Š</title>

  <!-- Chart.jsï¼šåšæŸ±ç‹€åœ– & é›·é”åœ– -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParseï¼šæŠ“ Google Sheets CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- ç”¢ç”Ÿ PDF ç”¨ï¼šhtml2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-page: #020617;
      --bg-card: #020617;
      --accent: #22c55e;
      --accent-alt: #38bdf8;
      --accent-soft: #bbf7d0;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #6b7280;
      --border-subtle: #1e293b;
      --radius-lg: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,sans-serif;
      background:
        radial-gradient(circle at 10% 0, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    /* A4 ç›´å¼æ¯”ä¾‹çš„å ±å‘Šå®¹å™¨ï¼šå°ˆé–€çµ¦ PDF ç”¨ */
    .page-frame {
      width: 820px;             /* æ¥è¿‘ A4 å¯¬åº¦ï¼Œç¨å¾®æ”¾å¤§ä¸€é»è®“å­—æ›´æ¸…æ¥š */
      margin: 32px auto;
      padding: 0;
    }

    .report-shell {
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(34,197,94,0.18) 0, transparent 60%),
        radial-gradient(circle at 50% 120%, #020617 0, #000 55%);
      border-radius: 24px;
      padding: 24px 26px 26px;
      box-shadow:
        0 18px 60px rgba(15,23,42,0.95),
        0 0 0 1px rgba(148,163,184,0.25);
      position: relative;
      overflow: hidden;
    }

    .report-shell::before {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.4);
      right: -110px;
      top: -70px;
      opacity: 0.4;
      box-shadow: 0 0 40px rgba(56,189,248,0.5);
    }

    .report-shell::after {
      content: "";
      position: absolute;
      width: 140px;
      height: 140px;
      border-radius: 999px;
      border: 2px solid rgba(34,197,94,0.8);
      left: -60px;
      bottom: -50px;
      opacity: 0.35;
      box-shadow: 0 0 32px rgba(34,197,94,0.6);
    }

    header {
      position: relative;
      z-index: 1;
      margin-bottom: 14px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #f9fafb;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Logo æ”¹ç‚º <img> ç”¨ */
    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid rgba(34,197,94,0.9);
      box-shadow: 0 0 18px rgba(34,197,94,0.9);
      object-fit: cover;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      display: inline-block;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .pill-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-tag span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }

    .control-row {
      margin-top: 10px;
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }

    .control-row label {
      color: var(--text-sub);
    }

    select {
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      min-width: 180px;
      appearance: none;
      outline: none;
      padding-right: 26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 50%, calc(100% - 11px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    .btn {
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      cursor: pointer;
      font-size: 12px;
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      border-color: rgba(248,250,252,0.9);
      color: #e5e7eb;
      background: rgba(15,23,42,1);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
    }

    .status-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: auto;
    }

    /* å ±å‘Šå…§å®¹å€ï¼ˆçµ¦ PDF ç”¨ï¼Œå¯¬åº¦å›ºå®šï¼‰ */
    .report-body {
      position: relative;
      z-index: 1;
      background: rgba(15,23,42,0.97);
      border-radius: 18px;
      padding: 16px 18px 18px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }

    .section-title span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .section-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin: 0 0 10px;
    }

    .profile-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    .profile-card {
      background: radial-gradient(circle at top left, rgba(34,197,94,0.1) 0, transparent 60%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,1) 0, #020617 80%);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text-main);
    }

    .profile-card h3 {
      margin: 0 0 6px;
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
    }

    .profile-item-title {
      font-size: 11px;
      color: var(--text-muted);
    }

    .profile-item-value {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }

    .summary-note {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    /* é—œéµæŒ‡æ¨™ + æŸ±ç‹€åœ– */
    .key-metrics-section {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .chart-wrapper {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top, #020617 0, #020617 90%);
      padding: 10px 12px 12px;
    }

    .chart-legend {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      width: 14px;
      height: 6px;
      border-radius: 999px;
    }

    .swatch-player {
      background: linear-gradient(to right, #22c55e, #4ade80);
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .swatch-group {
      background: linear-gradient(to right, #38bdf8, #0ea5e9);
      box-shadow: 0 0 8px rgba(56,189,248,0.9);
    }

    .chart-box {
      position: relative;
      width: 100%;
      height: 220px;
    }

    /* æ•™ç·´çŸ­è©•ï¼ˆæ•´é«”æŒ‡æ¨™ç”¨ï¼‰ */
    .coach-section {
      margin-top: 10px;
    }

    .coach-box {
      background: rgba(15,23,42,0.98);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.7;
    }

    .coach-box strong {
      color: var(--accent-soft);
    }

    /* âœ… ä¸‹è‚¢çˆ†ç™¼åŠ›æ¨¡çµ„ï¼ˆæ–°å¢ï¼‰ */
    .lbp-card {
      margin-top: 10px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.12) 0, transparent 65%);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1.1fr 1.9fr;
      gap: 10px;
      align-items: center;
    }

    .lbp-score-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .lbp-score-main {
      font-size: 26px;
      font-weight: 700;
      color: #f9fafb;
    }

    .lbp-chip {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(234,179,8,0.6);
      font-size: 11px;
      color: #facc15;
    }

    .lbp-list {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.7;
    }

    .lbp-list em {
      color: #e5e7eb;
      font-style: normal;
    }

    .lbp-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .radar-row {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
    }

    .radar-box {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 10px 12px 14px;
    }

    .radar-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .radar-canvas-wrap {
      position: relative;
      width: 100%;
      height: 240px;
    }

    .lbp-coach-card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.7;
    }

    .lbp-coach-card strong {
      color: var(--accent-soft);
    }

    /* å®Œæ•´æª¢æ¸¬è¡¨ */
    .table-section {
      margin-top: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: #f9fafb;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30,41,59,0.9);
      text-align: right;
      white-space: nowrap;
      color: #f9fafb;
    }

    th:first-child, td:first-child {
      text-align: left;
      max-width: 140px;
      white-space: normal;
    }

    thead th {
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
      color: #e5e7eb;
      font-weight: 500;
    }

    tbody tr:nth-child(odd) td {
      background: #020617;
    }

    tbody tr:nth-child(even) td {
      background: #020819;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 10px;
      white-space: nowrap;
    }

    .tag.good {
      border-color: rgba(34,197,94,0.85);
      background: rgba(22,163,74,0.2);
      color: #bbf7d0;
    }

    .tag.mid {
      border-color: rgba(250,204,21,0.8);
      background: rgba(133,77,14,0.28);
      color: #facc15;
    }

    .tag.bad {
      border-color: rgba(248,113,113,0.9);
      background: rgba(127,29,29,0.4);
      color: #fecaca;
    }

    .tag.key {
      border-color: rgba(59,130,246,0.9);
      background: rgba(30,64,175,0.4);
      color: #bfdbfe;
    }

    .footer-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .btn-pdf {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #020617;
      box-shadow: 0 10px 30px rgba(34,197,94,0.7);
    }

    .btn-pdf:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .small-note {
      font-size: 10px;
      color: var(--text-muted);
    }

    #reportSection { display: none; }

    @media (max-width: 820px) {
      body { padding: 0; }
      .page-frame {
        width: 100%;
        margin: 16px auto;
        padding: 0 8px;
      }
      .report-shell {
        padding: 18px 14px 20px;
        border-radius: 20px;
      }
      .profile-row,
      .radar-row {
        grid-template-columns: minmax(0,1fr);
      }
      .lbp-card {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
<div class="page-frame" id="pdfArea">
  <div class="report-shell">
    <header>
      <div class="top-row">
        <div class="title-block">
          <h1>
            <img
              class="logo-mark"
              src="https://aschangaspossible.github.io/logo.jpeg"
              alt="å¥•æ™‰ç¶²çƒå­¸é™¢ Logo"
            />
            <span>å¥•æ™‰ç¶²çƒå­¸é™¢</span>
          </h1>
          <div class="brand-sub">Match Point Labï½œå¥•æ™‰ç¶²çƒå­¸é™¢é«”èƒ½æª¢æ¸¬ä¸­å¿ƒ</div>
        </div>
        <div class="pill-tag">
          <span class="dot"></span>
          <span>é€£ç·šè©¦ç®—è¡¨ Â· è‡ªå‹•æ›´æ–°å­¸å“¡æª”æ¡ˆ</span>
        </div>
      </div>

      <div class="control-row">
        <label for="studentSelect">é¸æ“‡å­¸å“¡ï¼š</label>
        <select id="studentSelect" disabled onchange="loadStudentData()">
          <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
        </select>
        <button class="btn" id="reloadBtn" onclick="reloadSheets()">ğŸ”„ é‡æ–°å¾ Google Sheets è¼‰å…¥</button>
        <span id="statusMsg" class="status-note"></span>
      </div>
    </header>

    <!-- å ±å‘Šæœ¬é«”ï¼šé€™ä¸€å¡Šæœƒè¢«è¼¸å‡ºæˆ PDF -->
    <section id="reportSection" class="report-body">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <h2 class="section-title">
        <span class="dot"></span> é‹å‹•å“¡åŸºæœ¬è³‡æ–™
      </h2>
      <p class="section-sub">
        æœ¬å ±å‘Šæ ¹æ“šæœ€æ–°ä¸€æ¬¡ã€Œé«”èƒ½æª¢æ¸¬æˆç¸¾ã€èˆ‡åŒä¸€åˆ†ç´šçš„å­¸å“¡è³‡æ–™ï¼Œè‡ªå‹•è¨ˆç®—å¹³å‡ã€æ¨™æº–å·®èˆ‡ Z åˆ†æ•¸ï¼Œå”åŠ©æ•™ç·´å¿«é€ŸæŒæ¡å­¸å“¡ç›®å‰çš„ä½ç½®ã€‚
      </p>

      <div class="profile-row">
        <div class="profile-card">
          <h3>PLAYER PROFILE</h3>
          <div class="profile-grid">
            <div>
              <div class="profile-item-title">å§“å</div>
              <div class="profile-item-value" id="dispName">â€”</div>
            </div>
            <div>
              <div class="profile-item-title">åˆ†ç´š</div>
              <div class="profile-item-value" id="dispGroup">â€”</div>
            </div>
            <div>
              <div class="profile-item-title">æœ€è¿‘æª¢æ¸¬æ—¥</div>
              <div class="profile-item-value" id="dispDate">â€”</div>
            </div>
          </div>
        </div>

        <div class="profile-card">
          <h3>SESSION SUMMARY</h3>
          <p class="summary-note">
            æ•¸æ“šåªå’Œ<strong>åŒä¸€åˆ†ç´š</strong>çš„å­¸å“¡åšæ¯”è¼ƒã€‚Z åˆ†æ•¸ç´„ä»‹æ–¼ -0.5 ï½ +0.5 è¦–ç‚ºæ¥è¿‘çµ„å…§å¹³å‡ï¼›
            â‰¥ +1 ç‚ºæ˜é¡¯å„ªå‹¢ï¼›â‰¤ -0.5 å»ºè­°åˆ—ç‚ºå„ªå…ˆè£œå¼·é …ç›®ã€‚
          </p>
        </div>
      </div>

      <!-- é—œéµæŒ‡æ¨™ + æŸ±ç‹€åœ–ï¼ˆæœ€å¤š 10 é …ï¼‰ -->
      <div class="key-metrics-section">
        <h2 class="section-title">
          <span class="dot"></span> é—œéµæŒ‡æ¨™ï¼šèˆ‡åŒç´šå¹³å‡çš„å·®è·ï¼ˆæœ€å¤š 10 é …ï¼‰
        </h2>
        <p class="section-sub">
          å¾æ‰€æœ‰æ¸¬é©—ä¸­æŒ‘å‡ºã€ŒZ åˆ†æ•¸çµ•å°å€¼æœ€é«˜ã€çš„å‰ 10 é …ï¼ŒæŸ±ç‹€åœ–é¡¯ç¤ºå­¸å“¡èˆ‡åŒç´šå¹³å‡çš„å·®è·ï¼Œæ–¹ä¾¿æ•™ç·´ä¸€çœ¼é–å®šæœ€é—œéµçš„å„ªå‹¢èˆ‡å¼±é …ã€‚
        </p>
        <div class="chart-wrapper">
          <div class="chart-legend">
            <span class="legend-item">
              <span class="swatch swatch-player"></span> å­¸å“¡æœ¬æ¬¡æˆç¸¾
            </span>
            <span class="legend-item">
              <span class="swatch swatch-group"></span> åŒç´šå¹³å‡
            </span>
          </div>
          <div class="chart-box">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>

      <!-- æ•™ç·´çŸ­è©•ï¼ˆæ•´é«”ï¼‰ -->
      <div class="coach-section">
        <h2 class="section-title">
          <span class="dot"></span> æ•™ç·´å»ºè­°èˆ‡çŸ­è©•ï¼ˆæ•´é«”æŒ‡æ¨™ï¼‰
        </h2>
        <div class="coach-box" id="coachComment">
          è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒä¾åŒç´šå¹³å‡èˆ‡ Z åˆ†æ•¸è‡ªå‹•æ•´ç†å¼·é …èˆ‡å»ºè­°è£œå¼·æ–¹å‘ã€‚
        </div>
      </div>

      <!-- âœ… ä¸‹è‚¢çˆ†ç™¼åŠ›æ¨¡çµ„ï¼šç¶œåˆ Z + é›·é”åœ– + COACH NOTE -->
      <div class="lbp-section">
        <h2 class="section-title">
          <span class="dot"></span> ä¸‹è‚¢çˆ†ç™¼åŠ›ç¶œåˆæŒ‡æ¨™ï¼ˆåŠ æ¬Š Z-Scoreï¼‰
        </h2>
        <div class="lbp-card">
          <div>
            <div class="lbp-score-label">ç¶œåˆ Zï¼ˆLower Body Power, Weightedï¼‰</div>
            <div class="lbp-score-main" id="lbpCompositeZ">â€”</div>
            <div class="lbp-chip" id="lbpChipText">ä¸‹è‚¢çˆ†ç™¼åŠ›ä½ç½®èªªæ˜æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
          </div>
          <div class="lbp-list" id="lbpPartsText">
            IMTPï¼ˆRFD æ•¸æ“šï¼‰Z = â€”<br/>
            å‚ç›´è·³ï¼ˆVertical Jumpï¼‰Z = â€”<br/>
            ç«‹å®šè·³é ï¼ˆBroad Jumpï¼‰Z = â€”<br/>
            å´å‘è·³ï¼ˆLateral Jumpï¼‰Z = â€”
          </div>
        </div>
        <div class="lbp-note">
          é›·é”åœ–ä¸Šçš„æ•¸å€¼å·²è½‰æ›æˆ 0ï½100 åˆ†ï¼Œ<strong>50 ä»£è¡¨åŒç´šå¹³å‡</strong>ã€‚
          è‹¥æŸæŒ‡æ¨™æ¨£æœ¬æ•¸å¤ªå°‘æˆ– SD ç‚º 0ï¼ŒZ æœƒé¡¯ç¤ºç‚ºã€Œ--ã€ï¼Œé›·é”åœ–å‰‡æš«æ™‚ä»¥ 50 è¦–ç‚ºåŒç´šæ°´æº–ä»¥ä¿æŒåœ–å½¢å®Œæ•´ã€‚
        </div>

        <div class="radar-row">
          <div class="radar-box">
            <div class="radar-title">LOWER BODY POWER Â· FOUR VECTORS</div>
            <div class="radar-canvas-wrap">
              <canvas id="lbpRadar"></canvas>
            </div>
          </div>
          <div class="lbp-coach-card" id="lbpCoachNote">
            è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ï¼Œç³»çµ±æœƒä¾ IMTPã€å‚ç›´è·³ã€ç«‹å®šè·³é ã€å´å‘è·³å››å€‹å‘é‡çš„ Z åˆ†æ•¸ï¼Œ
            è‡ªå‹•æ•´ç†ä¸‹è‚¢çˆ†ç™¼åŠ›çš„<strong>å„ªå‹¢å‘é‡</strong>èˆ‡<strong>å„ªå…ˆè£œå¼·æ–¹å‘</strong>ã€‚
          </div>
        </div>
      </div>

      <!-- å®Œæ•´æª¢æ¸¬è¡¨ -->
      <div class="table-section">
        <h2 class="section-title">
          <span class="dot"></span> æœ¬æ¬¡æª¢æ¸¬æˆç¸¾èˆ‡åŒåˆ†ç´šå¹³å‡å°ç…§
        </h2>
        <p class="section-sub">
          ä¸‹è¡¨åˆ—å‡ºæ‰€æœ‰é«”èƒ½æŒ‡æ¨™åŸå§‹æˆç¸¾ï¼Œä¸¦èˆ‡åŒä¸€åˆ†ç´šå­¸å“¡çš„å¹³å‡åšæ¯”è¼ƒã€‚æ¨™è¨˜ç‚ºã€Œé—œéµæŒ‡æ¨™ã€è€…ï¼Œä»£è¡¨åœ¨æœ¬æ¬¡æª¢æ¸¬ä¸­é›¢åŒç´šå¹³å‡çš„å·®è·æœ€å¤§ï¼ˆå‰ååï¼‰ã€‚
        </p>
        <table>
          <thead>
            <tr>
              <th>æŒ‡æ¨™</th>
              <th>å­¸ç”Ÿ</th>
              <th>åŒç´šå¹³å‡</th>
              <th>SD</th>
              <th>Z åˆ†æ•¸</th>
              <th>è©•ä¼°</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="footer-row">
        <span class="small-note">â€» æœ¬å ±å‘Šåƒ…ä¾›æ•™ç·´èˆ‡å­¸å“¡æºé€šè¨“ç·´æ–¹å‘ä¹‹ç”¨ï¼Œéæ­£å¼é†«å­¸æª¢æ¸¬ã€‚</span>
        <button class="btn-pdf" id="pdfBtn" onclick="exportPDF()">ğŸ“„ ä¸‹è¼‰ PDF å ±å‘Š</button>
      </div>
    </section>
  </div>
</div>

<script>
  // ============ è©¦ç®—è¡¨è¨­å®š ============
  const FILE_ID = "1N-8HQZaxHYj4vE824raG1fWyNxt5w7B9_m8oHn8f4As";
  const SHEETS = {
    players: "å­¸å“¡ä¸»è³‡æ–™è¡¨",
    tests:   "æª¢æ¸¬æˆç¸¾"
  };

  // ä¸æ‹¿ä¾†ç®—å¹³å‡ / SD çš„æ¬„ä½
  const IDENTITY_KEYS = new Set([
    "å§“å","æ€§åˆ¥","å¹´é½¡","å¹´ç´š","åˆ†ç´š","ç”Ÿæ—¥","æ—¥æœŸ","æ¸¬é©—æ—¥æœŸ",
    "å‚·ç—…ï¼é™åˆ¶","å‚·å‹¢ï¼é™åˆ¶","å‚·å‹¢/é™åˆ¶","ç›®æ¨™",
    "ä¸€é€±å¯ä¸Šèª²æ™‚æ®µ","è¯çµ¡æ–¹å¼","å‚™è¨»"
  ]);

  // é€™äº›é—œéµå­—è¦–ç‚ºã€Œæ•¸å€¼è¶Šå°è¶Šå¥½ã€ï¼ˆç§’æ•¸ã€åæ‡‰æ™‚é–“ï¼‰
  const LOWER_BETTER_KEYS = ["10","20","505","åæ‡‰","æ•æ·","è¡åˆº","s","S","ç§’"];

  function isLowerBetter(metricName) {
    return LOWER_BETTER_KEYS.some(k => metricName.includes(k));
  }

  function parseNumber(v) {
    if (v == null || v === "") return null;
    const n = Number(String(v).replace(/[^\d.\-]/g,""));
    return isNaN(n) ? null : n;
  }

  // âœ… ä¸‹è‚¢çˆ†ç™¼åŠ›å››å€‹æ§‹é¢ + æ¬Šé‡ + é—œéµå­—
  const LBP_CONFIG = [
    {
      id: "IMTP",
      label: "IMTPï¼ˆRFD æ•¸æ“šï¼‰",
      weight: 0.35,
      keywords: ["IMTP","RFD","ç­‰é•·","æ‹‰åŠ›"]
    },
    {
      id: "VJ",
      label: "å‚ç›´è·³ï¼ˆVertical Jumpï¼‰",
      weight: 0.25,
      keywords: ["å‚ç›´è·³","Vertical Jump","å‚ç›´"]
    },
    {
      id: "BJ",
      label: "ç«‹å®šè·³é ï¼ˆBroad Jumpï¼‰",
      weight: 0.25,
      keywords: ["ç«‹å®šè·³é ","Broad Jump","ç«‹å®š"]
    },
    {
      id: "LJ",
      label: "å´å‘è·³ï¼ˆLateral Jumpï¼‰",
      weight: 0.15,
      keywords: ["å´å‘è·³","Lateral Jump","å´å‘"]
    }
  ];

  let playersByName    = new Map();
  let testsArray       = [];
  let testsByName      = new Map();
  let groupMetricStats = new Map(); // åˆ†ç´š â†’ {æ¬„ä½å: {mean, sd}}
  let barChart         = null;
  let lbpRadarChart    = null;

  function csvUrlForSheet(sheetName) {
    return `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function loadSheet(sheetName) {
    const url = csvUrlForSheet(sheetName);
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: results => resolve(results.data),
        error: err => reject(err)
      });
    });
  }

  // ä¾ã€Œåˆ†ç´š Ã— æ¬„ä½ã€è¨ˆç®—å¹³å‡èˆ‡ SDï¼ˆçµ¦æ•´é«”æŒ‡æ¨™ç”¨ï¼‰
  function buildGroupMetricStats() {
    const groupMetricValues = new Map(); // group â†’ Map(metricName â†’ {values:[]})

    testsArray.forEach(row => {
      const name = (row["å§“å"] || "").trim();
      if (!name) return;

      const playerRow = playersByName.get(name) || {};
      const group = (playerRow["åˆ†ç´š"] || row["åˆ†ç´š"] || "").trim() || "-";

      let metricMap = groupMetricValues.get(group);
      if (!metricMap) {
        metricMap = new Map();
        groupMetricValues.set(group, metricMap);
      }

      Object.keys(row).forEach(key => {
        if (!key || IDENTITY_KEYS.has(key)) return;
        const val = parseNumber(row[key]);
        if (val == null) return;

        let metric = metricMap.get(key);
        if (!metric) {
          metric = { values: [] };
          metricMap.set(key, metric);
        }
        metric.values.push(val);
      });
    });

    groupMetricStats = new Map();

    groupMetricValues.forEach((metricMap, group) => {
      const statMap = {};
      metricMap.forEach((m, metricName) => {
        const vals = m.values;
        if (!vals.length) return;
        const mean = vals.reduce((a,b)=>a+b,0) / vals.length;
        const variance = vals.reduce((a,b)=>a+Math.pow(b-mean,2),0) / vals.length;
        const sd = Math.sqrt(variance);
        statMap[metricName] = { mean, sd };
      });
      groupMetricStats.set(group, statMap);
    });
  }

  // ğŸ” æ‰¾å‡ºæŸæ§‹é¢å°æ‡‰çš„æ¬„ä½åç¨±
  function findMetricKeyForConfig(row, config) {
    const keys = Object.keys(row);
    for (const key of keys) {
      if (!key || IDENTITY_KEYS.has(key)) continue;
      if (config.keywords.some(kw => key.includes(kw))) {
        return key;
      }
    }
    return null;
  }

  // ä¾åˆ†ç´š + æ¬„ä½åç¨±é‡æ–°ç®— mean / sd / æ¨£æœ¬æ•¸ï¼ˆçµ¦ä¸‹è‚¢æ¨¡çµ„ç”¨ï¼‰
  function getGroupStatsForMetric(group, metricKey) {
    const values = [];

    testsArray.forEach(row => {
      const name = (row["å§“å"] || "").trim();
      if (!name) return;

      const pRow = playersByName.get(name) || {};
      const g = (pRow["åˆ†ç´š"] || row["åˆ†ç´š"] || "").trim() || "-";
      if (g !== group) return;

      const v = parseNumber(row[metricKey]);
      if (v != null) values.push(v);
    });

    if (!values.length) {
      return { mean: null, sd: null, n: 0 };
    }

    const mean = values.reduce((a,b)=>a+b,0) / values.length;
    const variance = values.reduce((a,b)=>a + Math.pow(b-mean,2),0) / values.length;
    const sd = Math.sqrt(variance);

    return { mean, sd, n: values.length };
  }

  async function reloadSheets() {
    const status = document.getElementById("statusMsg");
    const select = document.getElementById("studentSelect");
    const report = document.getElementById("reportSection");

    status.textContent = "å¾ Google è©¦ç®—è¡¨è¼‰å…¥ä¸­â€¦";
    select.disabled = true;
    select.innerHTML = '<option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>';
    report.style.display = "none";

    try {
      const [players, tests] = await Promise.all([
        loadSheet(SHEETS.players),
        loadSheet(SHEETS.tests)
      ]);

      // å­¸å“¡ä¸»è³‡æ–™
      playersByName = new Map();
      players.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        playersByName.set(n, row);
      });

      // æª¢æ¸¬æˆç¸¾
      testsArray = tests;
      testsByName = new Map();
      testsArray.forEach(row => {
        const n = (row["å§“å"] || "").trim();
        if (!n) return;
        testsByName.set(n, row);
      });

      // ç®—å¥½ å„åˆ†ç´š Ã— æŒ‡æ¨™ çš„å¹³å‡èˆ‡ SDï¼ˆæ•´é«”ç”¨ï¼‰
      buildGroupMetricStats();

      // ä¸‹æ‹‰é¸å–®
      const names = Array.from(testsByName.keys()).sort((a,b) =>
        a.localeCompare(b, "zh-Hant")
      );
      select.innerHTML = '<option value="">â€” è«‹é¸æ“‡å­¸å“¡ â€”</option>';
      names.forEach(n => {
        const op = document.createElement("option");
        op.value = n;
        op.textContent = n;
        select.appendChild(op);
      });
      select.disabled = false;

      status.textContent = "è¼‰å…¥å®Œæˆï¼Œè«‹å¾ä¸Šæ–¹é¸æ“‡å­¸å“¡ã€‚";
    } catch (err) {
      console.error(err);
      status.textContent =
        "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªè©¦ç®—è¡¨å·²å…¬é–‹ï¼Œä¸”åˆ†é åç¨±ç‚ºã€Œå­¸å“¡ä¸»è³‡æ–™è¡¨ / æª¢æ¸¬æˆç¸¾ã€ã€‚";
    }
  }

  reloadSheets();

  function loadStudentData() {
    const name   = document.getElementById("studentSelect").value;
    const report = document.getElementById("reportSection");
    const status = document.getElementById("statusMsg");

    if (!name) {
      report.style.display = "none";
      return;
    }

    const testRow   = testsByName.get(name);
    const playerRow = playersByName.get(name) || {};
    if (!testRow) {
      status.textContent = `ã€Œ${name}ã€æ‰¾ä¸åˆ°æª¢æ¸¬æˆç¸¾ã€‚`;
      report.style.display = "none";
      return;
    }

    const group = (playerRow["åˆ†ç´š"] || testRow["åˆ†ç´š"] || "").trim() || "-";
    const groupStats = groupMetricStats.get(group) || {};

    // åŸºæœ¬è³‡æ–™
    document.getElementById("dispName").textContent  = name;
    document.getElementById("dispGroup").textContent = group || "-";
    const date =
      playerRow["æœ€æ–°æª¢æ¸¬æ—¥"] ||
      testRow["æ—¥æœŸ"] ||
      testRow["æ¸¬é©—æ—¥æœŸ"] ||
      "";
    document.getElementById("dispDate").textContent = date || "-";

    // ========= æ•´é«”æŒ‡æ¨™ï¼šæ•´ç†æ¯å€‹æ¸¬é©—æŒ‡æ¨™ =========
    const metricRows = [];
    Object.keys(testRow).forEach(key => {
      if (!key || IDENTITY_KEYS.has(key)) return;
      const latest = parseNumber(testRow[key]);
      if (latest == null) return;

      const stat = groupStats[key] || {};
      const mean = stat.mean ?? null;
      const sd   = stat.sd   ?? null;

      let z = null;
      if (mean != null && sd != null && sd !== 0) {
        const lowerBetter = isLowerBetter(key);
        z = lowerBetter ? (mean - latest) / sd : (latest - mean) / sd;
      }

      metricRows.push({
        label: key,
        latest,
        mean,
        sd,
        z
      });
    });

    if (!metricRows.length) {
      status.textContent =
        `ã€Œ${name}ã€ç›®å‰æ²’æœ‰å¯ç”¨çš„æ•¸å€¼æ¬„ä½ï¼Œè«‹æª¢æŸ¥ã€Œæª¢æ¸¬æˆç¸¾ã€åˆ†é ã€‚`;
      report.style.display = "none";
      return;
    }

    // ========= é—œéµæŒ‡æ¨™ï¼šå– |Z| æœ€å¤§çš„å‰ 10 é … =========
    const withZ = metricRows.filter(r => r.z != null);
    withZ.sort((a,b) => Math.abs(b.z) - Math.abs(a.z));
    const keyMetrics = withZ.slice(0,10);

    // ========= æŸ±ç‹€åœ–ï¼šå­¸ç”Ÿ vs åŒç´šå¹³å‡ =========
    const barCtx = document.getElementById("barChart").getContext("2d");
    if (barChart) barChart.destroy();

    if (keyMetrics.length) {
      barChart = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: keyMetrics.map(r => r.label),
          datasets: [
            {
              label: "å­¸ç”Ÿ",
              data: keyMetrics.map(r => r.latest),
              backgroundColor: "rgba(34,197,94,0.85)"
            },
            {
              label: "åŒç´šå¹³å‡",
              data: keyMetrics.map(r => r.mean ?? null),
              backgroundColor: "rgba(56,189,248,0.85)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              ticks: {
                font: { size: 10 },
                color: "#e5e7eb"
              },
              grid: { display: false }
            },
            y: {
              ticks: {
                font: { size: 10 },
                color: "#9ca3af"
              },
              grid: { color: "#1f2937" }
            }
          }
        }
      });
    } else {
      // æ²’æœ‰ Z çš„è©±å°±æ¸…ç©ºç•«å¸ƒ
      barCtx.clearRect(0,0,barCtx.canvas.width,barCtx.canvas.height);
    }

    // ========= å®Œæ•´è¡¨æ ¼ =========
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    // çµ¦è¡¨æ ¼æ¨™è¨˜å“ªäº›æ˜¯ã€Œé—œéµæŒ‡æ¨™ã€
    const keySet = new Set(keyMetrics.map(r => r.label));

    metricRows
      .slice()
      .sort((a,b) => {
        if (a.z == null && b.z == null) return a.label.localeCompare(b.label,"zh-Hant");
        if (a.z == null) return 1;
        if (b.z == null) return -1;
        return Math.abs(b.z) - Math.abs(a.z); // å…ˆçœ‹é—œéµ
      })
      .forEach(row => {
        const tr = document.createElement("tr");

        let evalTag = "â€”";
        if (row.z != null) {
          if (row.z >= 1) evalTag = '<span class="tag good">å„ªæ–¼åŒç´š</span>';
          else if (row.z <= -0.5)
            evalTag = '<span class="tag bad">å»ºè­°è£œå¼·</span>';
          else evalTag = '<span class="tag mid">æ¥è¿‘åŒç´š</span>';

          if (keySet.has(row.label)) {
            evalTag += ' <span class="tag key">é—œéµæŒ‡æ¨™</span>';
          }
        }

        tr.innerHTML = `
          <td>${row.label}</td>
          <td>${row.latest ?? "â€”"}</td>
          <td>${row.mean != null ? row.mean.toFixed(2) : "â€”"}</td>
          <td>${row.sd   != null ? row.sd.toFixed(2)   : "â€”"}</td>
          <td>${row.z    != null ? row.z.toFixed(2)    : "â€”"}</td>
          <td>${evalTag}</td>
        `;
        tbody.appendChild(tr);
      });

    // ========= æ•™ç·´çŸ­è©•ï¼ˆæ•´é«”æŒ‡æ¨™ï¼‰ =========
    const strengths = withZ
      .filter(r => r.z >= 1)
      .sort((a,b) => b.z - a.z)
      .slice(0,3);

    const weaknesses = withZ
      .filter(r => r.z <= -0.5)
      .sort((a,b) => a.z - b.z)
      .slice(0,3);

    const listText = arr =>
      !arr.length
        ? "ç›®å‰å„æŒ‡æ¨™å¤§è‡´æ¥è¿‘åŒç´šå¹³å‡ï¼Œæ²’æœ‰ç‰¹åˆ¥çªå‡ºçš„å¼·é …æˆ–å¼±é …ã€‚"
        : arr.map(r => `${r.label}ï¼ˆZ = ${r.z.toFixed(2)}ï¼‰`).join("ã€");

    let commentHtml = "";
    if (withZ.length) {
      commentHtml = `
        æ ¹æ“šæœ¬æ¬¡æª¢æ¸¬æ•¸æ“šï¼Œ<strong>${name}</strong> èˆ‡ã€Œ${group || "ç›®å‰åˆ†ç´š"}ã€åŒç´šå­¸å“¡ç›¸æ¯”ï¼š
        <br><br>
        ãƒ»ä¸»è¦<strong>å„ªå‹¢æŒ‡æ¨™</strong>ï¼š${listText(strengths)}ã€‚<br>
        ãƒ»å»ºè­°å„ªå…ˆ<strong>è£œå¼·æŒ‡æ¨™</strong>ï¼š${listText(weaknesses)}ã€‚<br><br>
        è¨“ç·´å®‰æ’ä¸Šï¼Œå¯ä»¥æŠŠè£œå¼·æŒ‡æ¨™æ’é€²æ¯é€±å›ºå®šèª²è¡¨ï¼ˆä¾‹å¦‚ç†±èº«å¾Œçš„å°ˆé …é«”èƒ½æ®µè½ï¼‰ï¼Œ
        åŒæ™‚ç¶­æŒå„ªå‹¢æŒ‡æ¨™çš„ç©©å®šåº¦ï¼Œè®“é¸æ‰‹åœ¨æ¯”è³½ä¸­æ›´å®¹æ˜“æŠŠå„ªå‹¢èƒ½åŠ›æ‰“å‡ºä¾†ã€‚
      `;
    } else {
      commentHtml = `
        åŒç´šæ¨£æœ¬æ•¸è¼ƒå°‘ï¼Œæš«æ™‚ç„¡æ³•è¨ˆç®— Z åˆ†æ•¸ã€‚<br><br>
        å°±æœ¬æ¬¡æª¢æ¸¬åŸå§‹æˆç¸¾ä¾†çœ‹ï¼Œ<strong>${name}</strong> åœ¨å¤šæ•¸é …ç›®ä¸Šçš„è¡¨ç¾ç©©å®šï¼Œ
        å»ºè­°æ•™ç·´å…ˆé¸ 2ï½3 å€‹å¸Œæœ›æ˜é¡¯æ‹‰é–‹å·®è·çš„æ¸¬é©—é …ç›®ï¼Œ
        ä½œç‚ºä¸‹ä¸€éšæ®µè¨“ç·´ä¸»è»¸ï¼Œä¸¦æŒçºŒè¿½è¹¤å¾ŒçºŒæª¢æ¸¬çµæœçš„è®ŠåŒ–ã€‚
      `;
    }
    document.getElementById("coachComment").innerHTML = commentHtml;

    // ========= ä¸‹è‚¢çˆ†ç™¼åŠ›æ¨¡çµ„ =========
    const lbpDetails = {}; // id â†’ {label, zRaw, zScaled, mean, sd, n, value}
    LBP_CONFIG.forEach(cfg => {
      const metricKey = findMetricKeyForConfig(testRow, cfg);
      if (!metricKey) {
        lbpDetails[cfg.id] = {
          label: cfg.label,
          zRaw: null,
          zScaled: 50,
          mean: null,
          sd: null,
          n: 0,
          value: null
        };
        return;
      }

      const value = parseNumber(testRow[metricKey]);
      if (value == null) {
        lbpDetails[cfg.id] = {
          label: cfg.label,
          zRaw: null,
          zScaled: 50,
          mean: null,
          sd: null,
          n: 0,
          value: null
        };
        return;
      }

      const stats = getGroupStatsForMetric(group, metricKey);
      let z = null;
      if (stats.mean != null && stats.sd != null && stats.sd !== 0 && stats.n >= 2) {
        const lowerBetter = isLowerBetter(metricKey);
        z = lowerBetter
          ? (stats.mean - value) / stats.sd
          : (value - stats.mean) / stats.sd;
      }

      // é›·é”åœ–ç”¨ï¼šæŠŠ Z è½‰æˆ 0ï½100 åˆ†ï¼Œ50 = åŒç´šå¹³å‡
      let zScaled = 50;
      if (z != null) {
        zScaled = 50 + z * 10;
        if (zScaled < 0) zScaled = 0;
        if (zScaled > 100) zScaled = 100;
      }

      lbpDetails[cfg.id] = {
        label: cfg.label,
        zRaw: z,
        zScaled,
        mean: stats.mean,
        sd: stats.sd,
        n: stats.n,
        value
      };
    });

    // ç¶œåˆ Zï¼ˆåŠ æ¬Šï¼‰ï¼šåªç”¨æœ‰ Z çš„æ§‹é¢ï¼Œæ¬Šé‡é‡æ–°æ­£è¦åŒ–
    let weightedZ = null;
    let wSum = 0;
    LBP_CONFIG.forEach(cfg => {
      const info = lbpDetails[cfg.id];
      if (info.zRaw != null) {
        weightedZ = (weightedZ ?? 0) + info.zRaw * cfg.weight;
        wSum += cfg.weight;
      }
    });
    if (weightedZ != null && wSum > 0) {
      weightedZ = weightedZ / wSum;
    }

    const compositeEl = document.getElementById("lbpCompositeZ");
    const chipEl      = document.getElementById("lbpChipText");
    const partsEl     = document.getElementById("lbpPartsText");
    const lbpCoachEl  = document.getElementById("lbpCoachNote");

    if (weightedZ == null) {
      compositeEl.textContent = "--";
      chipEl.textContent = "ç›®å‰æ¨£æœ¬æ•¸ä¸è¶³ï¼Œæš«æ™‚ç„¡æ³•è¨ˆç®—ç¶œåˆ Zã€‚";
    } else {
      compositeEl.textContent = weightedZ.toFixed(2);
      let chipText = "";
      if (weightedZ >= 1) {
        chipText = "ä¸‹è‚¢çˆ†ç™¼åŠ›æ˜é¡¯å„ªæ–¼åŒç´šï¼ˆå¯ä»¥é–‹å§‹è¨­è¨ˆæ›´é€²éšçš„çˆ†ç™¼è¨“ç·´ï¼‰";
      } else if (weightedZ <= -0.5) {
        chipText = "ä¸‹è‚¢çˆ†ç™¼åŠ›ç•¥ä½æ–¼åŒç´šå¹³å‡ï¼ˆå»ºè­°åˆ—ç‚ºå„ªå…ˆè£œå¼·ç›®æ¨™ï¼‰";
      } else {
        chipText = "ä¸‹è‚¢çˆ†ç™¼åŠ›æ¥è¿‘åŒç´šå¹³å‡ï¼ˆå¯æ­é…æŠ€æˆ°è¡“è¨“ç·´åŒæ­¥æå‡ï¼‰";
      }
      chipEl.textContent = chipText;
    }

    // å„æ§‹é¢æ–‡å­—èªªæ˜
    const lines = LBP_CONFIG.map(cfg => {
      const info = lbpDetails[cfg.id];
      const zText = info.zRaw != null
        ? info.zRaw.toFixed(2)
        : "--ï¼ˆæ¨£æœ¬ä¸è¶³ï¼Œæš«ä»¥åŒç´šæ°´æº–è™•ç†ï¼‰";
      return `${info.label}ã€€Z = <em>${zText}</em>`;
    });
    partsEl.innerHTML = lines.join("<br/>");

    // ä¸‹è‚¢å°ˆå±¬ COACH NOTE
    const strengthsLBP = LBP_CONFIG
      .map(cfg => ({ cfg, z: lbpDetails[cfg.id].zRaw }))
      .filter(x => x.z != null && x.z >= 0.8)
      .sort((a,b) => b.z - a.z)
      .slice(0,2);

    const weaknessesLBP = LBP_CONFIG
      .map(cfg => ({ cfg, z: lbpDetails[cfg.id].zRaw }))
      .filter(x => x.z != null && x.z <= -0.5)
      .sort((a,b) => a.z - b.z)
      .slice(0,2);

    const listTextLBP = arr =>
      !arr.length
        ? "ç›®å‰å„å‘é‡å¤§è‡´æ¥è¿‘åŒç´šå¹³å‡ï¼Œæ²’æœ‰ç‰¹åˆ¥çªå‡ºæˆ–æ˜é¡¯è½å¾Œçš„é¢å‘ã€‚"
        : arr.map(x => `${x.cfg.label}ï¼ˆZ = ${x.z.toFixed(2)}ï¼‰`).join("ã€");

    if (weightedZ == null) {
      lbpCoachEl.innerHTML = `
        ç›®å‰åŒç´šæ¨£æœ¬æ•¸è¼ƒå°‘ï¼Œç„¡æ³•ç©©å®šè¨ˆç®— Z åˆ†æ•¸ã€‚<br/><br/>
        å°±åŸå§‹æˆç¸¾ä¾†çœ‹ï¼Œ<strong>${name}</strong> åœ¨å¤šæ•¸è·³èºèƒ½åŠ›ä¸Šçš„è¡¨ç¾ç©©å®šï¼Œ
        å»ºè­°å…ˆé¸æ“‡ 1ï½2 å€‹ä½ æœ€åœ¨æ„çš„é …ç›®ä½œç‚ºè¨“ç·´ä¸»è»¸ï¼Œä¸¦æŒçºŒè¿½è¹¤å¾ŒçºŒæª¢æ¸¬è®ŠåŒ–ã€‚
      `;
    } else {
      lbpCoachEl.innerHTML = `
        ç¶œåˆ Z ä¾†çœ‹ï¼Œ<strong>${name}</strong> çš„ä¸‹è‚¢çˆ†ç™¼åŠ›å¤§ç´„ä½åœ¨åŒç´šçš„ç›®å‰ä½ç½®ï¼š
        <strong>${weightedZ.toFixed(2)}</strong>ã€‚<br/><br/>
        ãƒ»ä¸»è¦<strong>å„ªå‹¢å‘é‡</strong>ï¼š${listTextLBP(strengthsLBP)}ã€‚<br/>
        ãƒ»å»ºè­°<strong>å„ªå…ˆè£œå¼·å‘é‡</strong>ï¼š${listTextLBP(weaknessesLBP)}ã€‚<br/><br/>
        å¯¦å‹™ä¸Šå¯ä»¥æŠŠã€Œè£œå¼·å‘é‡ã€æ’é€²æ¯é€±å›ºå®šè¨“ç·´ï¼ˆä¾‹å¦‚é€±äºŒã€é€±å››çš„é«”èƒ½èª²ï¼‰ï¼Œ
        å…¶é¤˜æ™‚é–“ç¶­æŒå„ªå‹¢å‘é‡çš„ç©©å®šåº¦ï¼Œé¿å…å› è¨“ç·´å…§å®¹åç§»è€Œæµå¤±åŸæœ¬çš„çˆ†ç™¼èƒ½åŠ›ã€‚
      `;
    }

    // é›·é”åœ–ï¼šå››è»¸å›ºå®šï¼Œæ•¸å€¼ 0â€“100ï¼Œ50 = åŒç´šå¹³å‡
    const radarLabels = LBP_CONFIG.map(cfg => cfg.label);
    const radarPlayer = LBP_CONFIG.map(cfg => lbpDetails[cfg.id].zScaled);
    const radarAvg    = LBP_CONFIG.map(() => 50);

    const ctxRadar = document.getElementById("lbpRadar").getContext("2d");
    if (lbpRadarChart) lbpRadarChart.destroy();

    lbpRadarChart = new Chart(ctxRadar, {
      type: "radar",
      data: {
        labels: radarLabels,
        datasets: [
          {
            label: "å­¸å“¡æŒ‡æ¨™åˆ†æ•¸ï¼ˆ50 = åŒç´šå¹³å‡ï¼‰",
            data: radarPlayer,
            backgroundColor: "rgba(34,197,94,0.25)",
            borderColor: "rgba(34,197,94,1)",
            pointBackgroundColor: "rgba(56,189,248,1)",
            borderWidth: 2,
            pointRadius: 3
          },
          {
            label: "åŒç´šå¹³å‡ï¼ˆå›ºå®š 50ï¼‰",
            data: radarAvg,
            backgroundColor: "rgba(148,163,184,0.05)",
            borderColor: "rgba(148,163,184,0.7)",
            pointBackgroundColor: "rgba(148,163,184,0.7)",
            borderWidth: 1,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            suggestedMin: 20,
            suggestedMax: 80,
            ticks: {
              stepSize: 10,
              color: "#9ca3af",
              showLabelBackdrop: false
            },
            grid: { color: "#1f2937" },
            angleLines: { color: "#1f2937" },
            pointLabels: { font: { size: 10 }, color: "#e5e7eb" }
          }
        },
        plugins: {
          legend: {
            labels: { font: { size: 10 }, color: "#e5e7eb" }
          }
        }
      }
    });

    status.textContent = "";
    report.style.display = "block";
  }

  // ============ ç”¢ç”Ÿ PDFï¼šå°ˆé–€æŠ“ A4 ç›´å¼å ±å‘Š ============
  async function exportPDF() {
    const report = document.getElementById("reportSection");
    if (report.style.display === "none" || !report.innerText.trim()) {
      alert("è«‹å…ˆé¸æ“‡ä¸€ä½å­¸å“¡ä¸¦ç”¢ç”Ÿå ±å‘Šï¼Œå†ä¸‹è¼‰ PDFã€‚");
      return;
    }

    const btn  = document.getElementById("pdfBtn");
    const name = document.getElementById("dispName").textContent || "report";
    btn.disabled = true;
    btn.textContent = "ç”¢ç”Ÿ PDF ä¸­â€¦";

    try {
      const pdfArea = document.getElementById("pdfArea");

      const canvas = await html2canvas(pdfArea, {
        scale: 3,               // è§£æåº¦å†æ‹‰é«˜ä¸€äº›
        backgroundColor: "#020617",
        useCORS: true
      });

      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      // A4 ç›´å¼
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth  = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth  = pageWidth;
      const imgHeight = canvas.height * imgWidth / canvas.width;

      let position   = 0;
      let heightLeft = imgHeight;

      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
        heightLeft -= pageHeight;
      }

      pdf.save(`AthleteReport-${name}.pdf`);
    } catch (err) {
      console.error(err);
      alert("ç”¢ç”Ÿ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    } finally {
      btn.disabled = false;
      btn.textContent = "ğŸ“„ ä¸‹è¼‰ PDF å ±å‘Š";
    }
  }
</script>
</body>
</html>
